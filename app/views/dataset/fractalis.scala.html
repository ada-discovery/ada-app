@import models.Field
@import reactivemongo.play.json.BSONFormats._
@import views.html.layout.main
@import views.html.dataset.datasetSubNavWithJs
@import play.api.i18n.Messages
@import models.DataSpaceMetaInfo
@import play.api.Play.current
@import controllers.DataSetWebContext
@import controllers.DataSetWebContext._

@(
    domainName: String,
    field: Option[Field],
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@actions = {
    <div class="row">
        <div class="col-md-3">
            <input id="fieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@field.map(_.labelOrElseName)">
            <input id="fieldName" name="fieldName" type="hidden" value="@field.map(_.name)">
        </div>
    </div>
}

@bottomResources = {
    @typeaheadJsImport()

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.getField
    )

    <script type="text/javascript" src="@routes.Assets.versioned("javascripts/fractal.min.js")"></script>

    <script type="text/javascript">
        $(function () {
            populateFieldTypeahedFromUrl(
                $('#fieldTypeahead'),
                $('#fieldName'),
                '@Html(dataSetRouter.allFields.url)',
                @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
            )

            function addFieldToFractalis() {
                var fieldName = $("#fieldName").val();
                var fieldLabel = $("#fieldTypeahead").val();

                dataSetJsRoutes.controllers.dataset.DataSetDispatcher.getField(fieldName).ajax( {
                    success: function(field) {
                        fjs.loadData([
                            {
                                dictionary: {
                                    name: fieldName,
                                    projection: fieldName,
                                    label: fieldLabel,
                                    fieldType: field.fieldType,
                                    numValues: field.numValues,
                                    isArray: field.isArray
                                },
                                data_set: '@context.dataSetId'
                            }
                        ])
                    },
                    error: function(data){
                        showError( data.responseText );
                    }
                });
            }

            $('#fieldTypeahead').on('typeahead:selected', function(e, data) {
                addFieldToFractalis();
            });

            $('#fieldTypeahead').keypress(function (e) {
                if (e.which == 13) {
                    addFieldToFractalis();
                }
            });

            const fjs = fractal.init({
                handler: 'ada',
                thisBaseURL: "https://" + location.host,
                fractalisBaseURL: 'https://fractalis.lcsb.uni.lu',
                getAuth () {
                    return {token: getCookie("PLAY2AUTH_SESS_ID")}
//                    return {"user": "", passwd: ""}
                }
            })

            fjs.clearCache();

            fjs.setChart({chart: 'correlation-analysis', selector: '#fractalis-div'})
        });
    </script>
}

@main(Messages("fractalis.title", domainName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNavWithJs()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("fractalis.title", domainName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>
    <hr/>
    <div style="width: 100%; height: 1200px">
        <div id="fractalis-div"></div>
    </div>
}
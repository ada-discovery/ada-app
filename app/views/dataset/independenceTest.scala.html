@import reactivemongo.play.json.BSONFormats._
@import views.html.layout.main
@import views.html.dataset.{inputFieldAndFilterResources, datasetMenu, datasetSubNavWithJs}
@import views.html.table.{dynamicStringTable, dynamicTableJsImport}
@import views.html.dataset.dynamicFieldTable
@import play.api.i18n.Messages
@import models.DataSpaceMetaInfo
@import views.html.elements._
@import controllers.DataSetWebContext
@import controllers.DataSetWebContext._

@(
    dataSetName: String,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@bottomResources = {
    @inputFieldAndFilterResources(
        Seq("filter"),
        filterShowFieldStyle
    )

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.testIndependence
    )

    <script type="text/javascript">
        $(function () {
            populateFieldTypeahedFromUrl(
                $('#targetFieldTypeahead'),
                $('#targetFieldName'),
                '@Html(dataSetRouter.fields(Seq(FieldTypeId.Enum, FieldTypeId.String, FieldTypeId.Boolean)).url)',
                @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
            )

            $('#outputFieldTypeahead, #filterNameTypeahead').keypress(function (e) {
                if (e.which == 13) {
                    testIndependence();
                }
            });

            $('#launchButton').on('click', function() {
                testIndependence();
            })

            function testIndependence() {
                var targetFieldName = $("#targetFieldName").val();
                var targetFieldLabel = $("#targetFieldTypeahead").val();

                $('#inputFieldNameDiv').dynamicTable('updateModelFromTable');
                var inputFieldNames = $("#inputFieldNameDiv").dynamicTable('getModel')

                var filterId = ($('#filterNameTypeahead').val()) ? $("#filterId").val() : null

                $('#outputDiv').html("");

                dataSetJsRoutes.controllers.dataset.DataSetDispatcher.testIndependence(targetFieldName, inputFieldNames, filterId).ajax( {
                    success: function(results) {
                        showMessage("Independence test finished.")
                        showTestResults(results)
                    },
                    error: function(data){
                        showError( data.responseText );
                    }
                });

                showMessage("Independence test for the field '" + targetFieldLabel + "' launched.")
                addSpinner($("#outputDiv"))
            }

            function showTestResults(results) {
                $("#outputDiv").html("");

                var header = ["Field", "p-Value", "Degree of Freedom", "Statistics/F-Value", "Test Type"]
                var rowData = results.map(function(item) {
                    var color =
                        (item.result.pValue >= 0.05) ? "black":
                        (item.result.pValue >= 0.01) ? "forestGreen":
                        (item.result.pValue >= 0.001) ? "green" : "darkGreen"

                    var significantStyleDivStart = (item.result.pValue < 0.05) ? ("<div style='color: " + color + "; font-weight: bold'>") : "<div>"
                    var isAnovaTest = (item.result.fValue != null)
                    var rowStart = [item.fieldLabel,  significantStyleDivStart + item.result.pValue.toExponential(3).replace("e", " E") + "</div>"]

                    var rowEnd = (isAnovaTest) ?
                        [item.result.degreeOfFreedomWithinGroups, item.result.fValue.toFixed(2), "ANOVA"]
                        :
                        [item.result.degreeOfFreedom, item.result.statistics.toFixed(2), "Chi-Square"]

                    return rowStart.concat(rowEnd)
                });

                var table = createTable(header, rowData);
                $("#outputDiv").html(table);
                $('#outputDiv').fadeIn('2000');
            }

        });
    </script>
}

@extraFieldButtons = {
    <a id="addAllFieldsButton" class="btn btn-info btn-sm" href="#" onclick="addAllFields();" data-toggle="tooltip" title="Add All Fields">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> All
    </a>
}

@main(Messages("independenceTest.title", dataSetName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNavWithJs()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("independenceTest.title", dataSetName)
        </h3>
    </div>

    @dynamicTableJsImport()

    <div class="row">
        <div class="col-md-12">
            <form>
                <fieldset>
                    @labelValue("targetField", "Target Field") {
                        <input id="targetFieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="">
                        <input id="targetFieldName" name="targetFieldName" type="hidden" value="">
                    }
                    @labelValue("inputFieldNames", "Input Field") {
                        @dynamicFieldTable(
                            "inputFieldName",
                            Nil,
                            false,
                            5,
                            Some(extraFieldButtons),
                            Some(Right(dataSetRouter.getCategoriesWithFieldsAsTreeNodes(Left(Nil))))
                        )
                    }
                    @labelValue("filterId", "Filter") {
                        <input id="filterNameTypeahead" class="typeahead typeahead-large" type="text" placeholder="Filter" value="">
                        <input id="filterId" name="filterId" type="hidden" value="">
                    }
                </fieldset>

                <div class="actions pull-right">
                    <button id="launchButton" type="button" class="btn btn-primary">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <hr/>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div id="outputDiv">
            </div>
        </div>
    </div>
}
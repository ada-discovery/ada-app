@import reactivemongo.play.json.BSONFormats._
@import views.html.layout.main
@import views.html.dataset.{inputFieldAndFilterResources, datasetMenu, datasetSubNavWithJs}
@import views.html.table.dynamicTableJsImport
@import views.html.dataview.dataViewSelectionModal
@import views.html.dataset.dynamicFieldTable
@import views.html.dataset.dataSetFilterWithJs
@import play.api.i18n.Messages
@import models.DataSpaceMetaInfo
@import views.html.elements._
@import controllers.DataSetWebContext
@import controllers.DataSetWebContext._

@(
    dataSetName: String,
    filterSpec: models.Filter,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @dataSetFilterWithJs(
                filterSpec,
                dataSetRouter.getIndependenceTest(filterSpec.conditionsOrId),
                filterShowFieldStyle
            )
        </div>
        <div class="pull-right">
            <button class="btn btn-success btn-sm" href="#" onclick="testIndependence();" data-toggle="tooltip" title="Test Independence">
                <span class="glyphicon glyphicon-play" aria-hidden="true"></span> Launch
            </button>

            <button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#dataViewSelectionModal" title="Add Independence Test To View">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To View
            </button>
        </div>
    </div>
}

@bottomResources = {
    @inputFieldAndFilterResources(
        Seq("filter"),
        filterShowFieldStyle
    )

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.testIndependence
    )

    @helper.javascriptRouter("dataViewJsRoutes")(
        dataViewJsRouter.addIndependenceTest
    )

    <script type="text/javascript">
        $(function () {
            populateFieldTypeahedFromUrl(
                $('#targetFieldTypeahead'),
                $('#targetFieldName'),
                '@Html(dataSetRouter.fieldNamesAndLabels(Seq(FieldTypeId.Enum, FieldTypeId.String, FieldTypeId.Boolean, FieldTypeId.Json)).url)',
                @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
            )

            $("#dataViewSelectionModal #submitButton").on("click", addIndependenceTestToView)

            $('#outputFieldTypeahead, #filterNameTypeahead').keypress(function (e) {
                if (e.which == 13) {
                    testIndependence();
                }
            });

            $('#launchButton').on('click', function() {
                testIndependence();
            })
        });

        function testIndependence() {
            var targetFieldName = $("#targetFieldName").val();
            var targetFieldLabel = $("#targetFieldTypeahead").val();

            $('#inputFieldNameDiv').dynamicTable('updateModelFromTable');
            var inputFieldNames = $("#inputFieldNameDiv").dynamicTable('getModel')

            var filterOrId = $("#filterDiv").multiFilter('getJsonFilterId')
            if (!filterOrId) {
                filterOrId = $("#filterDiv").multiFilter('getModel')
            }
            var filterOrIdJson = JSON.stringify(filterOrId)

            $('#outputDiv').html("");

            if (!targetFieldName) {
                showError("No target field specified.")
            } else if (inputFieldNames.length == 0) {
                showError("No input fields specified.")
            } else {
                $("#outputDiv").html("");
                dataSetJsRoutes.controllers.dataset.DataSetDispatcher.testIndependence(filterOrIdJson).ajax({
                    data: {
                        "inputFieldNames": inputFieldNames,
                        "targetFieldName": targetFieldName
                    },
                    success: function (results) {
                        showMessage("Independence test finished.")

                        var table = createIndependenceTestTable(results, true)

                        $("#outputDiv").html(table);
                        $('#outputDiv').fadeIn('2000');
                    },
                    error: function (data) {
                        $("#outputDiv").html("")
                        showErrorResponse(data);
                    }
                });

                hideErrors()
                showMessage("Independence test for the field '" + targetFieldLabel + "' launched.")
                addSpinner($("#outputDiv"))
            }
        }

        function addIndependenceTestToView() {
            var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
            var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()

            var targetFieldName = $("#targetFieldName").val();
            var targetFieldLabel = $("#targetFieldTypeahead").val();

            $('#inputFieldNameDiv').dynamicTable('updateModelFromTable');
            var inputFieldNames = $("#inputFieldNameDiv").dynamicTable('getModel')

            if (!targetFieldName) {
                showError("No target field specified.")
            } else if (inputFieldNames.length == 0) {
                showError("No input fields specified.")
            } else {
                dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addIndependenceTest(dataViewId, targetFieldName, inputFieldNames).ajax( {
                    success: function() {
                        showMessage("Independence test for the field '" + targetFieldLabel + "' has been successfully added to the view '" + dataViewName + "'.");
                    },
                    error: function(data){
                        showErrorResponse(data);
                    }
                });
            }
        }
    </script>
}

@extraFieldButtons = {
    <a id="addAllFieldsButton" class="btn btn-info btn-sm" href="#" onclick="addAllFields();" data-toggle="tooltip" title="Add All">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> All
    </a>

    <a id="addAllNumericalFieldsButton" class="btn btn-info btn-sm" href="#" onclick="addAllNumericalFields();" data-toggle="tooltip" title="Add All Numerical">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> All Numerical
    </a>
}

@main(Messages("independenceTest.title", dataSetName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNavWithJs()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("independenceTest.title", dataSetName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>

    <hr/>

    @dynamicTableJsImport()

    <div class="row">
        <div class="col-md-5">
            <div class="row">
                @labelValue("targetField", "Target") {
                    <input id="targetFieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="">
                    <input id="targetFieldName" name="targetFieldName" type="hidden" value="">
                }

                @labelValue("inputFieldNames", "Input") {
                    @dynamicFieldTable(
                        "inputFieldName",
                        Nil,
                        false,
                        12,
                        Some(extraFieldButtons),
                        Some(Right(dataSetRouter.getCategoriesWithFieldsAsTreeNodes(Left(Nil))))
                    )
                }
            </div>
        </div>
        <div id="outputDiv" class="col-md-7">
        </div>
        @dataViewSelectionModal("dataViewSelectionModal", dataViewRouter)
    </div>
}
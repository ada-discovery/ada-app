@import models.Field
@import views.html.dataset.{widgetsScreen, dynamicFieldTable}
@import views.html.table.dynamicTableJsImport
@import models.DataSpaceMetaInfo
@import controllers.dataset.DataSetWebContext._
@import controllers.dataset.DataSetWebContext

@(
    dataSetName: String,
    filterSpec: models.Filter,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@extraActions = {
    <div class="pull-right">
        <button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#dataViewSelectionModal" title="Add Table To View">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To View
        </button>
    </div>
}

@bottomResources = {

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.generateTableWithFilter
    )

    @helper.javascriptRouter("dataViewJsRoutes")(
        dataViewJsRouter.addTableFields
    )

    <script type="text/javascript">
        $(function () {
            populateFullTypeahead("field")

            $("#dataViewSelectionModal #submitButton").on("click", addTableToView);

            $('#fieldNameDiv #addRowButton').focus();

            activateFilter($("#filterDiv"), function(filterOrId) {generateTable()});

            $("#fieldNameDiv").on("rowAdded", generateTable)
            $("#fieldNameDiv").on("rowsAdded", generateTable)
            $("#fieldNameDiv").on("rowsRemoved", generateTable)
        });

        function generateTable() {
            var fieldNames = getFieldNames()

            var filterOrId = $("#filterDiv").multiFilter('getIdOrModel')
            var filterOrIdJson = JSON.stringify(filterOrId);

            if (fieldNames.length == 0) {
                showError("Table generation cannot be launched. No fields specified.");
            } else if (fieldNames.length > 50) {
                showError("Table generation cannot be launched. The maximum number of fields allowed is 50 but " + inputFieldNames.length + " were given.");
            } else {
                dataSetJsRoutes.controllers.dataset.DataSetDispatcher.generateTableWithFilter(0, "", fieldNames, filterOrIdJson).ajax({
                    success: function (data) {
                        // filter
                        var filterElement = $("#filterDiv")
                        filterElement.find("#conditionPanel").replaceWith(data.conditionPanel)
                        filterElement.multiFilter("initConditionButtons")
                        filterElement.multiFilter("setModel", data.filterModel)

                        // table
                        var tableDiv = $("#widgetsDiv .table-div")
                        if (tableDiv.length == 0) {
                            $("#widgetsDiv").html("<div class='table-div'></div>")
                            tableDiv = $("#widgetsDiv .table-div")
                        }
                        tableDiv.html(data.table)
                        showMessage("Table generation finished.")
                    },
                    error: function (data) {
                        $("#widgetsDiv").html("")
                        showErrorResponse(data);
                    }
                })

                hideErrors();
                showMessage("Table generation for " + fieldNames.length + " fields launched.")
            }
        }

        function addTableToView() {
            var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
            var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()

            var fieldNames = getFieldNames()

            if (fieldNames.length == 0) {
                showError("No fields defined.");
            } else if (fieldNames.length > 50) {
                showError("The maximum number of fields allowed is 50 but " + fieldNames.length + " were given.");
            } else {
                dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addTableFields(dataViewId, fieldNames).ajax({
                    success: function() {
                        showMessage("Table for the field(s) '" + fieldNames.join(", ") + "' has been successfully added to the view '" + dataViewName + "'.");
                    },
                    error: showErrorResponse
                });
            }
        }

        function getFieldNames() {
            $('#fieldNameDiv').dynamicTable('updateModelFromTable');
            return $('#fieldNameDiv').dynamicTable('getModel');
        }

        function addAllFields() {
            $.ajax({
                url: '@Html(dataSetRouter.allFieldNamesAndLabels.url)',
                success: function (data) {
                    var values = $.map(data, function(field, index) {
                        var entry = {};
                        entry["fieldName"] = field[0];
                        entry["fieldTypeahead"] = field[1] ? field[1] : field[0];

                        return entry;
                    });
                    $('#fieldNameDiv').dynamicTable('addTableRows', values)
                }
            });
        }
    </script>
}

@fieldButtons = {
    <a id="addAllFieldsButton" class="btn btn-info btn-sm" href="#" onclick="addAllFields();" data-toggle="tooltip" title="Add All">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> All
    </a>
}

@inputElements = {

    @dynamicTableJsImport()

    @dynamicFieldTable(
        "fieldName",
        Nil,
        true,
        12,
        Some(fieldButtons),
        Some(Right(dataSetRouter.getCategoriesWithFieldsAsTreeNodes(filterSpec.conditionsOrId))),
        "categoryTree2"
    )
}

@widgetsScreen(
    Messages("table.title", dataSetName),
    filterSpec,
    filterShowFieldStyle,
    dataSpaceMetaInfos,
    inputElements,
    extraActions,
    bottomResources,
    true,
    widgetsDivOnRight = true
)
@import controllers.dataset.{DataSetRouter, FilterRouter, FilterJsRouter}
@import controllers.dataset.routes.{DataSetSettingController => dataSetSettingRoutes}
@import reactivemongo.bson.BSONObjectID
@import reactivemongo.play.json.BSONFormats._
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.chart.highcharts.scatterChart
@import views.html.chart.{chartJs, chart}
@import views.html.layout.main
@import views.html.dataset.datasetSubNav
@import play.api.libs.json.Json
@import play.api.mvc.Flash
@import play.api.i18n.Messages
@import models.{DataSpaceMetaInfo, FieldTypeId, Field}

@(
    domainName: String,
    xField: Option[Field],
    yField: Option[Field],
    groupField: Option[Field],
    chartSpec: Option[ScatterChartSpec],
    xMean: Option[Double],
    yMean: Option[Double],
    filterSpec: models.Filter,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    router: DataSetRouter,
    filterRouter: FilterRouter,
    filterJsRouter: FilterJsRouter,
    dataSetId: String,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit flash: Flash, msg: Messages, request: Request[_]
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filter(
                Some(filterSpec),
                router.getScatterStats(xField.map(_.name), yField.map(_.name), groupField.map(_.name), filterSpec.conditionsOrId),
                Right(router.allFields),
                filterShowFieldStyle,
                Some(filterJsRouter),
                Some(filterRouter.idAndNames),
                "filterOrId"
            )
        </div>
        <div class="pull-right">
            <button class="btn btn-info btn-sm" type="button" onclick="addScatterToOverview()" data-toggle="tooltip" title="Add Scatter To Overview">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To Overview
            </button>
        </div>
    </div>
    <hr/>
    @helper.form(action=router.plainGetScatterStats, 'role -> "search", 'id -> "fieldForm") {
        <!-- hacky solution to pass data set param since it's ignored when passed as a part of call in form action -->
        <input type="hidden" name="dataSet" value="@dataSetId"/>
        <input type="hidden" name="filterOrId" value="@filterSpec.conditionsOrId.fold(Json.toJson(_), _.stringify)"/>
        <div class="row">
            <div class="col-md-3">
                <input id="xFieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name or Label" value="@xField.map(_.labelOrElseName)">
                <input id="xFieldName" name="xFieldName" type="hidden" value="@xField.map(_.name)">
            </div>
            <div class="col-md-1" align="center">
                <label class="top-padded">vs.</label>
            </div>
            <div class="col-md-3">
                <input id="yFieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name or Label" value="@yField.map(_.labelOrElseName)">
                <input id="yFieldName" name="yFieldName" type="hidden" value="@yField.map(_.name)">
            </div>
            <div class="col-md-2" align="right">
                <label class="top-padded">Group by</label>
            </div>
            <div class="col-md-3">
                <input id="groupFieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name or Label" value="@groupField.map(_.labelOrElseName)">
                <input id="groupFieldName" name="groupFieldName" type="hidden" value="@groupField.map(_.name)">
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <div class="well">
                    Mean: @{xMean.map { mean =>
                        BigDecimal(mean).setScale(3, BigDecimal.RoundingMode.FLOOR)
                    }.getOrElse("N/A")}
                </div>
            </div>
            <div class="col-md-offset-2 col-md-2">
                <div class="well">
                    Mean: @{yMean.map { mean =>
                        BigDecimal(mean).setScale(3, BigDecimal.RoundingMode.FLOOR)
                    }.getOrElse("N/A")}
                </div>
            </div>
        </div>
        <hr/>
    }
}

@bottomResources =  {
    @highchartsJsImport()
    @chartSpec.map(chartJs(_)).getOrElse("")
}

@main(Messages("scatterAnalysis.title", domainName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNav()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("scatterAnalysis.title", domainName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>

    @chartSpec.map(chart(_)).getOrElse("")
}

<script type="text/javascript" src="@dataSetSettingRoutes.jsRoutes"></script>
<script type="text/javascript">
    $(function () {
        $.ajax({
            url: '@Html(router.fields(Seq(FieldTypeId.Integer, FieldTypeId.Double)).url)',
            success: function (data) {
                populateFieldTypeahed(
                    $('#fieldForm #xFieldTypeahead'),
                    $('#fieldForm #xFieldName'),
                    data,
                    @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
                );
                populateFieldTypeahed(
                    $('#fieldForm #yFieldTypeahead'),
                    $('#fieldForm #yFieldName'),
                    data,
                    @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
                );
            }
        });

        populateFieldTypeahedFromUrl(
            $('#fieldForm #groupFieldTypeahead'),
            $('#fieldForm #groupFieldName'),
            '@Html(router.fields(Seq(FieldTypeId.Enum, FieldTypeId.String, FieldTypeId.Boolean)).url)',
            @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
        );

        $('#fieldForm #xFieldTypeahead').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #yFieldTypeahead').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #groupFieldTypeahead').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #xFieldTypeahead').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });

        $('#fieldForm #yFieldTypeahead').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });

        $('#fieldForm #groupFieldTypeahead').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });
    });

    function addScatterToOverview() {
        var xFieldName = $('#fieldForm #xFieldName').val()
        var yFieldName = $('#fieldForm #yFieldName').val()
        var groupFieldName = $('#fieldForm #groupFieldName').val()

        if (!groupFieldName) {
            groupFieldName = null
        }

        if (fieldName) {
            jsRoutes.controllers.dataset.DataSetSettingController.addScatterToOverview('@dataSetId', xFieldName, yFieldName, groupFieldName).ajax( {
                success: function() {
                    showMessage("Scatter for the fields '" + xFieldName + "', '" + yFieldName + "' has been successfully added to the overview.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }
    }
</script>
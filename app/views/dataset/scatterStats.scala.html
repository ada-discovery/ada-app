@import controllers.dataset.DataSetRouter
@import util.{BasicStats, FilterCondition}
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.chart.highcharts.scatterChart
@import views.html.layout.main
@import views.html.dataset.datasetSubNav
@import play.api.libs.json.Json
@import play.api.mvc.Flash
@import play.api.i18n.Messages

@import dataaccess.DataSpaceMetaInfo

@(
    domainName: String,
    xFieldName: String,
    yFieldName: String,
    groupFieldName: Option[String],
    numericFields: Seq[(String, Option[String])],
    categoricalFields: Seq[(String, Option[String])],
    series: Seq[(String, Seq[(Any, Any)])],
    filterSpec: Seq[FilterCondition],
    router: DataSetRouter,
    dataSetId: String,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit flash: Flash, msg: Messages, request: Request[_]
)

@numericFieldNamesAsString = @{
    Html(numericFields.map(s => "\"" + s._1 + "\"").mkString(","))
}

@categoricalFieldNamesAsString = @{
    Html(categoricalFields.map(s => "\"" + s._1 + "\"").mkString(","))
}

@actions = {
    <div class="row">
        <div class="col-md-12">
            @filter(filterSpec, router.getScatterStats(Some(xFieldName), Some(yFieldName), groupFieldName, filterSpec), Right(router.fieldNames))
        </div>
    </div>
    <hr/>
    @helper.form(action=router.plainGetScatterStats, 'role -> "search", 'id -> "fieldForm") {
        <!-- hacky solution to pass data set param since it's ignored when passed as a part of call in form action -->
        <input type="hidden" name="dataSet" value="@dataSetId"/>
        <input type="hidden" name="filter" value="@Json.toJson(filterSpec)"/>
        <div class="row">
            <div class="col-md-3">
                <input id="xField" name="xField" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@xFieldName">
            </div>
            <div class="col-md-1" align="center">
                <label class="top-padded">vs.</label>
            </div>
            <div class="col-md-3">
                <input id="yField" name="yField" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@yFieldName">
            </div>
            <div class="col-md-2" align="right">
                <label class="top-padded">Group by</label>
            </div>
            <div class="col-md-3">
                <input id="groupField" name="groupField" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@groupFieldName">
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <div class="well">
                    Mean: @(BasicStats.mean(series.map(x => x._2).flatten.map(_._1)).map(mean => BigDecimal(mean).setScale(3,BigDecimal.RoundingMode.FLOOR)))
                </div>
            </div>
            <div class="col-md-offset-2 col-md-2">
                <div class="well">
                    Mean: @(BasicStats.mean(series.map(x => x._2).flatten.map(_._2)).map(mean => BigDecimal(mean).setScale(3,BigDecimal.RoundingMode.FLOOR)))
                </div>
            </div>
        </div>
        <hr/>
    }
}

@bottomResources =  {
    @highchartsJsImport()
    @scatterChart(
        "Comparison",
        "scatterChart",
        xFieldName.capitalize,
        yFieldName.capitalize,
        series.map{ case (name, values) =>
            (name, "rgba(223, 83, 83, .5)", values.map(pair => Seq(pair._1, pair._2)))
        }
    )
}

@main(Messages("scatterAnalysis.title", domainName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNav()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("scatterAnalysis.title", domainName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>

    <div id="scatterChart" class="chart-holder"></div>
}

<script type="text/javascript">
    $(function () {
        populateTypeahead($('#fieldForm #xField'), [@numericFieldNamesAsString], true);
        populateTypeahead($('#fieldForm #yField'), [@numericFieldNamesAsString], true);
        populateTypeahead($('#fieldForm #groupField'), [@categoricalFieldNamesAsString], true);

        $('#fieldForm #xField').focus();

        $('#fieldForm #xField').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #yField').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #groupField').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm xField').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });

        $('#fieldForm #yField').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });

        $('#fieldForm #groupField').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });
    });
</script>
@import controllers.dataset.DataSetRouter
@import util.{BasicStats, FilterSpec}
@import util.shorten
@import views.html.layout.main
@import play.api.libs.json.Json

@(
    domainName: String,
    xField: String,
    yField: String,
    filterSpec: FilterSpec,
    router: DataSetRouter,
    dataSetId: String,
    numericFields: Seq[(String, Option[String])],
    stats: Seq[(Any, Any)],
    dataSetMetaInfos: Traversable[DataSetMetaInfo]
)(
    implicit flash: play.api.mvc.Flash, msg: play.api.i18n.Messages, request: RequestHeader
)

@label(key: String, value: Option[String]) = {
    @shorten(value.map(_ + " : " + key).getOrElse(key), 80)
}

@optionX(key : String, value : Option[String]) = {
    <option value="@key" @if(xField == key){selected="selected"}>@label(key, value)</option>
}

@optionY(key : String, value : Option[String]) = {
    <option value="@key" @if(yField == key){selected="selected"}>@label(key, value)</option>
}

@actions = {
    <div class="row">
        <div class="col-md-12">
            @filter(filterSpec, router.getScatterStats(Some(xField), Some(yField), filterSpec), Right(router.fieldNames))
        </div>
    </div>
    <hr/>
    @helper.form(action=router.plainGetScatterStats, 'role -> "search", 'id -> "myForm") {
        <div class="row">
            <div class="col-md-8">
                <!-- hacky solution to pass data set param since it's ignored when passed as a part of call in form action -->
                <input type="hidden" name="dataSet" value="@dataSetId"/>
                <input type="hidden" name="filter" value="@Json.toJson(filterSpec)"/>
                <div class="row">
                    <select name="xField" id="xField" class="input-lg">
                        @numericFields.map( field => optionX(field._1, field._2) )
                    </select>
                </div>
                <div class="row" align="center">
                    vs.
                </div>
                <div class="row">
                    <select name="yField" id="yField" class="input-lg">
                        @numericFields.map( field => optionY(field._1, field._2) )
                    </select>
                </div>
            </div>

            <div class="col-md-4" align="right">
                <div class="well">
                    Mean: @(BasicStats.mean(stats.map(x => x._1)).map(mean => BigDecimal(mean).setScale(3,BigDecimal.RoundingMode.FLOOR)))
                </div>
                <div class="well">
                    Mean: @(BasicStats.mean(stats.map(x => x._2)).map(mean => BigDecimal(mean).setScale(3,BigDecimal.RoundingMode.FLOOR)))
                </div>
            </div>
        </div>
        <hr/>
        <script>
            $('#xField').change(function() {
                $('#myForm').submit();
            });
            $('#yField').change(function() {
                $('#myForm').submit();
            });
        </script>
    }
}

@main(Messages("scatterAnalysis.title", domainName), Some(datasetMenu(dataSetMetaInfos))) {

    <div class="page-header">
        <h3>
            @Messages("scatterAnalysis.title", domainName)
        </h3>
    </div>

    @flashMessages()

    <div id="actions">
        @actions
    </div>

    @views.html.chart.highcharts.scatterChart(
        "Comparison",
        "scatterChart",
        xField.capitalize,
        yField.capitalize,
        Seq(
            ("All", "rgba(223, 83, 83, .5)", stats.map(pair => Seq(pair._1, pair._2)))
        )
    )
}
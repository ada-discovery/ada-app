@import views.html.layout
@import views.html.dataset.{filterChartPanel, datasetSubNav, datasetMenu, datasetActions, displayJsonModal}
@import views.html.chart.chartPanelJs
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.table.paginatedJsonTable
@import play.modules.reactivemongo.json._
@import reactivemongo.bson.BSONObjectID
@import models.FieldChartSpec
@import play.api.mvc.Flash
@import play.api.i18n.Messages
@import play.api.libs.json.{JsValue, JsArray, JsObject}
@import controllers.dataset.DataSetRouter
@import models.Field

@(
    domainName : String,
    page: Page[JsObject],
    displayedFields: Traversable[Field],
    displayedFieldNames: Traversable[String], // could differ from the displayed fields since the dictionary doesn't have to contain all the fields... this, however, could happen only when a fresh data set (without dictionary) is imported
    fieldChartSpecs: Traversable[FieldChartSpec],
    chartGridElementWidth: Int,
    router: DataSetRouter,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit flash: Flash, msg: Messages, request: Request[_]
)

@actions = @{
    datasetActions(
        router,
        page
    )
}

@genJsonRender(jsValue: JsValue)(linkTitle: Html) = {
    @defining(scala.util.Random.nextLong()) { modalId =>
        <a href="#" data-modalid="@{modalId}" class="jsonModalLink">
            @linkTitle
        </a>
        @displayJsonModal(modalId + "Modal", jsValue)
    }
}

@jsonRender(jsValue: JsValue) = {
    @genJsonRender(jsValue) {
        <b>Json</b>
    }
}

@arrayRender(jsValue: JsValue) = {
    @genJsonRender(jsValue) {
        <b>Array (size @{
            jsValue.asInstanceOf[JsArray].value.size
        })</b>
    }
}

@dateRender(jsValue: JsValue) = {
    @jsValue.asOpt[java.util.Date].get.toString
}

@jsonArrayRender(jsValue: JsValue) = {
    @genJsonRender(jsValue) {
        <b>Json Array (size @{
            jsValue.asInstanceOf[JsArray].value.size
        })</b>
    }
}

@table = @{
    paginatedJsonTable(
        page,
        router.overviewList(_, _, page.filter),
        Some(displayedFields.map{ field =>
            field.label.map( fieldLabel => (field.name, fieldLabel))
        }.flatten.toMap),
        Some(displayedFieldNames.toSeq),
        Some({ item : JsObject => router.get((item \ "_id").as[BSONObjectID])}),
        Some(displayedFields.map{ field =>
            if (field.isArray) {
                if(field.fieldType == FieldType.Json)
                    Some(field.name, jsonArrayRender(_))
                else
                    Some(field.name, arrayRender(_))
            } else
                if (field.fieldType == FieldType.Json)
                    Some(field.name, jsonRender(_))
                else if (field.fieldType == FieldType.Json)
                    Some(field.name, dateRender(_))
                else None
        }.flatten.toMap)
    )
}

@bottomResources = {
    @highchartsJsImport()
    @chartPanelJs(fieldChartSpecs.map(_.chartSpec))
    <script type="text/javascript">
        $(function () {
            $(".jsonModalLink").click(function(event) {
                event.stopPropagation();
                var modalId = $(this).data("modalid");
                $('#' + modalId + 'Modal').modal();
            })
        })
    </script>
}

@layout.list(
    domainName,
    page.total,
    actions,
    table,
    Some(filterChartPanel(fieldChartSpecs, chartGridElementWidth)),
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav()),
    None,
    Some(bottomResources)
)
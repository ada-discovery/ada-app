@import play.api.libs.json.JsObject
@import reactivemongo.bson.BSONObjectID
@import play.modules.reactivemongo.json._
@import util.{ChartSpec, PieChartSpec, ColumnChartSpec}
@import views.html
@import views.html.chart.highcharts

@(
    domainName : String,
    currentPage: Page[JsObject],
    fieldsToShow : Seq[String],
    chartDatas : Iterable[ChartSpec],

    // All calls wrapped in a router object
    router : DataSetRouter
)(
    implicit flash: play.api.mvc.Flash, msg: play.api.i18n.Messages, request: RequestHeader
)

@actions = {
    <div class="row">
        <div class="col-md-8">
            @filter(currentPage.filter, router.plainOverviewListCall)
        </div>
        <div class="col-md-4">
            @html.dataset.exportDropdown(router.exportAllCsvCall, router.exportAllJsonCall, router.exportTranSMARTDataCall, router.exportTranSMARTMappingCall)
        </div>
    </div>
}

@displayCall(newPage : Int, newOrderBy : Option[String]) = @{
    router.overviewListCall(newPage, newOrderBy.map { nOrderBy =>
        if (nOrderBy == currentPage.orderBy) {
            "-" + currentPage.orderBy
        } else if (("-" + nOrderBy) == currentPage.orderBy) {
            nOrderBy
        } else nOrderBy
    }.getOrElse(currentPage.orderBy), currentPage.filter)
}

@rowClickCall(item : JsObject) = @{
    router.getCall((item \ "_id").as[BSONObjectID]).url
}

@table = {
    @jsonTable(currentPage.items, currentPage.orderBy, displayCall(_, _),
        Some(fieldsToShow),
        Some(rowClickCall)
    )
}

@main(Messages("overviewList.title", domainName)) {

        <!-- Begin page content -->
    <div class="container">
        <div class="page-header">
            <h3>
                @Messages("list.count.title", currentPage.total, domainName)
            </h3>
        </div>

        @flashMessages()

        <div id="actions">
            @actions
        </div>

        <div class="row" style="padding-bottom: 100px;">
            @chartDatas.map { chartSpec =>
                <div class="col-md-3">
                    @{chartSpec match {
                        case PieChartSpec(title, showLabels, showLegend, data) => highcharts.pieChart(title, title + "Chart", showLabels, showLegend, data)
                        case ColumnChartSpec(title, data) => highcharts.columnChart(title, title + "Chart", "Count", data)
                        case _ => throw new IllegalArgumentException(s"Chart spec $chartSpec is unknown.")
                    }}
                </div>
            }
        </div>

        @if(!currentPage.items.isEmpty) {
            @table
            <hr/>
            @pagination(displayCall, currentPage)
        } else {
            <div class="panel panel-default">
                <div class="panel-body">
                    <em>Nothing to display</em>
                </div>
            </div>
        }
    </div>
}
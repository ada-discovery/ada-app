@import views.html.layout
@import views.html.dataset.{filterChartPanel, datasetSubNav, datasetMenu, displayJsonModal}
@import views.html.chart.chartPanelJs
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.table.paginatedJsonTable
@import views.html.dataset.exportDropdown
@import play.modules.reactivemongo.json._
@import reactivemongo.bson.BSONObjectID
@import models.FieldChartSpec
@import play.api.mvc.Flash
@import play.api.i18n.Messages
@import play.api.libs.json.{JsValue, JsArray, JsObject}
@import controllers.dataset.DataSetRouter
@import models.Field

@(
    domainName : String,
    page: Page[JsObject],
    displayedFields: Traversable[Field],
    displayedFieldNames: Traversable[String], // could differ from the displayed fields since the dictionary doesn't have to contain all the fields... this, however, could happen only when a fresh data set (without dictionary) is imported
    fieldChartSpecs: Traversable[FieldChartSpec],
    chartGridElementWidth: Int,
    router: DataSetRouter,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit flash: Flash, msg: Messages, request: Request[_]
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filter(page.filter, router.plainOverviewList, Right(router.fieldNames))
        </div>
        <div class="col-md-2">
            @exportDropdown(router.exportAllCsv, router.exportAllJson, router.exportTranSMARTData, router.exportTranSMARTMapping)
        </div>
    </div>

}

@genJsonRender(id: BSONObjectID, fieldName: String)(linkTitle: Html) = {
    <a href="#" onclick="showFieldValue('@id.stringify', '@fieldName');" class="jsonModalLink">
    @linkTitle
    </a>
}

@jsonRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Json</b>
    }
}

@arrayRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Array</b>
    }
}

@jsonArrayRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Json Array</b>
    }
}

@dateRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @jsValue.map(_.asOpt[java.util.Date].get.toString)
}

@table = @{
    paginatedJsonTable(
        page,
        router.overviewList(_, _, page.filter),
        Some(displayedFields.map{ field =>
            field.label.map( fieldLabel => (field.name, fieldLabel))
        }.flatten.toMap),
        Some(displayedFieldNames.toSeq),
        Some({ item : JsObject => router.get((item \ "_id").as[BSONObjectID])}),
        Some(displayedFields.map{ field =>
            if (field.isArray) {
                if(field.fieldType == FieldType.Json)
                    Some(field.name, jsonArrayRender(_, _, _))
                else
                    Some(field.name, arrayRender(_, _, _))
            } else
                if (field.fieldType == FieldType.Json)
                    Some(field.name, jsonRender(_, _, _))
                else if (field.fieldType == FieldType.Json)
                    Some(field.name, dateRender(_, _, _))
                else None
        }.flatten.toMap)
    )
}

@bottomResources = {
    <script type="text/javascript" src="@router.jsRoutes"></script>
    @displayJsonModal("jsonModal", None)
    @highchartsJsImport()
    @chartPanelJs(fieldChartSpecs.map(_.chartSpec))
    <script type="text/javascript">
        $(function () {
            $(".jsonModalLink").click(function(event) {
                event.stopPropagation();
            })
        })

        function showFieldValue(id, fieldName) {
            dataSetJsRoutes.controllers.dataset.DataSetDispatcher.getFieldValue(id, fieldName).ajax( {
                success: function(data) {
                    var json = JSON.stringify(data, null, "\t").replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;').replace(/\n/g, '</br>')
                    var size = data.length
                    var title = "JSON Browser"
                    if (size)
                        title = title + ": Array (Size " + size + ")"

                    $('#jsonModal #jsonModalBody').html(json)
                    $('#jsonModal .modal-title').html(title)
                    $('#jsonModal').modal();
                },
                error: function(data){
                    showError(data.responseText);
                }
            });
        }
    </script>
}

@layout.list(
    domainName,
    page.total,
    actions,
    table,
    Some(filterChartPanel(fieldChartSpecs, chartGridElementWidth)),
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav()),
    None,
    Some(bottomResources)
)
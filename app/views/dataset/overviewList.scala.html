@import play.api.libs.json.JsObject
@import reactivemongo.bson.BSONObjectID
@import util.ChartSpec
@import play.modules.reactivemongo.json._
@import views.html
@import views.html.dataset.chartPanel

@(
    domainName : String,
    currentPage: Page[JsObject],
    fieldsToShow : Seq[String],
    fieldNameChartSpecs : Iterable[(String, ChartSpec)],

    // All calls wrapped in a router object
    router : DataSetRouter
)(
    implicit flash: play.api.mvc.Flash, msg: play.api.i18n.Messages, request: RequestHeader
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filter(currentPage.filter, router.plainOverviewListCall)
        </div>
        <div class="col-md-2">
            @html.dataset.exportDropdown(router.exportAllCsvCall, router.exportAllJsonCall, router.exportTranSMARTDataCall, router.exportTranSMARTMappingCall)
        </div>
    </div>
}

@displayCall(newPage : Int, newOrderBy : Option[String]) = @{
    router.overviewListCall(newPage, newOrderBy.map { nOrderBy =>
        if (nOrderBy == currentPage.orderBy) {
            "-" + currentPage.orderBy
        } else if (("-" + nOrderBy) == currentPage.orderBy) {
            nOrderBy
        } else nOrderBy
    }.getOrElse(currentPage.orderBy), currentPage.filter)
}

@rowClickCall(item : JsObject) = @{
    router.getCall((item \ "_id").as[BSONObjectID]).url
}

@table = {
    @jsonTable(currentPage.items, currentPage.orderBy, displayCall(_, _),
        Some(fieldsToShow),
        Some(rowClickCall)
    )
}

@main(Messages("overviewList.title", domainName)) {

    <div class="container">
        <div class="page-header">
            <h3>
                @Messages("list.count.title", currentPage.total, domainName)
            </h3>
        </div>

        @flashMessages()

        <div id="actions">@actions</div>
        <hr/>

        @filterChartPanel(fieldNameChartSpecs)

        <br/><br/>

        <div align="middle">
            <div class="well">
                <div class="row">
                    <span id="arrowUp" class="glyphicon glyphicon-arrow-up"></span>
                </div>
                <div class="row">
                    <button id="showHideTableButton" type="button" class="btn btn-default btn-sm" data-toggle="collapse" data-target="#table-panel">Hide Table</button>
                </div>
                <div class="row">
                    <span id="arrowDown" class="glyphicon glyphicon-arrow-down" style="display:none"></span>
                </div>
            </div>
        </div>

        <div id="table-panel" class="collapse in">
            @if(!currentPage.items.isEmpty) {
                @table
                <hr/>
                @pagination(displayCall, currentPage)
            } else {
                <div class="panel panel-default">
                    <div class="panel-body">
                        <em>Nothing to display</em>
                    </div>
                </div>
            }
        </div>
    </div>
    <script>
        var tableShown = true
        $('#showHideTableButton').on('click', function() {
            if (tableShown) {
                $('#arrowUp').hide();
                $('#arrowDown').show();
                $('#showHideTableButton').html("Show Table");
            } else {
                $('#arrowUp').show();
                $('#arrowDown').hide();
                $('#showHideTableButton').html("Hide Table");
            }
            tableShown = !tableShown;
        });
    </script>
}
@import views.html.table.paginatedJsonTable
@import views.html.dataset.displayJsonModal
@import reactivemongo.bson.BSONObjectID
@import play.api.libs.json.{JsValue, JsObject}
@import models.{Field, FieldTypeId}
@import util.FieldTypeRenderer
@import controllers.dataset.DataSetViewData
@import controllers.dataset.DataSetRouter
@import reactivemongo.play.json.BSONFormats.BSONObjectIDFormat
@import models.FilterCondition.FilterOrId
@import models.DataSetFormattersAndIds.JsObjectIdentity

@(
    page: Page[JsObject],
    tableFields: Traversable[Field],
    dataSetRouter: DataSetRouter,
    withRowClickableJs: Boolean = false
)(
    implicit request: Request[_]
)

@genJsonRender(id: BSONObjectID, fieldName: String)(linkTitle: Html) = {
    <a href="#" onclick="showFieldValue('@id.stringify', '@fieldName');" class="jsonModalLink">
        @linkTitle
    </a>
}

@jsonRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Json</b>
    }
}

@arrayRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Array</b>
    }
}

@jsonArrayRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Json Array</b>
    }
}

@render(field: Field) = @{
    if (field.isArray) {
        if(field.fieldType == FieldTypeId.Json)
            (field.name, jsonArrayRender(_, _, _))
        else
            (field.name, arrayRender(_, _, _))
    } else {
        if(field.fieldType == FieldTypeId.Json)
            (field.name, jsonRender(_, _, _))
        else {
            val renderer = FieldTypeRenderer(field)
            (field.name, { (id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) => renderer(jsValue) })
        }
    }
}

@paginatedJsonTable(
    page,
    dataSetRouter.getTable(
        _, _,
        tableFields.map(_.name).toSeq,
        page.filter.map(_.conditionsOrId).getOrElse(Left(Nil))
    ),
    Some(
        tableFields.map( field =>
            field.label.map( fieldLabel => (field.name, fieldLabel))
        ).flatten.toMap
    ),
    Some(tableFields.map(_.name).toSeq),
    Some({ item : JsObject => dataSetRouter.get((item \ JsObjectIdentity.name).as[BSONObjectID])}),
    Some(tableFields.map(render).toMap),
    true
)

@if(withRowClickableJs) {
    <script type="text/javascript">
        activateRowClickable();
    </script>
}
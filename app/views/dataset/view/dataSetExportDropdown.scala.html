@import views.html.{exportModal, exportDropdown}
@import views.html.elements.{labelValue, fieldTypeahead}
@import controllers.dataset.DataSetWebContext
@import controllers.dataset.DataSetWebContext._
@import reactivemongo.bson.BSONObjectID
@import models.FilterShowFieldStyle

@(
    dataViewId: BSONObjectID,
    dataSetName: String,
    showFieldStyle: Option[FilterShowFieldStyle.Value]
)(
    implicit context: DataSetWebContext
)

@transmartModalBody(defaultDelimiter: String) = {
    <fieldset>
        @labelValue("delimiter", "Delimiter", labelGridWidth = 3) {
            <input id="delimiter" name="delimiter" value="@defaultDelimiter">
        }
        @labelValue("visitFieldName", "Visit Field", labelGridWidth = 3) {
            @fieldTypeahead(None, "visitField")
        }
        @labelValue("replaceEolWithSpace", "Remove \'\\r\'&\'\\n\'?", helpText = Some("Replace \'\\r\' and \'\\n\' with white space"), labelGridWidth = 3) {
            <input type="checkbox" class="replaceEolWithSpaceCheckbox" checked="checked">
            <input type="hidden" id="replaceEolWithSpace" name="replaceEolWithSpace" value="true">
        }
    </fieldset>
}

@exportDropdown(
    dataSetRouter.exportCsv(dataViewId, _, true, None, _, _),
    dataSetRouter.exportJson(dataViewId, _, _),
    Nil
) {
    <li role="separator" class="divider"></li>
    <li>
        <a href="#" data-toggle="modal" data-target="#exportTranSMARTDataModal">
            Export TranSMART Data
        </a>
    </li>
    <li>
        <a href="#" data-toggle="modal" data-target="#exportTranSMARTMappingModal">
            Export TranSMART Mapping
        </a>
    </li>
    <li role="separator" class="divider"></li>
    <li>
        <a href="#" onclick="exportCharts('image/png');">
            Export Charts as PNG
        </a>
    </li>
    <li>
        <a href="#" onclick="exportCharts('image/svg+xml');">
            Export Charts as SVG
        </a>
    </li>
    <li>
        <a href="#" onclick="exportCharts('application/pdf');">
            Export Charts as PDF
        </a>
    </li>
} {
    @exportModal("exportTranSMARTDataModal", "CSV TranSMART Data Export", dataSetRouter.exportTranSMARTData, transmartModalBody("\\t"))
    @exportModal("exportTranSMARTMappingModal", "CSV TranSMART Mapping Export", dataSetRouter.exportTranSMARTMapping, transmartModalBody("\\t"))
}

<script type="text/javascript">

    $(function() {
        $("#visitFieldTypeahead").click(function() {
            if(!$(this).hasClass("tt-input")) {
                activateTranSMARTFieldTypeaheads();
            }
        })
    })

    var chartsExportFileName = '@{dataSetName.replaceAllLiterally(".","_").replaceAllLiterally(" ", "_").toLowerCase + "-charts"}'

    function exportCharts(type) {
        var chartIds = $.map($(".chart-holder"), function (chart, i) {
            return chart.id;
        })

        Highcharts.exportCharts(chartIds, {type: type, filename: chartsExportFileName});
    }

    function activateTranSMARTFieldTypeaheads() {
        var showOption = @showFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id

        $.ajax({
            url: '@Html(dataSetRouter.allFieldNamesAndLabels.url)',
            success: function (fieldNameAndLabels) {
                var fieldNamesAndLabelsWithNone = fieldNameAndLabels.concat([["", "[None]"]])

                populateFieldTypeahed($('#exportTranSMARTDataModal #visitFieldTypeahead'), $('#exportTranSMARTDataModal #visitFieldName'), fieldNamesAndLabelsWithNone, showOption, true);
                populateFieldTypeahed($('#exportTranSMARTMappingModal #visitFieldTypeahead'), $('#exportTranSMARTMappingModal #visitFieldName'), fieldNamesAndLabelsWithNone, showOption, true);
            },
            error: showErrorResponse
         });
    }
</script>
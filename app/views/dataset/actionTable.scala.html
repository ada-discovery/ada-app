@import org.ada.server.models.Field
@import org.ada.server.models.Filter
@import org.ada.server.models.FilterShowFieldStyle
@import org.ada.server.models.DataSpaceMetaInfo
@import views.html.dataset.{widgetsScreen, dynamicFieldTable, dataSetExportDropdown}
@import views.html.table.dynamicTableJsImport
@import views.html.elements.labelValue
@import org.ada.web.controllers.dataset.DataSetWebContext._
@import org.ada.web.controllers.dataset.DataSetWebContext
@import org.ada.server.models.DataSetSetting

@(
    tableFieldNames: Seq[String],
    submitCall: Call,
    actionLabel: String,
    title: String,
    filterSpec: Filter,
    setting: DataSetSetting,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@extraActions = {
    <div class="pull-right">
        <button class="btn btn-info btn-sm" type="button" onclick="selectAndSubmit();">
            @actionLabel
         </button>
    </div>
}

@bottomResources = {

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.generateTableWithFilter
    )

    <script type="text/javascript">
        $(function () {
            activateAllFilters(function(filterOrId) {generateTable()});
            generateTable();
        });

        function selectAndSubmit() {
            var params = {}

            const ids = getSelectedRowIds($('#widgetsDiv .table-div'))
            $.each(ids, function (index, id) {
                params["selectedIds[" + index + "]"] = id
            })

            submit("post", '@submitCall', params)
        }

        function generateTable() {
            var fieldNames = [@Html(tableFieldNames.map("'" + _ + "'").mkString(","))]

            var filterOrId = $(".filter-div").multiFilter('getIdOrModel')
            var filterOrIdJson = JSON.stringify(filterOrId);

            if (fieldNames.length == 0) {
                showError("Table cannot be generated. No fields specified.");
            } else if (fieldNames.length > 50) {
                showError("Table cannot be generated. The maximum number of fields allowed is 50 but " + fieldNames.length + " were given.");
            } else {
                dataSetJsRoutes.org.ada.web.controllers.dataset.DataSetDispatcher.generateTableWithFilter(0, "", fieldNames, filterOrIdJson).ajax({
                    success: function (data) {
                        // filter
                        var filterElement = $(".filter-div");
                        filterElement.multiFilter("replaceModelAndPanel", data.filterModel, data.conditionPanel);

                        // table
                        var tableDiv = $("#widgetsDiv .table-div")
                        if (tableDiv.length == 0) {
                            $("#widgetsDiv").html("<div class='table-div'></div>")
                            tableDiv = $("#widgetsDiv .table-div")
                        }
                        tableDiv.html(data.table)
                    },
                    error: function (data) {
                        $("#widgetsDiv").html("")
                        showErrorResponse(data);
                    }
                })

                hideErrors();
            }
        }
    </script>
}

@inputElements = {}

@widgetsScreen(
    title,
    Seq(filterSpec),
    setting,
    dataSpaceMetaInfos,
    inputElements,
    Some(extraActions),
    bottomResources
)
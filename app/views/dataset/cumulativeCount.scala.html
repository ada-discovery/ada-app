@import models.FieldTypeId
@import models.Field
@import reactivemongo.play.json.BSONFormats._
@import views.html.layout.main
@import views.html.chart.highcharts.{highchartsJsImport, timeLineChart}
@import views.html.widget.{widgetPanel, widgetPanelJs}
@import views.html.dataview.dataViewSelectionModal
@import views.html.dataset.datasetSubNavWithJs
@import views.html.filter.{filter, filterWithJs}
@import play.api.libs.json.Json
@import java.util.Date
@import controllers.dataset.routes.{DataSetSettingController => dataSetSettingRoutes}
@import models.DataSpaceMetaInfo
@import controllers.DataSetWebContext
@import controllers.DataSetWebContext._

@(
    domainName: String,
    field: Option[Field],
    groupField: Option[Field],
    chartSpec: Option[Widget],
    filterSpec: models.Filter,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filterWithJs(
                Some(filterSpec),
                dataSetRouter.getCumulativeCount(field.map(_.name), groupField.map(_.name), filterSpec.conditionsOrId),
                Right(dataSetRouter.allFields),
                Some(Right(dataSetRouter.getCategoriesWithFieldsAsTreeNodes(filterSpec.conditionsOrId))),
                filterShowFieldStyle,
                Some(filterJsRouter),
                Some(filterRouter.idAndNames),
                "filterOrId"
            )
        </div>
        <div class="pull-right">
            <button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#dataViewSelectionModal" title="Add Cumulative Count To View">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To View
            </button>
        </div>
    </div>
    <hr/>
    @helper.form(action=dataSetRouter.getCumulativeCount(None, None, Left(Nil)), 'role -> "search", 'id -> "fieldForm") {
        <!-- hacky solution to pass data set param since it's ignored when passed as a part of the call in the form action -->
        <input type="hidden" name="dataSet" value="@context.dataSetId"/>
        <input type="hidden" name="filterOrId" value="@Json.toJson(filterSpec.conditionsOrId)"/>
        <div class="row">
            <div class="col-md-3">
                <input id="fieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@field.map(_.labelOrElseName)">
                <input id="fieldName" name="fieldName" type="hidden" value="@field.map(_.name)">
            </div>
            <div class="col-md-2" align="right">
                <label class="top-padded">Group by</label>
            </div>
            <div class="col-md-3">
                <input id="groupFieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@groupField.map(_.labelOrElseName)">
                <input id="groupFieldName" name="groupFieldName" type="hidden" value="@groupField.map(_.name)">
            </div>
        </div>
   }
}


@bottomResources = {
    @highchartsJsImport(true)
    @widgetPanelJs(Seq(chartSpec).flatten)
}

@main(Messages("cumulativeCount.title", domainName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNavWithJs()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("cumulativeCount.title", domainName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>
    <br/>
    <br/>

    @widgetPanel(Seq(chartSpec).flatten, 12)
    @dataViewSelectionModal("dataViewSelectionModal", dataViewRouter)
}

@helper.javascriptRouter("dataViewJsRoutes")(
    dataViewJsRouter.addCumulativeCount
)

<script type="text/javascript">
    $(function () {
        populateFieldTypeahedFromUrl(
            $('#fieldForm #fieldTypeahead'),
            $('#fieldForm #fieldName'),
            '@Html(dataSetRouter.fields(Seq(FieldTypeId.Date, FieldTypeId.Integer, FieldTypeId.Double)).url)',
            @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
        )

        populateFieldTypeahedFromUrl(
            $('#fieldForm #groupFieldTypeahead'),
            $('#fieldForm #groupFieldName'),
            '@Html(dataSetRouter.fields(Seq(FieldTypeId.Enum, FieldTypeId.String, FieldTypeId.Boolean)).url)',
            @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
        );

        $('#fieldForm #fieldTypeahead').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #groupFieldTypeahead').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #fieldTypeahead').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });

        $('#fieldForm #groupFieldTypeahead').keypress(function (e) {
            if (e.which == 13) {
                var groupFieldTypeahedVal = $('#fieldForm #groupFieldTypeahead').val();
                if (!groupFieldTypeahedVal)
                    $('#fieldForm #groupFieldName').val("")
                $('#fieldForm').submit();;
                return false;
            }
        });

        $("#dataViewSelectionModal #submitButton").on("click", addCumulativeCountToView)
    });

    function addCumulativeCountToView() {
        var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
        var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()
        var fieldName = $('#fieldForm #fieldName').val()
        var groupFieldName = $('#fieldForm #groupFieldName').val()
        if (groupFieldName == "")
            groupFieldName = null

        if (fieldName) {
            dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addCumulativeCount(dataViewId, fieldName, groupFieldName).ajax( {
                success: function() {
                    showMessage("Cumulative count for the field '" + fieldName + "' have been successfully added to the view '" + dataViewName + "'.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }
    }
</script>
@import controllers.dataset.DataSetRouter
@import models.DataSpaceMetaInfo
@import util.{getParamValue, matchesPath}
@import controllers.dataset.routes.{DataSpaceMetaInfoController => dataSpaceMetaInfoRoutes}
@import reactivemongo.bson.BSONObjectID

@(dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo])(implicit request: Request[_])

@listItem(call: Call, dataSetId: String, text: String) = {
    @defining(getParamValue(request.uri, "dataSet")) { reqDataSetId =>
        <li @if(reqDataSetId.isDefined && reqDataSetId.get.equals(dataSetId)) {class="inner-node active"} else {class="inner-node"}>
            <a href="@call">
                <ul class="list-inline">
                    <li>
                        <span class="glyphicon glyphicon-chevron-right"></span>
                    </li>
                    <li>
                        <h6>@text</h6>
                    </li>
                </ul>
            </a>
        </li>
    }
}

@topSpaceItem(spaceMetaInfo: DataSpaceMetaInfo) = {
    @defining(dataSpaceMetaInfoRoutes.get(spaceMetaInfo._id.get)) { call =>
        <li @if(matchesPath(call.url, request.uri, Some(3))) { class="dataspace top-node active" } else {class="dataspace top-node"} >
            <button type="button" class="btn btn-sm btn-default btn-dataspace-expand btn-dataspace-expand-top" data-toggle="collapse" data-target="#dataSets-@spaceMetaInfo._id.get.stringify">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
            </button>
            <a href="@call" class="float-left">
                <h4>@spaceMetaInfo.name</h4>
            </a>
        </li>
    }
}

@innerSpaceItem(spaceMetaInfo: DataSpaceMetaInfo) = {
    @defining(dataSpaceMetaInfoRoutes.get(spaceMetaInfo._id.get)) { call =>
        <li @if(matchesPath(call.url, request.uri, Some(3))) { class="dataspace inner-node active" } else {class="dataspace inner-node"} >
            <a href="@call">
                <ul class="list-inline">
                    <li class="btn-dataspace-expand">
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    </li>
                    <li>
                        <h6>@spaceMetaInfo.name</h6>
                    </li>
                </ul>
            </a>
        </li>
    }
}

@spaceItemWithDataSets(spaceMetaInfo: DataSpaceMetaInfo, topLevel: Boolean) = {
    @if(topLevel) {
        @topSpaceItem(spaceMetaInfo)
    } else {
        @innerSpaceItem(spaceMetaInfo)
    }
    <div id="dataSets-@{spaceMetaInfo._id.get.stringify}" class="collapse clear-left datasets-div sidebar-nav nav nav-pills nav-stacked">
        @spaceMetaInfo.dataSetMetaInfos.filter(!_.hide).sortBy(_.sortOrder).map { setMetaInfo =>
            @listItem(new DataSetRouter(setMetaInfo.id).getDefaultView, setMetaInfo.id, setMetaInfo.name)
        }
        @spaceMetaInfo.children.sortBy(_.sortOrder).map { childSpaceInfo =>
            @spaceItemWithDataSets(childSpaceInfo, false)
        }
    </div>
}

<!--
    <h3 class="text-muted" align="center">Studies</h3>
    <hr/>
-->

<ul class="sidebar-nav nav nav-pills nav-stacked">
    @dataSpaceMetaInfos.toSeq.sortBy(_.sortOrder).map { spaceMetaInfo =>
        @spaceItemWithDataSets(spaceMetaInfo, true)
    }
</ul>

<script type="text/javascript">
        $(".datasets-div").each(function () {
            if ($(this).find("li.inner-node.active").size() > 0) {
                $(this).addClass("in")
                updatePlusMinusIcon($(this).prev());
            }
        });
        $(".dataspace.active").each(function () {
            $(this).next().addClass("in");
            updatePlusMinusIcon($(this));
        });
        $('.btn-dataspace-expand').on('click', function () {
            updatePlusMinusIcon($(this));
        });

        function updatePlusMinusIcon(element) {
            var iconPlus = element.find("span.glyphicon-plus:first");
            var iconMinus = element.find("span.glyphicon-minus:first");
            if (iconPlus.length) {
                iconPlus.removeClass("glyphicon-plus");
                iconPlus.addClass("glyphicon-minus");
            } else {
                iconMinus.removeClass("glyphicon-minus");
                iconMinus.addClass("glyphicon-plus");
            }
        }
</script>
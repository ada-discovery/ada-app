@import reactivemongo.play.json.BSONFormats._
@import views.html.layout.main
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.elements._
@import views.html.dataset.{mlElements, mlResources, datasetSubNavWithJs}
@import play.api.i18n.Messages
@import models.DataSpaceMetaInfo
@import controllers.DataSetWebContext
@import controllers.DataSetWebContext._

@(
    dataSetName: String,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@bottomResources = {
    @mlResources(filterShowFieldStyle)
    @highchartsJsImport()

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.learnUnsupervised
    )

    <script type="text/javascript">
        $(function () {
            $.ajax({
                url: '@Html(controllers.ml.routes.UnsupervisedLearningController.idAndNames.url)',
                success: function (data) {
                    var typeaheadData = data.map(function (item, index) {
                        return {name: item._id.$oid, label: item.name};
                    });
                    populateFieldTypeahed(
                        $('#mlModelTypeahead'),
                        $('#mlModelId'),
                        typeaheadData,
                        @FilterShowFieldStyle.LabelsOnly.id
                    );
                }
            });

            $('#mlModelTypeahead, #filterNameTypeahead').keypress(function (e) {
                if (e.which == 13) {
                    launch();
                }
            });

            $('#launchButton').on('click', function() {
                launch();
            })
        });

        function launch() {
            var mlModelId = $("#mlModelId").val();
            var mlModelName = $("#mlModelTypeahead").val();

            $('#inputFieldNameDiv').dynamicTable('updateModelFromTable');
            var inputFieldNames = $("#inputFieldNameDiv").dynamicTable('getModel')

            var filterId = ($('#filterNameTypeahead').val()) ? $("#filterId").val() : null
            var filterOrId = (filterId) ? JSON.stringify({'$oid': filterId}) : "[]"

            $('#chartPanelDiv').hide();

            dataSetJsRoutes.controllers.dataset.DataSetDispatcher.learnUnsupervised(mlModelId, inputFieldNames, filterOrId).ajax( {
                success: function(scatters) {
                    showMessage("'" + mlModelName + "' unsupervised learning finished.")

                    $('#chartPanelDiv').html();
                    $.each(scatters, function(i, scatter) {
                        var div = "<div class='col-md-6'><div id='scatterDiv" + i + "' class='chart-holder'></div></div>"
                        $("#chartPanelDiv").append(div);
                        scatterChart("Scatter " + (i + 1), 'scatterDiv' + i, scatter.xAxisCaption, scatter.yAxisCaption, scatter.data, 500);
                    });

                    $('#chartPanelDiv').fadeIn('2000');
                },
                error: function(data){
                    showError( data.responseText );
                }
            });

            showMessage("Unsupervised learning using the ML model '" + mlModelName + "' launched.")
        }
    </script>
}

@main(Messages("unsupervisedLearning.title", dataSetName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNavWithJs()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("unsupervisedLearning.title", dataSetName)
        </h3>
    </div>

    @mlElements(dataSetRouter.allFields, false)

    <div id="chartPanelDiv" class="row">

    </div>
}
@import controllers.dataset.{DataSetRouter, FilterRouter, FilterJsRouter, DataViewRouter, DataViewJsRouter}
@import models.{FilterCondition, ChartSpec}
@import models.Field
@import reactivemongo.bson.BSONObjectID
@import reactivemongo.play.json.BSONFormats._
@import views.html.layout.main
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.chart.{chartPanel, chartPanelJs}
@import views.html.dataset.datasetSubNav
@import views.html.dataview.dataViewSelectionModal
@import play.api.libs.json.Json
@import play.api.mvc.Flash
@import play.api.i18n.Messages
@import controllers.dataset.routes.{DataSetSettingController => dataSetSettingRoutes}
@import models.DataSpaceMetaInfo

@(
    domainName: String,
    field: Option[Field],
    chartSpecs: Seq[ChartSpec],
    filterSpec: models.Filter,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    router: DataSetRouter,
    filterRouter: FilterRouter,
    filterJsRouter: FilterJsRouter,
    dataViewRouter: DataViewRouter,
    dataViewJsRouter: DataViewJsRouter,
    dataSetId: String,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit flash: Flash, msg: Messages, request: Request[_]
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filter(
                Some(filterSpec),
                router.getDistribution(field.map(_.name), filterSpec.conditionsOrId),
                Right(router.allFields),
                filterShowFieldStyle,
                Some(filterJsRouter),
                Some(filterRouter.idAndNames),
                "filterOrId"
            )
        </div>
        <div class="pull-right dropdown">
            <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a href="#" onclick="addDistribution();return false" data-toggle="tooltip" title="Add Distribution To View">
                        To Distributions
                    </a>
                </li>
                <li>
                    <a href="#" onclick="addBoxPlot();return false" data-toggle="tooltip" title="Add Box Plots To View">
                        To Box Plots
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <hr/>
    <div class="row">
        <div class="col-md-8">
            @helper.form(action=router.plainGetDistribution, 'role -> "search", 'id -> "fieldForm") {
                <!-- hacky solution to pass data set param since it's ignored when passed as a part of the call in the form action -->
                <input type="hidden" name="dataSet" value="@dataSetId"/>
                <input type="hidden" name="filterOrId" value="@filterSpec.conditionsOrId.fold(Json.toJson(_), _.stringify)"/>
                <input id="fieldTypeahead"class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@field.map(_.labelOrElseName)">
                <input id="fieldName" name="fieldName" type="hidden" value="@field.map(_.name)">
            }
        </div>
    </div>
}

@bottomResources = {
    @highchartsJsImport()
    @chartPanelJs(chartSpecs)
}

@main(Messages("distribution.title", domainName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNav()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("distribution.title", domainName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>
    <br/>
    <br/>

    @dataViewSelectionModal("dataViewSelectionModal", dataViewRouter, dataViewJsRouter)

    @chartPanel(chartSpecs, 12 / chartSpecs.size)
}

@helper.javascriptRouter("dataViewJsRoutes")(
    dataViewJsRouter.addDistributions,
    dataViewJsRouter.addBoxPlots
)

<script type="text/javascript">
    $(function () {
        populateFieldTypeahedFromUrl(
            $('#fieldForm #fieldTypeahead'),
            $('#fieldForm #fieldName'),
            '@Html(router.allFields.url)',
            @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
        )

        $('#fieldForm #fieldTypeahead').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #fieldTypeahead').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });
    });

    function addDistribution() {
        var handler = function(e) {
            addDistributionToView();
        };

        $("#dataViewSelectionModal #submitButton").one( "click", handler );
        $("#dataViewSelectionModal").modal('show');
    }

    function addBoxPlot() {
        var handler = function(e) {
            addBoxPlotToView();
        };

        $("#dataViewSelectionModal #submitButton").one( "click", handler );
        $("#dataViewSelectionModal").modal('show');
    }

    function addDistributionToView() {
        var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
        var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()
        var fieldName = $('#fieldForm #fieldName').val()

        if (fieldName) {
            dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addDistributions(dataViewId, [fieldName]).ajax( {
                success: function() {
                    showMessage("Distributions for the field '" + fieldName + "' have been successfully added to the view '" + dataViewName + "'.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }
    }

    function addBoxPlotToView() {
        var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
        var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()
        var fieldName = $('#fieldForm #fieldName').val()

        if (fieldName) {
            dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addBoxPlots(dataViewId, [fieldName]).ajax( {
                success: function() {
                    showMessage("Box plots for the field '" + fieldName + "' have been successfully added to the view '" + dataViewName + "'.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }
    }
</script>
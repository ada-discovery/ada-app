@import controllers.dataset.DataSetRouter
@import util.FilterSpec
@import views.html.layout.main
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.chart.{chartPanel, chartPanelJs}
@import views.html.dataset.datasetSubNav
@import util.ChartSpec
@import play.api.libs.json.Json
@import play.api.mvc.Flash
@import play.api.i18n.Messages
@import controllers.dataset.routes.{DataSetSettingController => dataSetSettingRoutes}

@(
    domainName: String,
    fieldName : String,
    chartSpec: ChartSpec,
    filterSpec: FilterSpec,
    router: DataSetRouter,
    dataSetId: String,
    fields: Seq[(String, Option[String])],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit flash: Flash, msg: Messages, request: Request[_]
)

@fieldNamesAsString = @{
    Html(fields.map(s => "\"" + s._1 + "\"").mkString(","))
}

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filter(filterSpec, router.getDistribution(Some(fieldName), filterSpec), Left(fields.map(_._1)))
        </div>
        <div class="pull-right">
            <a class="btn btn-info btn-sm" href="#" onclick="addToChartOverview();return false" data-toggle="tooltip" title="Add To Chart Overview">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To Chart Overview
            </a>
            <a class="btn btn-info btn-sm" href="#" onclick="addToOverviewTable();return false" data-toggle="tooltip" title="Add To Overview Table">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To Overview Table
            </a>
        </div>
    </div>
    <hr/>
    <div class="row">
        <div class="col-md-8">
            @helper.form(action=router.getDistribution(Some(fieldName), filterSpec), 'role -> "search", 'id -> "fieldForm") {
                <!-- hacky solution to pass data set param since it's ignored when passed as a part of the call in the form action -->
                <input type="hidden" name="dataSet" value="@dataSetId"/>
                <input type="hidden" name="filter" value="@Json.toJson(filterSpec)"/>
                <input id="fieldName" name="fieldName" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@fieldName">
            }
        </div>
    </div>
}

@bottomResources = {
    @highchartsJsImport()
    @chartPanelJs(Seq(chartSpec))
}

@main(Messages("distribution.title", domainName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNav()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("distribution.title", domainName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>
    <br/>
    <br/>
    @chartPanel(Seq(chartSpec), 12)
}

<script type="text/javascript" src="@dataSetSettingRoutes.jsRoutes"></script>
<script type="text/javascript">
    $(function () {
        populateTypeahead($('#fieldForm #fieldName'), [@fieldNamesAsString]);

        $('#fieldForm #fieldName').focus();

        $('#fieldForm #fieldName').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

    });

    function addToChartOverview() {
        var fieldName = $('#fieldForm #fieldName').val()
        if (fieldName) {
            jsRoutes.controllers.dataset.DataSetSettingController.addFieldsToChartOverview('@dataSetId', [fieldName]).ajax( {
                success: function() {
                    showMessage("Field '" + fieldName + "' has been successfully added to the chart overview.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }
    }

    function addToOverviewTable() {
        var fieldName = $('#fieldForm #fieldName').val()
        if (fieldName) {
            jsRoutes.controllers.dataset.DataSetSettingController.addFieldsToOverviewTable('@dataSetId', [fieldName]).ajax( {
                success: function() {
                    showMessage("Field '" + fieldName + "' has been successfully added to the overview table.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }
    }
</script>
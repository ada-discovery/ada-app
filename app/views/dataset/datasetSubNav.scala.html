@import util.{matchesPath, getParamValue}
@import controllers.dataset.{DataSetRouter, DataSetJsRouter, DictionaryRouter, CategoryRouter, FilterRouter, DataViewRouter}
@import controllers.dataset.routes.{DataSetSettingController => dataSetSettingRoutes}
@import reactivemongo.bson.BSONObjectID

@()(implicit request: Request[_])

@listItem(call: Call, text: String, matchPrefixDepth : Option[Int] = None) = {
    <li @if(matchesPath(call.url, request.uri, matchPrefixDepth)) {class="active"}>
        <a href="@call">@text</a>
    </li>
}

@defining(getParamValue(request.uri, "dataSet").get) { dataSetId =>
    @defining((
        new DataSetRouter(dataSetId),
        new DictionaryRouter(dataSetId),
        new CategoryRouter(dataSetId),
        new FilterRouter(dataSetId),
        new DataViewRouter(dataSetId),
        new DataSetJsRouter(dataSetId)
    )) { case (dataSetRouter, dictionaryRouter, categoryRouter, filterRouter, dataViewRouter, dataSetJsRouter) =>
        <ul class="nav nav-tabs">
            <li id="viewsDiv" class="dropdown" style="display:none">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Views<span class="caret"></span></a>
                <ul id="viewsDropdownDiv" class="dropdown-menu">
                </ul>
            </li>
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Analytics<span class="caret"></span></a>
                <ul class="dropdown-menu">
                    @listItem(dataSetRouter.plainGetDistribution, "Distribution", Some(2))
                    @listItem(dataSetRouter.plainGetScatterStats, "Scatter", Some(2))
                    @listItem(dataSetRouter.getCorrelations(Nil, Left(Nil)), "Correlation", Some(2))
                    @listItem(dataSetRouter.getDateCount(None, None, Left(Nil)), "Count by Date", Some(2))
                </ul>
            </li>
            @listItem(dictionaryRouter.plainList, "Dictionary", Some(2))
            @listItem(categoryRouter.plainList, "Category Tree", Some(2))
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">Setting<span class="caret"></span></a>
                <ul class="dropdown-menu">
                    @listItem(dataSetSettingRoutes.editForDataSet(dataSetId), "General", Some(2))
                    @listItem(filterRouter.plainList, "Filters", Some(2))
                    @listItem(dataViewRouter.plainList, "Views", Some(2))
                </ul>
            </li>
        </ul>

        <script type="text/javascript">


            var getViewUrl = '@{Html(dataSetRouter.getView(BSONObjectID.generate(), 0, "", Left(Nil)).url)}'
            var currentUrl = '@{Html(request.uri)}'

            var currentCoreUrl = getCoreURL(currentUrl)
            var currentParams = getQueryParams(currentUrl)

            var currentDataSetId = currentParams["dataSet"]
            var currentDataViewId = currentParams["dataViewId"]

            console.log("Current")
            console.log(currentCoreUrl)
            console.log(currentDataSetId)
            console.log(currentDataViewId)

            $.ajax({
                url: '@Html(dataViewRouter.idAndNames.url)',
                success: function (data) {
                    if (data.length > 0) {
                        $("#viewsDiv").show();
                        $.each(data, function(index, dataView) {
                            var dataSetId = getQueryParams(getViewUrl)["dataSet"]
                            var dataViewId = dataView._id.$oid

                            var params = {
                                dataViewId: dataViewId,
                                dataSet: dataSetId
                            };

                            var coreUrl = getCoreURL(getViewUrl)
                            var finalUrl = coreUrl + "?" + decodeURIComponent($.param(params));

                            console.log(dataView.name)
                            console.log(coreUrl)
                            console.log(dataSetId)
                            console.log(dataViewId)

                            if (currentCoreUrl == coreUrl && dataViewId == currentDataViewId && dataSetId && currentDataSetId) {
                                $("#viewsDropdownDiv").append("<li class='active'><a href='" + finalUrl + "'>" + dataView.name + "</a></li>")
                            } else {
                                $("#viewsDropdownDiv").append("<li><a href='" + finalUrl + "'>" + dataView.name + "</a></li>")
                            }
                        })
                    }
                    propagateActive();
                }
            });

            function propagateActive() {
                $("li.dropdown").each(function() {
                    if($(this).find("li.active").size() > 0)
                        $(this).addClass("active")
                });
            }
        </script>
    }
}
@import views.html.layout
@import views.html.dataset.{filterChartPanel, datasetSubNav, datasetMenu, displayJsonModal}
@import views.html.chart.chartPanelJs
@import views.html.chart.highcharts.{highchartsJsImport, highchartsJsImportForBulkExport}
@import views.html.table.paginatedJsonTable
@import views.html.dataset.exportDataSetDropdown
@import views.html.filter.filter
@import reactivemongo.bson.BSONObjectID
@import play.api.libs.json.{JsValue, JsObject}
@import models.DataSpaceMetaInfo
@import models.FieldTypeId
@import util.FieldTypeRenderer
@import be.objectify.deadbolt.scala.views.html.restrict
@import models.security.SecurityRole
@import controllers.DataSetWebContext
@import controllers.DataSetWebContext._
@import controllers.dataset.DataSetViewData
@import reactivemongo.play.json.BSONFormats._
@import models.FilterCondition.filterConditionFormat
@import dataaccess.EitherFormat
@import play.api.libs.json.Json
@import play.api.libs.json.JsArray

@(
    dataSetName : String,
    dataViewId: BSONObjectID,
    dataViewName: String,
    viewParts: Seq[DataSetViewData],
    chartGridElementWidth: Int,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @if(viewParts.size == 1) {
                @viewFilter(viewParts.head, 0)
            }
        </div>
        <div class="pull-right">
            <ul class="list-inline">
                <li>
                    @exportMenu(viewParts.head)
                </li>
                <li>
                    @restrict(roles = List(Array(SecurityRole.admin))) {
                        <div class="dropdown">
                            <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="@{dataViewRouter.getAndShowView(dataViewId)}">
                                        Edit View
                                    </a>
                                </li>
                                <li>
                                    <a href="#" onclick="saveFilterToView()">
                                        Save Filter To View
                                    </a>
                                </li>
                            </ul>
                        </div>
                     }
                </li>
            </ul>
        </div>
    </div>
}

@genJsonRender(id: BSONObjectID, fieldName: String)(linkTitle: Html) = {
    <a href="#" onclick="showFieldValue('@id.stringify', '@fieldName');" class="jsonModalLink">
        @linkTitle
    </a>
}

@jsonRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Json</b>
    }
}

@arrayRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Array</b>
    }
}

@jsonArrayRender(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @genJsonRender(id, fieldName) {
        <b>Json Array</b>
    }
}

@render(fun: Option[JsValue] => Html)(id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) = {
    @fun(jsValue)
}

@inputFilterConditionsOrIds = @{
    viewParts.map(_.page.filter.map(_.conditionsOrId).getOrElse(Left(Nil)))
}

@exportMenu(viewData: DataSetViewData) = @{
    exportDataSetDropdown(
        viewData.page.filterConditions,
        dataSetRouter.exportCsv(dataViewId, _, true, None, _, _),
        dataSetRouter.exportJson(dataViewId, _, _),
        dataSetRouter.exportTranSMARTData,
        dataSetRouter.exportTranSMARTMapping
    )
}

@table(viewData: DataSetViewData, index: Int) = @{
    paginatedJsonTable(
        viewData.page, { (page: Int, orderBy: String) =>
            dataSetRouter.getView(
                dataViewId,
                viewParts.zipWithIndex.map { case (viewPart, i) =>
                    if (i == index)
                        TablePage(page, orderBy)
                    else
                        viewPart.page.toTablePage
                },
                inputFilterConditionsOrIds,
                true
            )
        },
        Some(viewData.tableFields.map{ field =>
            field.label.map( fieldLabel => (field.name, fieldLabel))
        }.flatten.toMap),
        Some(viewData.tableFields.map(_.name).toSeq),
        Some({ item : JsObject => dataSetRouter.get((item \ "_id").as[BSONObjectID])}),
        Some(viewData.tableFields.map{ field =>
            if (field.isArray) {
                if(field.fieldType == FieldTypeId.Json)
                    Some(field.name, jsonArrayRender(_, _, _))
                else
                    Some(field.name, arrayRender(_, _, _))
            } else
                if (field.fieldType == FieldTypeId.Json)
                    Some(field.name, jsonRender(_, _, _))
                else {
                    val renderer = FieldTypeRenderer(field)
                    Some(field.name, { (id: BSONObjectID, fieldName: String, jsValue: Option[JsValue]) => renderer(jsValue) })
                }
        }.flatten.toMap)
    )
}

@createSubmissionJsonJsFunction(index: Int) = {
    function(conditions, filterId) {
        var filterOrIds = JSON.parse('@{Html(Json.stringify(FilterCondition.filterOrIdsToJson(inputFilterConditionsOrIds)))}');

        filterOrIds[@index] = (filterId) ? {'$oid': filterId} : conditions;

        return {"filterOrIds": JSON.stringify(filterOrIds)};
    }
}

@viewFilter(viewPart: DataSetViewData, index: Int) = {
    @filter(
        viewPart.page.filter,
        dataSetRouter.getView(dataViewId, Nil, Nil, true),
        Right(dataSetRouter.allFields),
        Some(Right(categoryRouter.getCategoriesWithFieldsAsTreeNodes)),
        filterShowFieldStyle,
        Some(filterJsRouter),
        Some(filterRouter.idAndNames),
        "filterOrIds",
        s"filter$index",
        Some(createSubmissionJsonJsFunction(index))
    )
}

@tables = {
    <div class="row vertical-divider">
        @viewParts.zipWithIndex.map { case (viewPart, index) =>
            <div class="col-md-@{12 / viewParts.size}">
                @table(viewPart, index)
            </div>
        }
    </div>
}

@filters = {
    <div class="row vertical-divider">
        @viewParts.zipWithIndex.map { case (viewPart, index) =>
            <div class="col-md-@{12 / viewParts.size}">
                <div class="row">
                    <div class="col-md-7">
                        <ul class="list-inline">
                            <li>Count:</li>
                            <li><h3>@viewPart.page.total</h3></li>
                        </ul>
                    </div>
<!--
                    <div class="col-md-5">
                        <ul class="list-inline">
                            <li>
                                @exportMenu(viewPart)
                            </li>
                        </ul>
                    </div>
-->
                </div>
                <div class="row">
                    <div class="col-md-10">
                        @viewFilter(viewPart, index)
                    </div>
                </div>
            </div>
        }
    </div>
}

@charts = {
    <div class="row vertical-divider">
        @viewParts.zipWithIndex.map { case (viewPart, index) =>
            <div class="col-md-@{12 / viewParts.size}">
                @filterChartPanel(s"filter$index", viewPart.fieldChartSpecs, chartGridElementWidth)
            </div>
        }
    </div>
}

@filtersAndCharts = {
    @filters
    <hr/>
    @charts
}

@bottomResources = {
    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.getFieldValue
    )
    @helper.javascriptRouter("dataViewJsRoutes")(
        dataViewJsRouter.saveFilter
    )
    @displayJsonModal("jsonModal", None)
    @highchartsJsImport()
    @highchartsJsImportForBulkExport()

    @viewParts.map { viewPart =>
        @chartPanelJs(viewPart.fieldChartSpecs.map(_.chartSpec))
    }
    <script type="text/javascript">
        $(function () {
            $(".jsonModalLink").click(function(event) {
                event.stopPropagation();
            })
        })

        function showFieldValue(id, fieldName) {
            dataSetJsRoutes.controllers.dataset.DataSetDispatcher.getFieldValue(id, fieldName).ajax( {
                success: function(data) {
                    var json = JSON.stringify(data, null, "\t").replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;').replace(/\n/g, '</br>')
                    var size = data.length
                    var title = "JSON Browser"
                    if (size)
                        title = title + ": Array (Size " + size + ")"

                    $('#jsonModal #jsonModalBody').html(json)
                    $('#jsonModal .modal-title').html(title)
                    $('#jsonModal').modal();
                },
                error: function(data){
                    showError(data.responseText);
                }
            });
        }

        function getFilterOrId(index) {
            var filterOrId = $("#filter" + index).multiFilter('getJsonFilterId')
            if (!filterOrId) {
                filterOrId = $("#filter" + index).multiFilter('getJsonConditions')
            }
            return filterOrId;
        }

        function saveFilterToView() {
            var filterOrIds = [
                @viewParts.zipWithIndex.map{ case (viewPart, index) => getFilterOrId(@index)}.mkString(",")
            ];

            dataViewJsRoutes.controllers.dataset.DataViewDispatcher.saveFilter(
                "@{dataViewId.stringify}",
                 JSON.stringify(filterOrIds)
            ).ajax( {
                success: function() {
                    showMessage("Filter successfully added to the view.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }
    </script>
}

@layout.list(
    dataSetName + " Item",
    Some(dataSetName + " ("+ dataViewName + ")"),
    viewParts.map(_.page.total).sum,
    Some(actions),
    tables,
    if (viewParts.size == 1) {
        if (viewParts.head.fieldChartSpecs.nonEmpty)
            Some(charts)
        else
            None
    } else {
        Some(filtersAndCharts)
    },
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav()),
    None,
    Some(bottomResources)
)
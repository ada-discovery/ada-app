@import views.html.layout
@import views.html.dataset.{fixedTableRow, dataSetFilterValuesUpdate, datasetMenu, datasetSubNav, datasetSubNavJs}
@import views.html.widget.{widgetPanelAjaxLoadJs, widgetPanelJs}
@import views.html.chart.highcharts.{highchartsJsImport, highchartsJsImportForBulkExport}
@import views.html.dataset.{viewTables, viewTablesJs}
@import views.html.dataset.exportDataSetDropdown
@import views.html.filter.{filter, filterJs}
@import reactivemongo.bson.BSONObjectID
@import models.DataSpaceMetaInfo
@import controllers.FilterConditionExtraFormats.eitherFilterOrIdFormat
@import controllers.dataset.DataSetWebContext._
@import controllers.dataset.{DataSetWebContext, TableViewData}
@import play.api.libs.json.Json

@(
    dataSetName : String,
    dataViewId: BSONObjectID,
    dataViewName: String,
    tableViewParts: Seq[TableViewData],
    widgetsCallbackId: String,
    widgetGridElementWidth: Int,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    canEditView: Boolean = false,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@actions = {
    <div class="row">
        @if(tableViewParts.size == 1) {
            <div class="col-md-10">
                @fixedTableRow("filtersTr") {
                    <td>
                        @viewFilter(tableViewParts.head, 0)
                    </td>
                }
            </div>
        }
        <div class="pull-right">
            <ul class="list-inline">
                <li>
                    @exportMenu("filter0")
                </li>
                <li>
                    @if(canEditView) {
                        <div class="dropdown">
                            <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="@{dataViewRouter.getAndShowView(dataViewId)}">
                                        Edit View
                                    </a>
                                </li>
                                <li>
                                    <a href="#" onclick="saveFilterToView()">
                                        Save Filter To View
                                    </a>
                                </li>
                                @*<li>*@
                                    @*<a href="#" onclick="addNewColumn()">*@
                                        @*Add New Column/Filter*@
                                    @*</a>*@
                                @*</li>*@
                            </ul>
                        </div>
                     }
                </li>
            </ul>
        </div>
    </div>
}

@inputFilterConditionsOrIds = @{
    tableViewParts.map(_.filter.map(_.conditionsOrId).getOrElse(Left(Nil)))
}

@exportMenu(filterId: String) = @{
    exportDataSetDropdown(
        dataSetName,
        filterId,
        dataSetRouter.exportCsv(dataViewId, _, true, None, _, _),
        dataSetRouter.exportJson(dataViewId, _, _),
        dataSetRouter.exportTranSMARTData,
        dataSetRouter.exportTranSMARTMapping
    )
}

@createSubmissionJsonJsFunction(index: Int) = {
    function(conditions, filterId) {
        var filterOrIds = JSON.parse('@{Html(Json.stringify(Json.toJson(inputFilterConditionsOrIds)))}');

        filterOrIds[@index] = (filterId) ? {'$oid': filterId} : conditions;

        return {"filterOrIds": JSON.stringify(filterOrIds)};
    }
}

@filterRefreshAjaxFun(index: Int) = {
    function(url, params) {
        var coreUrl = getCoreURL(url);
        var index = @index

        var totalCount = viewTotalCounts.reduce(function (a, b) {return a + b;}, 0);
        params["oldCountDiff"] = totalCount - viewTotalCounts[index];
        $.ajax({
            url: coreUrl,
            data: params,
            success: function(data) {
                $("#tableDiv" + index).html(data.table);

                // filter
                var filterElement = $("#filtersTr").find(".filter-div:eq(" + index + ")")
                filterElement.find("#conditionPanel").replaceWith(data.conditionPanel)
                filterElement.multiFilter("initConditionButtons")
                filterElement.multiFilter("setModel", data.filterModel)

                // count
                $("#count" + index).html("<h3>" + data.count + "</h3>");
                viewTotalCounts[index] = data.count;

                // page header
                $(".page-header").html("<h3>" + data.pageHeader + "</h3>");

                // widgets
                var widgetsDiv = $("#widgetsTr > td:eq(" + index + ")")
                updateWidgetsFromCallback(data.widgetsCallbackId, widgetsDiv, filterElement, @widgetGridElementWidth)
            },
            error: function(data) {
                showErrorResponse(data)
            }
        });
    }
}

@viewFilter(viewPart: TableViewData, index: Int) = {
    @filter(
        viewPart.filter,
        Some(Right(dataSetRouter.getCategoriesWithFieldsAsTreeNodes(viewPart.filter.map(_.conditionsOrId).getOrElse(Left(Nil))))),
        filterShowFieldStyle,
        Some(filterJsRouter),
        Some(filterRouter.idAndNamesAccessible),
        s"filter$index"
    )
}

@viewFilterJs(viewPart: TableViewData, index: Int) = {
    @filterJs(
        viewPart.filter,
        dataSetRouter.getViewElementsAndWidgetCallback(dataViewId, viewPart.page.orderBy, Left(Nil), None),
        Right(dataSetRouter.allFieldNamesAndLabels),
        Some(filterJsRouter),
        Some(filterRouter.idAndNamesAccessible),
        "filterOrId",
        s"filter$index",
        None,
        Some("categoryTree"),
        Some(filterRefreshAjaxFun(index))
    )
}

@filters = {
    @fixedTableRow("filtersTr"){
        @tableViewParts.zipWithIndex.map { case (viewPart, index) =>
            <td>
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-7">
                            <ul class="list-inline">
                                <li>Count:</li>
                                <li id="count@index"><h3>@viewPart.page.total</h3></li>
                            </ul>
                        </div>
                    </div>
                    <div class="row">
                        @if(tableViewParts.size == 1) {
                            <div class="col-md-10">
                                @viewFilter(viewPart, index)
                            </div>
                        } else {
                            <div class="col-md-12">
                                @viewFilter(viewPart, index)
                            </div>
                        }
                    </div>
                </div>
            </td>
        }
    }
}

@widgets = {
    @fixedTableRow("widgetsTr") {
        <td>
            <div class='spinner' style='margin: auto; margin-bottom: 20px'></div>
        </td>
    }
}

@filtersAndWidgets = {
    @filters
    <hr/>
    @widgets
}

@bottomResources = {
    @highchartsJsImport()

    @helper.javascriptRouter("dataViewJsRoutes")(
        dataViewJsRouter.saveFilter
    )

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.getWidgets
    )

    @widgetPanelAjaxLoadJs(widgetsCallbackId, widgetGridElementWidth)

    @datasetSubNavJs()

    @tableViewParts.zipWithIndex.map { case (viewPart, index) =>
        @viewFilterJs(viewPart, index)
    }

    @viewTablesJs(dataSetJsRouter)

    <script type="text/javascript">
        var viewTotalCounts = [@tableViewParts.map(_.page.total).mkString(",")]

        function saveFilterToView() {
            var filterElements = $("#filtersTr").find(".filter-div").toArray();

            var filterOrIds = filterElements.map(function(filterElement, index) {
                return $(filterElement).multiFilter('getIdOrModel');
            });

            dataViewJsRoutes.controllers.dataset.DataViewDispatcher.saveFilter(
                "@{dataViewId.stringify}",
                 JSON.stringify(filterOrIds)
            ).ajax( {
                success: function() {
                    showMessage("Filter successfully added to the view.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }

        function updateWidgetsFromCallback(callbackId, widgetsDiv, filterElement, elementWidth) {
            widgetsDiv.html("")
            addSpinner(widgetsDiv, "margin-bottom: 20px;")

            dataSetJsRoutes.controllers.dataset.DataSetDispatcher.getWidgets().ajax( {
                data: {
                    "callbackId": callbackId
                },
                success: function(data) {
                    var widgets = data[0]

//                    var widgetHolders = widgetsDiv.find(".chart-holder")

                    var row = $("<div class='row'>")
                    $.each(widgets, function (j, widget) {
                        row.append(widgetDiv(widget, elementWidth))
                    })
                    widgetsDiv.html(row)
                    $.each(widgets, function (j, widget) {
                        genericWidget(widget, filterElement)
                    })
//                    $.each(widgetHolders, function(i, widgetHolder){
//                        genericWidgetForElement(widgetHolder.id, widgets[i], filterElement)
//                    })
                },
                error: function(data) {
                    showErrorResponse(data)
                }
            });
        }

        function addNewColumn() {
            // filter
            var filterTd = $("<td>")
            var filterDiv = $("<div class='col-md-12'>")
            var filterRow = $("<div class='row'>")

            filterTd.append(filterDiv)
            filterDiv.append(filterRow)
            $("#filtersTr").append(filterTd)

            // widgets
            var widgetTd = $("<td>")
            var widgetDiv = $("<div class='col-md-12'>")
            var widgetRow = $("<div class='row'>")

            widgetTd.append(widgetDiv)
            widgetDiv.append(widgetRow)
            $("#widgetsTr").append(widgetTd)

            // table
            var tabelTd = $("<td>")
            $("#tabelsTr").append(tabelTd)
        }
    </script>

    @tableViewParts.zipWithIndex.map { case (_, index) => @dataSetFilterValuesUpdate("filter" + index) }

    @highchartsJsImportForBulkExport()
}

@layout.list(
    dataSetName + " Item",
    Some(dataSetName + " ("+ dataViewName + ")"),
    tableViewParts.map(_.page.total).sum,
    Some(actions),
    if(tableViewParts.exists(_.tableFields.nonEmpty)) {
        Some(viewTables(dataViewId, tableViewParts, dataSetRouter))
    } else {
        None
    },
    if (tableViewParts.size == 1) {
        Some(widgets)
    } else {
        Some(filtersAndWidgets)
    },
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav()),
    None,
    Some(bottomResources)
)
@import views.html.layout
@import views.html.dataset.{datasetSubNav, datasetSubNavJs, datasetMenu, dataSetFilterValuesUpdate}
@import views.html.widget.{widgetPanelJs, widgetPanelAjaxLoadJs}
@import views.html.chart.highcharts.{highchartsJsImport, highchartsJsImportForBulkExport}
@import views.html.dataset.{viewTables, viewTablesJs}
@import views.html.dataset.exportDataSetDropdown
@import views.html.filter.{filter, filterJs}
@import reactivemongo.bson.BSONObjectID
@import models.DataSpaceMetaInfo
@import be.objectify.deadbolt.scala.views.html.restrict
@import models.security.SecurityRole
@import controllers.DataSetWebContext
@import controllers.DataSetWebContext._
@import controllers.dataset.TableViewData
@import play.api.libs.json.Json

@(
    dataSetName : String,
    dataViewId: BSONObjectID,
    dataViewName: String,
    tableViewParts: Seq[TableViewData],
    widgetCallbackId: String,
    widgetGridElementWidth: Int,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    canEditView: Boolean = false,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @if(tableViewParts.size == 1) {
                @viewFilter(tableViewParts.head, 0)
            }
        </div>
        <div class="pull-right">
            <ul class="list-inline">
                <li>
                    @exportMenu(tableViewParts.head)
                </li>
                <li>
                    @if(canEditView) {
                        <div class="dropdown">
                            <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="@{dataViewRouter.getAndShowView(dataViewId)}">
                                        Edit View
                                    </a>
                                </li>
                                <li>
                                    <a href="#" onclick="saveFilterToView()">
                                        Save Filter To View
                                    </a>
                                </li>
                            </ul>
                        </div>
                     }
                </li>
            </ul>
        </div>
    </div>
}

@inputFilterConditionsOrIds = @{
    tableViewParts.map(_.page.filter.map(_.conditionsOrId).getOrElse(Left(Nil)))
}

@exportMenu(viewData: TableViewData) = @{
    exportDataSetDropdown(
        viewData.page.filterConditions,
        dataSetRouter.exportCsv(dataViewId, _, true, None, _, _),
        dataSetRouter.exportJson(dataViewId, _, _),
        dataSetRouter.exportTranSMARTData,
        dataSetRouter.exportTranSMARTMapping
    )
}

@createSubmissionJsonJsFunction(index: Int) = {
    function(conditions, filterId) {
        var filterOrIds = JSON.parse('@{Html(Json.stringify(FilterCondition.filterOrIdsToJson(inputFilterConditionsOrIds)))}');

        filterOrIds[@index] = (filterId) ? {'$oid': filterId} : conditions;

        return {"filterOrIds": JSON.stringify(filterOrIds)};
    }
}

@viewFilter(viewPart: TableViewData, index: Int) = {
    @filter(
        viewPart.page.filter,
        Some(Right(dataSetRouter.getCategoriesWithFieldsAsTreeNodes(viewPart.page.filter.map(_.conditionsOrId).getOrElse(Left(Nil))))),
        filterShowFieldStyle,
        Some(filterJsRouter),
        Some(filterRouter.idAndNames),
        s"filter$index"
    )
}

@viewFilterJs(viewPart: TableViewData, index: Int) = {
    @filterJs(
        viewPart.page.filter,
        dataSetRouter.getView(dataViewId, Nil, Nil, true),
        Right(dataSetRouter.allFieldNamesAndLabels),
        Some(filterJsRouter),
        Some(filterRouter.idAndNames),
        "filterOrIds",
        s"filter$index",
        Some(createSubmissionJsonJsFunction(index)),
        Some("categoryTree")
    )
}

@filters = {
    <div class="row vertical-divider">
        @tableViewParts.zipWithIndex.map { case (viewPart, index) =>
            <div class="col-md-@{12 / tableViewParts.size}">
                <div class="row">
                    <div class="col-md-7">
                        <ul class="list-inline">
                            <li>Count:</li>
                            <li><h3>@viewPart.page.total</h3></li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-10">
                        @viewFilter(viewPart, index)
                    </div>
                </div>
            </div>
        }
    </div>
}

@widgetsDiv = {
    <div id="widgetsDiv" class="row vertical-divider">
        <div class='spinner' style='margin: auto; margin-bottom: 20px'></div>
    </div>
}

@filtersAndWidgets = {
    @filters
    <hr/>
    @widgetsDiv
}

@bottomResources = {
    @highchartsJsImport()
    @widgetPanelAjaxLoadJs(widgetCallbackId, widgetGridElementWidth, dataSetJsRouter)

    @datasetSubNavJs()

    @helper.javascriptRouter("dataViewJsRoutes")(
        dataViewJsRouter.saveFilter
    )

    @helper.javascriptRouter("dataSetJsRoutes2")(
        dataSetJsRouter.getFieldTypeWithAllowedValues
    )

    @tableViewParts.zipWithIndex.map { case (viewPart, index) =>
        @viewFilterJs(viewPart, index)
    }

    @viewTablesJs(dataSetJsRouter)

    <script type="text/javascript">
        function getFilterOrId(index) {
            var filterOrId = $("#filter" + index).multiFilter('getJsonFilterId')
            if (!filterOrId) {
                filterOrId = $("#filter" + index).multiFilter('getJsonConditions')
            }
            return filterOrId;
        }

        function saveFilterToView() {
            var filterOrIds = [
                @tableViewParts.zipWithIndex.map{ case (_, index) => getFilterOrId(@index)}.mkString(",")
            ];

            dataViewJsRoutes.controllers.dataset.DataViewDispatcher.saveFilter(
                "@{dataViewId.stringify}",
                 JSON.stringify(filterOrIds)
            ).ajax( {
                success: function() {
                    showMessage("Filter successfully added to the view.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }
    </script>

    @tableViewParts.zipWithIndex.map { case (_, index) => @dataSetFilterValuesUpdate("filter" + index) }

    @highchartsJsImportForBulkExport()
}

@layout.list(
    dataSetName + " Item",
    Some(dataSetName + " ("+ dataViewName + ")"),
    tableViewParts.map(_.page.total).sum,
    Some(actions),
    viewTables(dataViewId, tableViewParts, dataSetRouter),
    if (tableViewParts.size == 1) {
        Some(widgetsDiv)
    } else {
        Some(filtersAndWidgets)
    },
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav()),
    None,
    Some(bottomResources)
)
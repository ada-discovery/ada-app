@import views.html.layout
@import views.html.dataset.{dataSetFilterValuesUpdate, datasetMenu, datasetSubNav, datasetSubNavJs}
@import views.html.widget.{widgetPanelAjaxLoadJs, widgetPanelJs}
@import views.html.chart.highcharts.{highchartsJsImport, highchartsJsImportForBulkExport}
@import views.html.dataset.{viewTables, viewTablesJs}
@import views.html.dataset.exportDataSetDropdown
@import views.html.filter.{filter, filterJs}
@import reactivemongo.bson.BSONObjectID
@import models.DataSpaceMetaInfo
@import controllers.FilterConditionExtraFormats.eitherFilterOrIdFormat
@import controllers.dataset.DataSetWebContext._
@import controllers.dataset.{DataSetWebContext, TableViewData}
@import play.api.libs.json.Json

@(
    dataSetName : String,
    dataViewId: BSONObjectID,
    dataViewName: String,
    tableViewParts: Seq[TableViewData],
    widgetsCallbackId: String,
    widgetGridElementWidth: Int,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    canEditView: Boolean = false,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@actions = {
    <div class="row">
        @if(tableViewParts.size == 1) {
            <div class="col-md-10">
                @viewFilter(tableViewParts.head, 0)
            </div>
        }
        <div class="pull-right">
            <ul class="list-inline">
                <li>
                    @exportMenu("filter0")
                </li>
                <li>
                    @if(canEditView) {
                        <div class="dropdown">
                            <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a href="@{dataViewRouter.getAndShowView(dataViewId)}">
                                        Edit View
                                    </a>
                                </li>
                                <li>
                                    <a href="#" onclick="saveFilterToView()">
                                        Save Filter To View
                                    </a>
                                </li>
                            </ul>
                        </div>
                     }
                </li>
            </ul>
        </div>
    </div>
}

@inputFilterConditionsOrIds = @{
    tableViewParts.map(_.filter.map(_.conditionsOrId).getOrElse(Left(Nil)))
}

@exportMenu(filterId: String) = @{
    exportDataSetDropdown(
        dataSetName,
        filterId,
        dataSetRouter.exportCsv(dataViewId, _, true, None, _, _),
        dataSetRouter.exportJson(dataViewId, _, _),
        dataSetRouter.exportTranSMARTData,
        dataSetRouter.exportTranSMARTMapping
    )
}

@createSubmissionJsonJsFunction(index: Int) = {
    function(conditions, filterId) {
        var filterOrIds = JSON.parse('@{Html(Json.stringify(Json.toJson(inputFilterConditionsOrIds)))}');

        filterOrIds[@index] = (filterId) ? {'$oid': filterId} : conditions;

        return {"filterOrIds": JSON.stringify(filterOrIds)};
    }
}

@filterRefreshAjaxFun(index: Int) = {
    function(url, params) {
        var coreUrl = getCoreURL(url);
        var index = @index

        var totalCount = viewTotalCounts.reduce(function (a, b) {return a + b;}, 0);
        params["oldCountDiff"] = totalCount - viewTotalCounts[index];
        $.ajax({
            url: coreUrl,
            data: params,
            success: function(data) {
                $("#tableDiv" + index).html(data.table);
                $("#filter" + index).find("#conditionPanel").replaceWith(data.conditionPanel)

                $("#filter" + index).multiFilter("initConditionButtons")
                $("#filter" + index).multiFilter("setModel", data.filterModel)

                $("#count" + index).html("<h3>" + data.count + "</h3>");
                $(".page-header").html("<h3>" + data.pageHeader + "</h3>");
                viewTotalCounts[index] = data.count;

                updateWidgetsFromCallback(data.widgetsCallbackId, index, @widgetGridElementWidth)
            },
            error: function(data) {
                showErrorResponse(data)
            }
        });
    }
}

@viewFilter(viewPart: TableViewData, index: Int) = {
    @filter(
        viewPart.filter,
        Some(Right(dataSetRouter.getCategoriesWithFieldsAsTreeNodes(viewPart.filter.map(_.conditionsOrId).getOrElse(Left(Nil))))),
        filterShowFieldStyle,
        Some(filterJsRouter),
        Some(filterRouter.idAndNamesAccessible),
        s"filter$index"
    )
}

@viewFilterJs(viewPart: TableViewData, index: Int) = {
    @filterJs(
        viewPart.filter,
        dataSetRouter.getViewElementsAndWidgetCallback(dataViewId, viewPart.page.orderBy, Left(Nil), None),
        Right(dataSetRouter.allFieldNamesAndLabels),
        Some(filterJsRouter),
        Some(filterRouter.idAndNamesAccessible),
        "filterOrId",
        s"filter$index",
        None,
        Some("categoryTree"),
        Some(filterRefreshAjaxFun(index))
    )
}

@filters = {
    <div class="row vertical-divider">
        @tableViewParts.zipWithIndex.map { case (viewPart, index) =>
            <div class="col-md-@{12 / tableViewParts.size}">
                <div class="row">
                    <div class="col-md-7">
                        <ul class="list-inline">
                            <li>Count:</li>
                            <li id="count@index"><h3>@viewPart.page.total</h3></li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    @if(tableViewParts.size == 1) {
                        <div class="col-md-10">
                           @viewFilter(viewPart, index)
                        </div>
                    } else {
                        <div class="col-md-12">
                            @viewFilter(viewPart, index)
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

@widgetsDiv = {
    <div id="widgetsDiv" class="row vertical-divider">
        <div class='spinner' style='margin: auto; margin-bottom: 20px'></div>
    </div>
}

@filtersAndWidgets = {
    @filters
    <hr/>
    @widgetsDiv
}

@bottomResources = {
    @highchartsJsImport()

    @helper.javascriptRouter("dataViewJsRoutes")(
        dataViewJsRouter.saveFilter
    )

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.getWidgets
    )

    @widgetPanelAjaxLoadJs(widgetsCallbackId, widgetGridElementWidth)

    @datasetSubNavJs()

    @tableViewParts.zipWithIndex.map { case (viewPart, index) =>
        @viewFilterJs(viewPart, index)
    }

    @viewTablesJs(dataSetJsRouter)

    <script type="text/javascript">
        var viewTotalCounts = [@tableViewParts.map(_.page.total).mkString(",")]

        function getFilterOrId(index) {
            return $("#filter" + index).multiFilter('getIdOrModel');
        }

        function saveFilterToView() {
            var filterOrIds = [
                @tableViewParts.zipWithIndex.map{ case (_, index) => getFilterOrId(@index)}.mkString(",")
            ];

            dataViewJsRoutes.controllers.dataset.DataViewDispatcher.saveFilter(
                "@{dataViewId.stringify}",
                 JSON.stringify(filterOrIds)
            ).ajax( {
                success: function() {
                    showMessage("Filter successfully added to the view.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        }

        function updateWidgetsFromCallback(callbackId, index, elementWidth) {
            var widgetsDiv = $("#widgetsDiv" + index)
            widgetsDiv.html("")
            addSpinner(widgetsDiv, "margin-bottom: 20px;")

            dataSetJsRoutes.controllers.dataset.DataSetDispatcher.getWidgets().ajax( {
                data: {
                    "callbackId": callbackId
                },
                success: function(data) {
                    var filterId = "filter" + index
                    var widgets = data[0]

//                    var widgetHolders = $("#widgetsDiv" + index).find(".chart-holder")

                    var row = $("<div class='row'>")
                    $.each(widgets, function (j, widget) {
                        row.append(widgetDiv(widget, elementWidth))
                    })
                    widgetsDiv.html(row)
                    $.each(widgets, function (j, widget) {
                        genericWidget(widget, filterId)
                    })
//                    $.each(widgetHolders, function(i, widgetHolder){
//                        genericWidgetForElement(widgetHolder.id, widgets[i], filterId)
//                    })
                },
                error: function(data) {
                    showErrorResponse(data)
                }
            });
        }
    </script>

    @tableViewParts.zipWithIndex.map { case (_, index) => @dataSetFilterValuesUpdate("filter" + index) }

    @highchartsJsImportForBulkExport()
}

@layout.list(
    dataSetName + " Item",
    Some(dataSetName + " ("+ dataViewName + ")"),
    tableViewParts.map(_.page.total).sum,
    Some(actions),
    if(tableViewParts.exists(_.tableFields.nonEmpty)) {
        Some(viewTables(dataViewId, tableViewParts, dataSetRouter))
    } else {
        None
    },
    if (tableViewParts.size == 1) {
        Some(widgetsDiv)
    } else {
        Some(filtersAndWidgets)
    },
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav()),
    None,
    Some(bottomResources)
)
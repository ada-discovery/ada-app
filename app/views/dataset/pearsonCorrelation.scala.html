@import models.Field
@import models.CorrelationType
@import views.html.dataset.{widgetsScreen, dynamicFieldTable}
@import views.html.table.dynamicTableJsImport
@import models.DataSpaceMetaInfo
@import controllers.dataset.DataSetWebContext._
@import controllers.dataset.DataSetWebContext

@(
    dataSetName: String,
    filterSpec: models.Filter,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit context: DataSetWebContext
)

@extraActions = {
    <div class="pull-right">
        <button class="btn btn-success btn-sm" href="#" onclick="calcCorrelations();" data-toggle="tooltip" title="Calculate Correlations">
            <span class="glyphicon glyphicon-play" aria-hidden="true"></span> Launch
        </button>

        <button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#dataViewSelectionModal" title="Add Correlation(s) To View">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To View
        </button>
    </div>
}

@bottomResources = {

    <script src="@routes.CustomDirAssets.versioned("javascripts/ada-charts.min.js")"></script>

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.calcPearsonCorrelations,
        dataSetJsRouter.getWidgets
    )

    @helper.javascriptRouter("dataViewJsRoutes")(
        dataViewJsRouter.addCorrelation
    )

    <script type="text/javascript">
            var values = [];
            var rows = [];
            var cols = [];

            const adaCharts = new AdaCharts.default()
            const container = document.querySelector('#widgetsDiv');
            const heatmap = new adaCharts.availableCharts[0](container)

//            console.log(adaCharts.availableCharts.length)
//            console.log(adaCharts.availableCharts[0])

            console.log(adaCharts)
            console.log(heatmap)

            /**
             * Ignore the code below. It's just some hacks to generate some random data for demo
             */
            function shuffle(a) {
                for (var i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }

            function generateRandomMatrix(minValue, maxValue) {
                const height = Math.floor(Math.random() * (50 - 20 + 1) + 20);
                const width = Math.floor(Math.random() * (50 - 20 + 1) + 20);

                values = [];
                rows = [];
                cols = [];

                for (var i = 0; i < height; i += 1) {
                    rows.push("row - " + i);
                    for (var j = 0; j < width; j += 1) {
                        if (Math.random() > 0.9) {
                            values.push(undefined);
                        } else {
                            values.push(Math.random() * (maxValue - minValue + 1) + minValue);
                        }
                        if (i === 0) {
                            cols.push("col - " + j);
                        }
                    }
                }

                if (Math.random() > 0.7) shuffle(rows);
                if (Math.random() > 0.7) shuffle(cols);
            }

            /**
             * API "documentation" below this point
             */

            function toPNG() {
                heatmap.toPNG();
            }

            function update() {
                generateRandomMatrix(-1, 1, true);

//                const container = $("#heatmap-container");
 //               var heatmap = AdaCharts.chart({ chartType: 'heatmap', container: container })

                console.log(values)
                console.log(rows)
                console.log(cols)
                heatmap.update({ values: values, rows: rows, cols: cols, valueRange: [-1, 1], sequential: true });
            }

            function highlight() {
                const randomRow = rows[Math.floor(Math.random() * rows.length)];
                const randomCol = cols[Math.floor(Math.random() * cols.length)];
                heatmap.highlight({ row: randomRow, col: randomCol });
            }

//            document.addEventListener('DOMContentLoaded', update, false);


        $(function () {
            populateNumericalTypeahead("field")

            $("#dataViewSelectionModal #submitButton").on("click", addCorrelationToView);

            $('#fieldNameDiv #addRowButton').focus();

            activateAllFilters(function(filterOrId) {calcCorrelations()});
        });

        function calcCorrelations() {
            var inputFieldNames = getFieldNames()

            var filterOrId = $(".filter-div").multiFilter('getIdOrModel')
            var filterOrIdJson = JSON.stringify(filterOrId);

            if (inputFieldNames.length == 0) {
                showError("Pearson correlation calculation cannot be launched. No fields specified.");
            } else {
                var ajaxHandler = handleResponse("Pearson correlation calculation finished.")
                ajaxHandler["data"] = {
                    "fieldNames": inputFieldNames
                };

                dataSetJsRoutes.controllers.dataset.DataSetDispatcher.calcPearsonCorrelations(filterOrIdJson).ajax(ajaxHandler)

                hideErrors();
                showMessage("Pearson correlation calculation for " + inputFieldNames.length + " fields launched.")
            }
        }

        function addCorrelationToView() {
            var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
            var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()

            var fieldNames = getFieldNames()
            var correlationType = '@CorrelationType.Pearson'

            if (fieldNames.length == 0) {
                showError("No fields defined.");
            } else {
                dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addCorrelation(dataViewId, correlationType).ajax({
                    data: {
                        "fieldNames": fieldNames
                    },
                    success: function() {
                        showMessage("Correlation for the field(s) '" + fieldNames.join(", ") + "' has been successfully added to the view '" + dataViewName + "'.");
                    },
                    error: showErrorResponse
                });
            }
        }

        function getFieldNames() {
            $('#fieldNameDiv').dynamicTable('updateModelFromTable');
            return $('#fieldNameDiv').dynamicTable('getModel');
        }

        function addAllFields() {
            $.ajax({
                url: '@Html(dataSetRouter.fieldNamesAndLabels(Seq(FieldTypeId.Double, FieldTypeId.Integer, FieldTypeId.Date)).url)',
                success: function (data) {
                    $.each(data, function(index, field) {
                        var values = {};
                        values["fieldName"] = field[0];
                        values["fieldTypeahead"] = field[1] ? field[1] : field[0];

                        $('#fieldNameDiv').dynamicTable('addTableRow', values)
                    });
                }
            });
        }
    </script>

    <style>
        body {
            display: flex;
            flex-direction: row;
        }

        #heatmap-controls {
            display: flex;
            flex-direction: column;
        }

        #widgetsDiv {
            width: 50vw;
        }
    </style>
}

@fieldButtons = {
    <a id="addAllFieldsButton" class="btn btn-info btn-sm" href="#" onclick="addAllFields();" data-toggle="tooltip" title="Add All">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> All
    </a>
}

@inputElements = {

    @dynamicTableJsImport()

    <div class="row">
    @dynamicFieldTable(
        "fieldName",
        Nil,
        true,
        12,
        Some(fieldButtons),
        Some(Right(dataSetRouter.getCategoriesWithFieldsAsTreeNodes(filterSpec.conditionsOrId))),
        "categoryTree2"
    )
    </div>

    <div class="row">

    <div id="heatmap-controls">
        <span>API examples:</span>
        <button onclick="update()">update()</button>
        <button onclick="toPNG()">toPNG()</button>
        <button onclick="highlight()">highlight()</button>
    </div>

    </div>
}

@widgetsScreen(
    Messages("pearsonCorrelation.title", dataSetName),
    Seq(filterSpec),
    filterShowFieldStyle,
    dataSpaceMetaInfos,
    inputElements,
    Some(extraActions),
    bottomResources,
    true,
    widgetsDivOnRight = true
)
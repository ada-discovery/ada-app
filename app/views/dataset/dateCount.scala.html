@import controllers.dataset.DataSetRouter
@import models.{FilterCondition, ChartSpec}
@import dataaccess.FieldTypeId
@import dataaccess.Field
@import views.html.layout.main
@import views.html.chart.highcharts.{highchartsJsImport, timeLineChart}
@import views.html.dataset.datasetSubNav
@import play.api.libs.json.Json
@import play.api.mvc.Flash
@import play.api.i18n.Messages
@import java.util.Date
@import controllers.dataset.routes.{DataSetSettingController => dataSetSettingRoutes}

@import dataaccess.DataSpaceMetaInfo

@(
    domainName: String,
    dateField: Option[Field],
    groupField: Option[Field],
    series: Seq[(String, Seq[(Date, Any)])],
    filterSpec: Seq[FilterCondition],
    router: DataSetRouter,
    dataSetId: String,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit flash: Flash, msg: Messages, request: Request[_]
)

@actions = {
    <div class="row">
        <div class="col-md-12">
            @filter(filterSpec, router.getDateCount(dateField.map(_.name), groupField.map(_.name), filterSpec), Right(router.allFieldNameLabels))
        </div>
    </div>
    <hr/>
    @helper.form(action=router.getDateCount(dateField.map(_.name), groupField.map(_.name), filterSpec), 'role -> "search", 'id -> "fieldForm") {
        <!-- hacky solution to pass data set param since it's ignored when passed as a part of the call in the form action -->
        <input type="hidden" name="dataSet" value="@dataSetId"/>
        <input type="hidden" name="filter" value="@Json.toJson(filterSpec)"/>
        <div class="row">
            <div class="col-md-3">
                <input id="dateFieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@dateField.map(_.labelOrElseName)">
                <input id="dateFieldName" name="dateFieldName" type="hidden" value="@dateField.map(_.name)">
            </div>
            <div class="col-md-2" align="right">
                <label class="top-padded">Group by</label>
            </div>
            <div class="col-md-3">
                <input id="groupFieldTypeahead" class="typeahead typeahead-large" type="text" placeholder="Field Name" value="@groupField.map(_.labelOrElseName)">
                <input id="groupFieldName" name="groupFieldName" type="hidden" value="@groupField.map(_.name)">
            </div>
        </div>
   }
}


@bottomResources = {
    @highchartsJsImport()
    @timeLineChart("Date Count", "dateCountChart", Some("Date"), Some("Count"), series)
}

@main(Messages("dateCount.title", domainName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNav()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("dateCount.title", domainName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>
    <br/>
    <br/>
    <div id="dateCountChart" class="chart-holder"></div>
}

<script type="text/javascript">
    $(function () {
        populateFieldTypeahedFromUrl(
            $('#fieldForm #dateFieldTypeahead'),
            $('#fieldForm #dateFieldName'),
            '@router.fieldNameLabels(Seq(FieldTypeId.Date))'
        )

        populateFieldTypeahedFromUrl(
            $('#fieldForm #groupFieldTypeahead'),
            $('#fieldForm #groupFieldName'),
            '@router.fieldNameLabels(Seq(FieldTypeId.Enum, FieldTypeId.String, FieldTypeId.Boolean))'
        );

        $('#fieldForm #dateFieldTypeahead').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #groupFieldTypeahead').on('typeahead:selected', function(e, data) {
            $('#fieldForm').submit();
        });

        $('#fieldForm #dateFieldTypeahead').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });

        $('#fieldForm #groupFieldTypeahead').keypress(function (e) {
            if (e.which == 13) {
                $('#fieldForm').submit();;
                return false;
            }
        });
    });
</script>
@import controllers.dataset.{DataSetRouter, FilterRouter, FilterJsRouter, DataViewRouter, DataViewJsRouter}
@import models.{FilterCondition, ChartSpec}
@import models.Field
@import reactivemongo.bson.BSONObjectID
@import reactivemongo.play.json.BSONFormats._
@import views.html.layout.main
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.chart.{chartJs, chart}
@import views.html.dataset.datasetSubNav
@import views.html.dataview.dataViewSelectionModal
@import views.html.table.{dynamicStringTable, dynamicTableJsImport}
@import play.api.libs.json.Json
@import play.api.mvc.Flash
@import play.api.i18n.Messages
@import models.DataSpaceMetaInfo

@(
    domainName: String,
    fields: Traversable[Field],
    chartSpec: Option[ChartSpec],
    filterSpec: models.Filter,
    filterShowFieldStyle: Option[FilterShowFieldStyle.Value],
    router: DataSetRouter,
    filterRouter: FilterRouter,
    filterJsRouter: FilterJsRouter,
    dataViewRouter: DataViewRouter,
    dataViewJsRouter: DataViewJsRouter,
    dataSetId: String,
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
    implicit flash: Flash, msg: Messages, request: Request[_]
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filter(
                Some(filterSpec),
                router.getCorrelations(fields.map(_.name).toSeq, filterSpec.conditionsOrId),
                Right(router.allFields),
                filterShowFieldStyle,
                Some(filterJsRouter),
                Some(filterRouter.idAndNames),
                "filterOrId"
            )
        </div>
        <div class="pull-right">
            <button class="btn btn-info btn-sm" type="button" data-toggle="modal" data-target="#dataViewSelectionModal" title="Add Correlation(s) To View">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To View
            </button>
        </div>
    </div>
}

@bottomResources = {
    @highchartsJsImport()
    @chartSpec.map(chartJs(_)).getOrElse("")
}

@fieldNamesAddModalInner = {
    <input type="text" id="newItemTypeahead" class="typeahead">
    <input type="hidden" id="newItem">
}

@main(Messages("correlation.title", domainName), Some(datasetMenu(dataSpaceMetaInfos)), Some(datasetSubNav()), None, Some(bottomResources)) {

    <div class="page-header">
        <h3>
            @Messages("correlation.title", domainName)
        </h3>
    </div>

    <div id="actions">
        @actions
    </div>

    <hr/>

    @dynamicTableJsImport()

    <div class="row">
        <div class="col-md-3">
            <div class="row">
                @dynamicStringTable("fieldName", fields.map(_.name), true, Some(fieldNamesAddModalInner))
            </div>
            <div class="row">
                @helper.form(action=router.getCorrelations(Nil, Left(Nil)), 'role -> "search", 'id -> "fieldForm") {
                    <input type="hidden" name="dataSet" value="@dataSetId"/>
                    <input type="hidden" name="filterOrId" value="@filterSpec.conditionsOrId.fold(Json.toJson(_), _.stringify)"/>
                    <button type="primary" onclick="addFieldNames()" class="btn btn-primary">Show</button>
                }
            </div>
        </div>
        <div class="col-md-9">
            @chartSpec.map(chart(_)).getOrElse("")
            @dataViewSelectionModal("dataViewSelectionModal", dataViewRouter, dataViewJsRouter)
        </div>
    </div>
}

@helper.javascriptRouter("dataViewJsRoutes")(
    dataViewJsRouter.addCorrelation
)

<script type="text/javascript">
    $(function () {
        populateFieldTypeahedFromUrl(
            $('#fieldNameDiv #newItemTypeahead'),
            $('#fieldNameDiv #newItem'),
            '@Html(router.fields(Seq(FieldTypeId.Double, FieldTypeId.Integer)).url)',
             @filterShowFieldStyle.getOrElse(FilterShowFieldStyle.NamesAndLabels).id
        );

        $("#dataViewSelectionModal #submitButton").on("click", addCorrelationToView)

        $('#fieldNameDiv #addRowButton').focus();
    });

    function addFieldNames() {
        var fieldNames = getFieldNames()
        $.each(fieldNames, function(index, str) {
            var map = {};
            map["fieldNames"] = str.trim();
            addParams($("#fieldForm"), map)
        })
    }

    function addCorrelationToView() {
        var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
        var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()

        var fieldNames = getFieldNames()

        if (fieldNames.length > 0) {
            dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addCorrelation(dataViewId, fieldNames).ajax( {
                success: function() {
                    showMessage("Correlation for the field(s) '" + fieldNames.join(", ") + "' has been successfully added to the view '" + dataViewName + "'.");
                },
                error: function(data){
                    showError( data.responseText );
                }
            });
        } else {
            showError("No fields defined.");
        }
    }

    function getFieldNames() {
        $('#fieldNameDiv').dynamicTable('updateModelFromTable');
        var fieldNames = $('#fieldNameDiv').dynamicTable('getModel');
        return fieldNames;
    }
</script>
@import play.api.libs.json.Json
@import models.{Field, Filter}
@import controllers.FilterConditionExtraFormats.coreFilterConditionFormat
@import controllers.dataset.FilterJsRouter
@import util.toJsonHtml

@(
    filter: Option[Filter],
    submitCall: Call,
    fieldsOrCall: Either[Traversable[Field], Call],
    filterJsRouter: Option[FilterJsRouter],
    listFiltersCall: Option[Call],
    filterSubmitParamName: String,
    filterElementId: String,
    createSubmissionJson: Option[Html],
    categoryTreeElementId: Option[String],
    refreshAjaxFun: Option[Html] = None
)(
    implicit request: Request[_], webJarAssets: WebJarAssets
)

@fieldNameLabelsAsString = @{
    fieldsOrCall match {case Left(fields) =>
        Html(
            Json.stringify(
                Json.toJson(
                    fields.map { field =>
                        Json.obj("name" -> field.name, "label" -> field.label)
                    }
                )
            )
        )
    }
}

@fieldsUrl = @{
    fieldsOrCall match {case Right(call) => call.url}
}

@if(filterJsRouter.isDefined) {
    @helper.javascriptRouter("filterJsRoutes")(
        filterJsRouter.get.saveAjax
    )
}

<!-- '
    Widget' part of the JQuery UI lib is sufficient for the filter JS, however for consistence we load the whole JQuery UI
    <script type="text/javascript" src="@routes.Assets.versioned("javascripts/jquery-ui-1.11.4-widget.min.js")"></script>
-->
<!-- need to import css and js first -->
@typeaheadJsImport()

<script src="@routes.WebJarAssets.at(webJarAssets.locate("jquery-ui.min.js"))"></script>
<script type="text/javascript" src="@routes.Assets.versioned("javascripts/multiFilterX.min.js")"></script>
<script type="text/javascript" src="@routes.Assets.versioned("javascripts/multiCategoryFilter.min.js")"></script>

<script type="text/javascript">
    $(function () {
        var jsConditions = JSON.parse('@{toJsonHtml(filter.map(_.conditions).getOrElse(Nil))}');

        var filterId = @if(filter.isDefined && filter.get._id.isDefined) { '@filter.get._id.get.stringify' } else { null }

        var fieldNameAndLabels = @if(fieldsOrCall.isLeft) { JSON.parse('@fieldNameLabelsAsString') } else { null }

        var getFieldsUrl = @if(fieldsOrCall.isRight) {'@fieldsUrl'} else { null }

        var listFiltersUrl = @if(listFiltersCall.isDefined) {'@listFiltersCall.get.url'} else { null }

        var refreshAjaxFun = @if(refreshAjaxFun.isDefined) { @{refreshAjaxFun.get} } else { null }

        var createSubmissionJson = @if(createSubmissionJson.isDefined) { @createSubmissionJson } else {null}

        @if(categoryTreeElementId.isDefined) {
            $("#@{filterElementId}").multiCategoryFilter({
                jsonConditions: jsConditions,
                fieldNameAndLabels: fieldNameAndLabels,
                getFieldsUrl: getFieldsUrl,
                submitUrl: '@submitCall.url',
                refreshAjaxFun: refreshAjaxFun,
                listFiltersUrl: listFiltersUrl,
                filterSubmitParamName: '@filterSubmitParamName',
                filterId: filterId,
                createSubmissionJson: createSubmissionJson,
                categoryTreeElementId: '@categoryTreeElementId.get'
            })
        } else {
            $("#@{filterElementId}").multiFilter({
                jsonConditions: jsConditions,
                fieldNameAndLabels: fieldNameAndLabels,
                getFieldsUrl: getFieldsUrl,
                submitUrl: '@submitCall.url',
                refreshAjaxFun: refreshAjaxFun,
                listFiltersUrl: listFiltersUrl,
                filterSubmitParamName: '@filterSubmitParamName',
                filterId: filterId,
                createSubmissionJson: createSubmissionJson
            })
        }
    })
</script>
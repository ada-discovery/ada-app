@import views.html.layout
@import views.html.elements.editableTextElements
@import views.html.table.dynamicTableJsImport
@import org.incal.play.controllers.{WebContext, IdForm}
@import org.incal.play.controllers.WebContext._
@import org.ada.web.controllers.routes
@import views.html.elements._
@import org.ada.web.util.typeColumns
@import views.html.table.{displayTable, dynamicTable}
@import reactivemongo.bson.BSONObjectID
@import  org.ada.server.models._
@import views.html.table.dynamicStringTable
@import views.html.dataset.{dynamicFieldTable}
@import views.html.elements.{fieldTypeahead, typeahead}
@import views.html.table.{displayTable, dynamicTable, dynamicTwoColumnTable}
@import org.ada.web.controllers.dataset.DataSetWebContext
@import views.html.dataview.{filterOrIdTable, widgetSpecTable}
@import org.ada.server.models.WidgetGenerationMethod
@import views.html.dataview.activateTypeahead
@import views.html.dataset.{datasetMenu, datasetSubNav, datasetSubNavJs}

@(
    data: IdForm[BSONObjectID, BatchRequestSetting],
    nameFieldMap: Map[String,  Field],
    idFilterNameMap: Map[BSONObjectID, String],
    showFieldStyle: Option[FilterShowFieldStyle.Value],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo],
    dataSetSetting: DataSetSetting
)(
     implicit context: DataSetWebContext, ctx: WebContext
)

@elements = {
    @inputTextReadonly("requestSetting", "dataSetId", data.form)
    @dynamicTableJsImport()
    @typeaheadJsImport()

@labelValue("userIds", attributeLabel("requestSetting", "Committee users Ids")) {
    @dynamicFieldTable(
        "userId",
        Nil,
        true,
        5,
        None,
        None,
        showFieldStyle = Some(FilterShowFieldStyle.NamesOnly)
    )
}
    
@labelValue("widgetSpecs", attributeLabel("dataView", "widgetSpecs")){
    @widgetSpecTable(
        data.form.value.map(_.widgetSpecs).getOrElse(Nil),
        nameFieldMap,
        idFilterNameMap,
        showFieldStyle
    )
}

@labelValue("displayFieldNames", attributeLabel("requestSetting", "displayFieldNames")){
    @dynamicStringTable("displayFieldName", data.form.value.map(_.displayFieldNames).getOrElse(Nil), false, None, Some(extraFieldButtons), true, 8)
}

@helper.javascriptRouter("dataSetJsRoutes")(
    context.dataSetJsRouter.generateTable
)

    <script type="text/javascript">
        $(function () {
            populateIdNameTypeahedFromUrl(
                $('#userIdDiv').find('#fieldTypeahead'),
                $('#userIdDiv').find('#fieldName'),
                '@Html(org.ada.web.controllers.routes.UserController.idAndNames().url)',
                true
            )

            populateFieldTypeahedFromUrl(
                    $('#displayFieldNameDiv').find('#fieldTypeahead'),
                    $('#displayFieldNameDiv').find('#fieldName'),
                    '@Html(context.dataSetRouter.allFields.url)',
                    @FilterShowFieldStyle.NamesOnly.id
            )
        })

        function addAllFields() {
            $.ajax({
                url:  '@Html(context.dataSetRouter.allFields.url)',
                success: function (data) {
                    $.each(data, function(index, field) {
                        var values = {};

                        values["newItem"] = field.name;
                        $('#displayFieldNameDiv').dynamicTable('addTableRow', values)
                    });
                },
                error: showErrorResponse
            });
        }
    </script>
}

@extraFieldButtons = {
    <a id="addAllFieldsButton" class="btn btn-info btn-sm" href="#" onclick="addAllFields();" data-toggle="tooltip" title="Add All Fields">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> All
    </a>
}

@extraBottomResources = {
    @activateTypeahead(showFieldStyle)
}

@layout.edit(
    "Request setting",
    "request setting",
    errors = data.form.errors,
    elements = elements,
    updateCall = controllers.requestSetting.routes.RequestSettingController.update(data.id),
    cancelCall = controllers.requestSetting.routes.RequestSettingController.listAll(),
    deleteCall = Some(controllers.requestSetting.routes.RequestSettingController.delete(data.id)),
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav(dataSetSetting)),
    bottomResources = Some(extraBottomResources)
)
@import views.html.layout
@import views.html.elements.editableTextElements
@import views.html.table.dynamicTableJsImport
@import org.incal.play.controllers.{WebContext, IdForm}
@import org.ada.web.controllers.routes
@import views.html.elements._
@import org.ada.web.util.typeColumns
@import views.html.table.{displayTable, dynamicTable}
@import reactivemongo.bson.BSONObjectID
@import  org.ada.server.models._
@import views.html.table.dynamicStringTable
@import views.html.dataset.{dynamicFieldTable}
@import views.html.elements.{fieldTypeahead, typeahead}
@import views.html.table.{displayTable, dynamicTable, dynamicTwoColumnTable}
@import org.ada.web.controllers.dataset.DataSetWebContext
@import views.html.dataview.{filterOrIdTable, widgetSpecTable}
@import org.ada.server.models.WidgetGenerationMethod
@import views.html.requestSettings.dynamicUserTable
@import views.html.dataview.{activateTypeahead => dataViewActivateTypeahead}
@import views.html.dataset.{datasetMenu, datasetSubNav, datasetSubNavJs}
@import org.ada.web.controllers.dataset.DataSetWebContext._

@(
    id: BSONObjectID,
    form: Form[BatchRequestSetting],
    nameFieldMap: Map[String,  Field],
    idUserMap: Map[BSONObjectID, User],
    idFilterNameMap: Map[BSONObjectID, String],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo],
    dataSetSetting: DataSetSetting
)(
    implicit context: DataSetWebContext
)

@elements = {
    @labelValue("dataSetId", attributeLabel("requestSetting", "dataSetId")) {
        <input id="dataSetId" name="dataSetId" value="@context.dataSetId" readonly="true">
    }

    @dynamicTableJsImport()

    @labelValue("userIds", attributeLabel("requestSetting", "committeeUserIds")) {
        @dynamicUserTable(
            "userId",
            form.value.map(_.userIds).getOrElse(Nil).flatMap(idUserMap.get(_))
        )
    }

    @labelValue("displayFieldNames", attributeLabel("requestSetting", "displayFieldNames")) {
        @dynamicFieldTable(
            "displayFieldName",
            form.value.map(_.displayFieldNames).getOrElse(Nil).map(Field(_)),
            true,
            5,
            Some(extraFieldButtons),
            None,
            showFieldStyle = Some(FilterShowFieldStyle.NamesOnly)
        )
    }

    @labelValue("widgetSpecs", attributeLabel("dataView", "widgetSpecs")){
        @widgetSpecTable(
            form.value.map(_.widgetSpecs).getOrElse(Nil),
            nameFieldMap,
            idFilterNameMap,
            dataSetSetting.filterShowFieldStyle
        )
    }
}

@extraFieldButtons = {
    <a id="addAllFieldsButton" class="btn btn-info btn-sm" href="#" onclick="addAllFields();" data-toggle="tooltip" title="Add All Fields">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> All
    </a>
}

@extraBottomResources = {
    @typeaheadJsImport()

    @dataViewActivateTypeahead(dataSetSetting.filterShowFieldStyle)

    <script type="text/javascript">
        $(function () {
            populateIdNameTypeahedFromUrl(
                $('#add_userIdModal').find('#userTypeahead'),
                $('#add_userIdModal').find('#userId'),
                '@Html(org.ada.web.controllers.routes.UserController.idAndNames().url)'
            )

            populateFieldTypeahedFromUrl(
                $('#displayFieldNameDiv').find('#fieldTypeahead'),
                $('#displayFieldNameDiv').find('#fieldName'),
                '@Html(context.dataSetRouter.allFields.url)',
                @FilterShowFieldStyle.NamesOnly.id
            )
        })

        function addAllFields() {
            $.ajax({
                url:  '@Html(context.dataSetRouter.allFields.url)',
                success: function (data) {
                    $.each(data, function(index, field) {
                        var values = {};
                        values["fieldName"] = field.name;
                        values["fieldTypeahead"] = field.label ? field.label : field.name;

                        $('#displayFieldNameDiv').dynamicTable('addTableRow', values)
                    });
                },
                error: showErrorResponse
            });
        }
    </script>
}

@layout.edit(
    "Request setting",
    "request setting",
    errors = form.errors,
    elements = elements,
    updateCall = controllers.orderrequest.routes.RequestSettingController.update(id),
    cancelCall = controllers.orderrequest.routes.RequestSettingController.find(),
    deleteCall = Some(controllers.orderrequest.routes.RequestSettingController.delete(id)),
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav(dataSetSetting)),
    bottomResources = Some(extraBottomResources)
)
@import util.matchesPath
@import controllers.core.WebContext
@import controllers.core.WebContext._
@import views.html.layout.main
@import controllers.routes.{MPowerChallengeController => challengeRoutes}
@import play.api.libs.json.Json
@import views.html.elements.labelValue

@(
    domainName: String,
    threshold: Double,
    withDemographics: Boolean,
    nodes: Traversable[VisNode],
    edges: Traversable[VisEdge]
)(implicit context: WebContext)

@topItem(text: String, id: Int) = {
    <li style="padding-top: 15px">
        <ul class="list-inline">
            <li>
                <button type="button" class="btn btn-sm btn-default btn-expand" data-toggle="collapse" data-target="#submenu-@{id}">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                </button>
            </li>
            <li style="color: darkgray;">
                <h4>@text</h4>
            </li>
        </ul>
    </li>
}

@listItem(call: Call, text: String, matchPrefixDepth : Option[Int] = None) = {
    <li @if(matchesPath(call.url, context.request.path, matchPrefixDepth)) {class="inner-node active"} else {class="inner-node"}>
        <a href="@call">
            <ul class="list-inline">
                <li>
                    <span class="glyphicon glyphicon-chevron-right"></span>
                </li>
                <li>
                    <h5>@text</h5>
                </li>
            </ul>
        </a>
    </li>
}

@sideBar = {
    <ul class="sidebar-nav nav nav-pills nav-stacked">
        @topItem("1. mPower", 1)
        <div id="submenu-1" class="collapse clear-left submenu-div sidebar-nav nav nav-pills nav-stacked">
            @listItem(challengeRoutes.mPowerTeamNetwork(), "Teams", Some(2))
            @listItem(challengeRoutes.mPowerSubmissionNetwork(), "Submissions", Some(2))
        </div>
        @topItem("2.1 Tremor", 2)
        <div id="submenu-2" class="collapse clear-left submenu-div sidebar-nav nav nav-pills nav-stacked">
            @listItem(challengeRoutes.tremorTeamNetwork(), "Teams", Some(2))
            @listItem(challengeRoutes.tremorSubmissionNetwork(), "Submissions", Some(2))
        </div>

        @topItem("2.2 Dyskinesia", 3)
        <div id="submenu-3" class="collapse clear-left submenu-div sidebar-nav nav nav-pills nav-stacked">
            @listItem(challengeRoutes.dyskinesiaTeamNetwork(), "Teams", Some(2))
            @listItem(challengeRoutes.dyskinesiaSubmissionNetwork(), "Submissions", Some(2))
        </div>

        @topItem("2.3 Bradykinesia", 4)
        <div id="submenu-4" class="collapse clear-left submenu-div sidebar-nav nav nav-pills nav-stacked">
            @listItem(challengeRoutes.bradykinesiaTeamNetwork(), "Teams", Some(2))
            @listItem(challengeRoutes.bradykinesiaSubmissionNetwork(), "Submissions", Some(2))
        </div>
    </ul>
}

@option(i: Int) = {
    <option value="@{i*5}">Top @{i*5}</option>
}

@thresholdOption(i: Int) = {
    <option value="0.@i" @if(threshold.toString.equals(s"0.$i")) {selected="selected"}>0.@i</option>
}

@main(Messages("network.title", domainName), Some(sideBar)) {

    <style type="text/css">
        #mynetwork {
            height: 700px;
            border: #cbcbcb 1px solid;
            border-radius: 10px;
        }
    </style>

    <div class="page-header">
        <div class="row">
            <div class="col-md-12">
                <h1>@Messages("network.title", domainName)</h1>
            </div>
        </div>
    </div>

    <script src="@routes.WebJarAssets.at(context.webJarAssets.locate("vis.min.js"))"></script>
    <link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.versioned("stylesheets/vis.min.css")">

    <div class="row">
        <div class="col-md-10">
            <div id="mynetwork"></div>
        </div>

        <div class="col-md-2">
            <div id="teamInfoDiv" class="row alert alert-success">
                No team selected
            </div>
            <div class="row">
                <a class="btn btn-info" onclick="zoomIn();" data-toggle="tooltip" title="Zoom In">
                    <span class="glyphicon glyphicon-zoom-in"></span>
                </a>
                <a class="btn btn-info" onclick="zoomOut();" data-toggle="tooltip" title="Zoom Out">
                    <span class="glyphicon glyphicon-zoom-out"></span>
                </a>
            </div>
            <div class="row">
                <div class="panel panel-default" style="margin-top: 20px">
                    <div class="panel-body">
                        <span style="padding-top: 5px">Show</span>
                        <select class="pull-right" id="topTeamSelection" name="topTeamSelection" onchange="selectTeams()" >
                            <option value="">All</option>
                            @{for(i <- 1 until nodes.size / 5) yield option(i)}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="panel panel-default" style="margin-top: 20px">
                    <div class="panel-body">
                        <span style="padding-top: 5px">Threshold</span>
                        <select class="pull-right" id="corrThreshold" name="corrThreshold" onchange="resubmit()">
                            @{for (i <- 1 to 9) yield thresholdOption(i)}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="panel panel-default" style="margin-top: 20px">
                    <div class="panel-body">
                        <span style="padding-top: 5px">With Demographics</span>
                        <input type='checkbox' id="withDemographics" @if(withDemographics) {checked='checked'} onchange="resubmit()"/>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var nodes = [
            @nodes.map{ node =>
                {id: @node.id, size: @node.size, font: { multi: true }, label: '<b>@{node.label}</b>', data: JSON.parse('@Html(Json.stringify(node.data.get))')},
            }
        ];

        var edges = [
            @edges.map{ edge =>
                {from: @edge.from, to: @edge.to, width: @edge.value, title: '@edge.label', color:{color:'#60c842', opacity: 0.8}, arrows:'to'},
            }
        ];

        var network = null;

        function draw(selectedNodes) {
            // Instantiate our network object.
            var container = document.getElementById('mynetwork');
            var physicsEnabled = true // (selectedNodes.length <= 30)
            var data = {
                nodes: selectedNodes,
                edges: edges
            };
            var options = {
                nodes: {
                    shape: 'dot',
                    font: {
                        size: 16
                    }
                },
                interaction: {
                    hover:true
                },
                physics: {
                    enabled: physicsEnabled
                }
            };
            network = new vis.Network(container, data, options);
            network.fit();

            network.on("click", function (params) {
                console.log(params)
                if (params.nodes.length > 0) {
                    // node  click
                    var node = getNode(params.nodes[0])
                    $("#teamInfoDiv").html("")
                    $("#teamInfoDiv").append("<h4><b>" + node.label + "</b></h4><hr/>")
                    $.each(node.data, function (key, value) {
                        if (value && (!Array.isArray(value) || value.length > 0)) {
                            $("#teamInfoDiv").append(key + " : " + value + "</br>")
                        }
                    })
                } else {
                    // edge click
                    var edge = getEdge(params.edges[0])
                    var from = getNode(edge.from)
                    var to = getNode(edge.to)
                    $("#teamInfoDiv").html("")
                    $("#teamInfoDiv").append("<h4>" + from.label + " -> " + to.label + "</h4><hr/>")
                    $("#teamInfoDiv").append(edge.title)
                }
            });
        }

        function zoomIn() {
            var newScale = 1.5 * network.getScale()
            var options = {
                scale: newScale,
                animation: { duration: 300, easingFunction: "easeInCubic" }
            };
            network.moveTo(options);
        }

        function zoomOut() {
            var newScale = 0.666 * network.getScale()
            var options = {
                scale: newScale,
                animation: { duration: 300, easingFunction: "easeInCubic" }
            };
            network.moveTo(options);
        }

        function getNode(nodeId) {
            var found = nodes.find(function (node) {
                return node.id == nodeId;
            });
            return found
        }

        function getEdge(edgeId) {
            var found = edges.find(function (edge) {
                return edge.id == edgeId;
            });
            return found
        }

        function selectTeams() {
            var teamsNum = $("#topTeamSelection").val()
            var selectedNodes = nodes
            if (teamsNum) {
                selectedNodes = nodes.slice(0, teamsNum)
            }
            draw(selectedNodes)
        }

        function resubmit() {
            var url = window.location.href

            var params = {};
            params['corrThreshold'] = $("#corrThreshold").val();
            params['withDemographics'] = $("#withDemographics").is(':checked');

            submit('get', url, params)
        }

        $(function () {
            // draw all nodes
            draw(nodes)
        })

        $('.btn-expand').on('click', function () {
            updatePlusMinusIcon($(this));
        });

        $(".submenu-div").each(function () {
            if ($(this).find("li.inner-node.active").size() > 0) {
                $(this).addClass("in")
                updatePlusMinusIcon($(this).prev());
            }
        });

        function updatePlusMinusIcon(element) {
            var iconPlus = element.find("span.glyphicon-plus:first");
            var iconMinus = element.find("span.glyphicon-minus:first");
            if (iconPlus.length) {
                iconPlus.removeClass("glyphicon-plus");
                iconPlus.addClass("glyphicon-minus");
            } else {
                iconMinus.removeClass("glyphicon-minus");
                iconMinus.addClass("glyphicon-plus");
            }
        }
    </script>
}
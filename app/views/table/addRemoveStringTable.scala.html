@import views.html.table.displayTable
@import util.typeColumns

@(domainName: String, items: Traversable[String], extraActions: Option[Html] = None)

@modalInner = {
    <input text="text" id="newItems" value="">
}

@modalButtons(domainName: String) = {
    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    <button type="button" class="btn btn-primary" id="@{domainName}SubmitButton" data-dismiss="modal">OK</button>
}


<div id="@{domainName}Div" class="row col-sm-4">
    <a class="btn btn-info btn-sm" href="#" onclick="openAddModal('@{domainName}');return false;" data-toggle="tooltip" title="Add New @{domainName.capitalize}">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
    </a>
    @if(items.nonEmpty) {
        <a class="btn btn-info btn-sm" href="#" onclick="removeItems('@{domainName}');return false;" data-toggle="tooltip" title="Delete @{domainName.capitalize}">
            <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
        </a>
    }
    @if(extraActions.isDefined) {
        @extraActions.get
    }
    <div>
    @displayTable(
        items,
        typeColumns[String](
            (None, "", _ => {<input type="checkbox"/>}),
            (Some("name"), "Name", identity)
        ),
        None, None, None, Some(domainName + "Table")
    )
    </div>
    @modal("add_" + domainName + "Modal", "Add " + domainName.capitalize + "(s)", modalInner, None, Some(modalButtons(domainName)))
    @items.map{ item =>
        <input type="hidden" name="@{domainName}s[]" value='@item'>
    }
</div>


<script type="text/javascript">
    function registerTableAddModalHandler(domainName) {
        var modalName = 'add_' + domainName + 'Modal'
        var submitButtonName = domainName + 'SubmitButton'

        handleModalButtonEnterPressed(modalName, submitButtonName, function() {addItems(domainName)})
    }

    function openAddModal(domainName) {
        var modalName = 'add_' + domainName + 'Modal'

        $('#' + modalName + ' #newItems').val("")
        $('#' + modalName).modal()
    }

    function addItems(domainName) {
        var modalName = 'add_' + domainName + 'Modal'

        $.each($('#' + modalName + ' #newItems').val().split(","), function(index, item) {
            addTableRow(domainName, item.trim());
        })
    }

    function addTableRow(domainName, item) {
        var itemsName = domainName + 's[]'
        var tableId = domainName + 'Table'
        var tableDiv = domainName + 'Div'

        var map = {};
        map[itemsName] = item;
        addParams($('#' + tableDiv), map)
        $('#' + tableId + ' tbody').append("<tr><td><input type='checkbox'></input></td><td id='name'>" + item + "</td></tr>")
    }

    function removeItems(domainName) {
        var itemsName = domainName + 's[]'
        var tableId = domainName + 'Table'
        var tableDiv = domainName + 'Div'

        $('#' + tableId + ' tbody tr').each(function() {
            var id = $(this).find('#name').text().trim();
            var checked = $(this).find("td input[type=checkbox]").is(':checked');
            if (checked) {
                var valueEl = $('#' + tableDiv).find("input[name='" + itemsName + "'][value='" + id +"']")
                valueEl.remove()
                $(this).remove()
            }
        });
    }
</script>
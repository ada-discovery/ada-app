@import org.ada.web.util.typeColumns
@import org.incal.core.FilterCondition
@import org.incal.play.Page
@import org.incal.play.controllers.WebContext
@import services.request.{ActionGraph, RoleProviderService}
@import views.html.layout
@import views.html.table.paginatedTable
@(
        page: Page[(BatchOrderRequest, String)],
        conditions: Seq[FilterCondition]
)(
        implicit context: WebContext,
        roleService: RoleProviderService
)

    @table = @{
        paginatedTable(
            page,
            controllers.requests.routes.BatchOrderRequestsController.find(_, _, conditions),

            typeColumns[(BatchOrderRequest, String)](
                (Some("createdby"), "Requester name", _._2),
                (Some("timecreated"), "Date", _._1.timeCreated),
                (Some("state"), "Status", _._1.state)
            ),
            Some({ item: Any =>
                val batchRequest = item.asInstanceOf[(BatchOrderRequest, String)]._1
                val currentStatus = batchRequest.state

                val userRole = roleService.getRole(batchRequest._id.get)

                userRole match {
                    case Role.Administrator => controllers.requests.routes.BatchOrderRequestsController.edit(item.asInstanceOf[(BatchOrderRequest, String)]._1._id.get)
                    case _ => {
                        val applicableActions = ActionGraph.apply.get(currentStatus).getOrElse(Traversable()).filter(a => a.allowed == userRole)

                        applicableActions.size > 0 match {
                            case true => controllers.requests.routes.BatchOrderRequestsController.performAction(item.asInstanceOf[(BatchOrderRequest, String)]._1._id.get)
                            case false => controllers.requests.routes.BatchOrderRequestsController.get(item.asInstanceOf[(BatchOrderRequest, String)]._1._id.get)
                        }
                    }
                }
            })
        )
    }

    @layout.list(
        "request",
        None,
        page.total,
        None,
        Some(table),
        None
    )
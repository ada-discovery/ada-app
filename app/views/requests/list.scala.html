@import org.incal.play.controllers.WebContext
@import views.html.layout.main
@import views.html.layout
@import views.html.table.paginatedTable
@import views.html.filter.{filter, filterWithJs}
@import views.html.elements.labelValue
@import org.incal.play.Page
@import org.ada.web.util.typeColumns
@import scala.concurrent.ExecutionContext.Implicits.global
@import reactivemongo.bson.BSONObjectID
@import org.incal.core.FilterCondition
@import services.request.ActionGraph
@import services.request.RoleProviderService
@import scala.util.Success
@import scala.util.Failure
@import scala.concurrent.duration._

@import scala.concurrent.Await
@(
        page: Page[(BatchOrderRequest, String)],
        conditions: Seq[FilterCondition]
 )(
        implicit context: WebContext,
        roleService: RoleProviderService
)

@table = @{
    paginatedTable(
        page,
        controllers.requests.routes.BatchOrderRequestsController.find(_, _, conditions),

        typeColumns[(BatchOrderRequest, String)](
            (Some("createdby"), "Requester name", _._2),
            (Some("timecreated"), "Date", _._1.timeCreated),
            (Some("state"), "Status", _._1.state)
        ),
        Some({ item : Any =>
            val batchRequest = item.asInstanceOf[(BatchOrderRequest, String)]._1
            val currentStatus = batchRequest.state

            val userRole = roleService.getRole(batchRequest._id.get)
            val applicableActions = ActionGraph.apply.get(currentStatus).getOrElse(Traversable()).filter(a => a.allowed == userRole)

            applicableActions.size > 0 match {
                case true => controllers.requests.routes.BatchOrderRequestsController.edit(item.asInstanceOf[(BatchOrderRequest, String)]._1._id.get)
                case false =>                     controllers.requests.routes.BatchOrderRequestsController.get(item.asInstanceOf[(BatchOrderRequest, String)]._1._id.get)
            }
        })
    )
}

@layout.list(
    "request",
    None,
    page.total,
    None,
    Some(table),
    None
)
@import views.html.table.{displayTable, dynamicTable}
@import views.html.elements.labelValue
@import util.typeColumns
@import models.ChartType
@import models.{WidgetSpec, Field}
@import models.DataSetFormattersAndIds.{widgetSpecFormat, widgetSpecClasses}
@import dataaccess.ReflectionUtil.getCaseClassMethodNamesAndTypes
@import play.api.libs.json.Json
@import play.api.libs.json.JsObject

@import util.JsonUtil
@(
    items: Traversable[WidgetSpec],
    nameFieldMap: Map[String,  Field]
)

@editableChartType(chartType: Option[ChartType.Value]) = {
    <select id="chartType" name="chartType">
        <option value="" @if(chartType.isEmpty) {selected="selected"}></option>
        @ChartType.values.map { _chartType =>
            <option value="@{_chartType}" @if(chartType.isDefined && chartType.get == _chartType) {selected="selected"}>@{_chartType}</option>
        }
    </select>
}

@hiddenElement(id: String, value: Any) = {
    <input type="hidden" id="@id" value="@value">
}


@fieldLabel(fieldName: String) = @{
    nameFieldMap.get(fieldName).map(_.labelOrElseName).getOrElse(fieldName)
}

@fieldLabels(widgetSpec: WidgetSpec) = {
    @widgetSpec.fieldNames.map( fieldName => fieldLabel(fieldName) ).mkString(", ")
}


@fieldLabelElements(fieldNames: Seq[(String, String)]) = {
    @fieldNames.map{ fieldName =>
        @hiddenElement(fieldName._1, fieldLabel(fieldName._2))
    }
}

@fieldTypeaheadElements(widgetSpec: WidgetSpec) = {
    @{
        widgetSpec match {
            case x: DistributionWidgetSpec =>
                fieldLabelElements(Seq(
                    ("fieldNameTypeahead", x.fieldName)) ++
                    x.groupFieldName.map( ("groupFieldNameTypeahead", _)
                ))
            case x: CumulativeCountWidgetSpec =>
                fieldLabelElements(Seq(
                    ("fieldNameTypeahead", x.fieldName)) ++
                    x.groupFieldName.map( ("groupFieldNameTypeahead", _)
                ))
            case x: BoxWidgetSpec =>
                fieldLabelElements(Seq(
                    ("fieldNameTypeahead", x.fieldName)
                ))
            case x: ScatterWidgetSpec =>
                fieldLabelElements(Seq(
                    ("xFieldNameTypeahead", x.xFieldName),
                    ("yFieldNameTypeahead", x.yFieldName)) ++
                    x.groupFieldName.map( ("groupFieldNameTypeahead", _)
                ))
            case x: BasicStatsWidgetSpec =>
                fieldLabelElements(Seq(
                    ("fieldNameTypeahead", x.fieldName)
                ))
            case _ => ""
        }
    }
}

@dataHiddenElement(widgetSpec: WidgetSpec) = {
    @{
        Json.toJson(widgetSpec).as[JsObject].-("displayOptions").fields.map {
            case (fieldName, jsValue) => hiddenElement(fieldName, JsonUtil.toString(jsValue))
        } ++ Seq(fieldTypeaheadElements(widgetSpec))
    }

}

@concreteClassName(clazz: Class[_]) = @{
    clazz.getName.split("\\.")(1).replaceAll("WidgetSpec", "")
}

@gridWidthElement(widgetSpec: WidgetSpec) = {
    <input type="text" id="gridWidth" style="width:40px" value="@widgetSpec.displayOptions.gridWidth.getOrElse("")">
}

@gridOffsetElement(widgetSpec: WidgetSpec) = {
    <input type="text" id="gridOffset" style="width:40px" value="@widgetSpec.displayOptions.gridOffset.getOrElse("")">
}

@heightElement(widgetSpec: WidgetSpec) = {
    <input type="text" id="height" style="width:60px" value="@widgetSpec.displayOptions.height.getOrElse("")">
}

@isTextualFormElement(widgetSpec: WidgetSpec) = {
    <input type="checkbox" id="isTextualForm" name="isTextualForm" @if(widgetSpec.displayOptions.isTextualForm) { checked="checked"}/>
}

@spec(widgetSpec: WidgetSpec) = {
    <a href="#" class="widget-table-cell" onclick="showEditModal(this)">
        <div class="row">
            Fields: @fieldLabels(widgetSpec)
        </div>
        <div class="row">
            @{widgetSpec match {
                case x: DistributionWidgetSpec => x.numericBinCount.map( count => "Numeric Bin Count: " + count).getOrElse("")
                case x: CumulativeCountWidgetSpec => x.numericBinCount.map( count => "Numeric Bin Count: " + count).getOrElse("")
                case x: TemplateHtmlWidgetSpec => "Content: " + Html(util.shorten(x.content, 50))
                case _ => ""
            }}
        </div>
    </a>
}

@table = {
    @displayTable(
        items,
        typeColumns[WidgetSpec](
            (None, "", _ => {<input type="checkbox" class="table-selection"/>}),
            (None, "", dataHiddenElement),
            (None, "Type", {x => concreteClassName(x.getClass)}),
            (None, "Content", spec),
            (None, "Grid Offset", gridOffsetElement),
            (None, "Grid Width", gridWidthElement),
            (None, "Height", heightElement),
            (None, "Textual?", isTextualFormElement),
            (None, "Chart Type", {x =>
                if(x.displayOptions.isInstanceOf[MultiChartDisplayOptions]) {
                    editableChartType(x.displayOptions.asInstanceOf[MultiChartDisplayOptions].chartType)
                } else ""
            })
        )
    )
}

@rowToModelJsFun = {
    function(row) {
        var model = widgetRowToModel(row);
        return JSON.stringify(model);
    }
}

@modalItemToRowJsFun = {
    function(values) {

        // fields
        var concreteClass = values["concreteClass"].trim()
        var fields = getWidgetFieldsWithoutDisplayOptions(concreteClass);
        var labelFields = getWidgetLabelFields(concreteClass);
        fields.push("concreteClass")
        fields = fields.concat(labelFields)

        // data column
        var dataColumn = $("<td></td>")
        $.each(fields, function( index, fieldName ) {
            dataColumn.append("<input type='hidden' id='" + fieldName + "' value='" + values[fieldName] + "'/>");
        });


        // display content column
        var fieldLabels = labelFields.map(function(labelField) {
            return values[labelField];
        }).join(", ");

        var contentDisplayColumn = $("<td></td>")
        var contentHrefElement = $("<a href='#' class='widget-table-cell' onclick='showEditModal(this)'></a>")
        contentHrefElement.append("<div class='row'>Fields: " + fieldLabels + "</div>")

        var isDistributionOrCumulativeCountType = concreteClass == "@{classOf[DistributionWidgetSpec].getName}" || concreteClass == "@{classOf[CumulativeCountWidgetSpec].getName}"
        var isTemplateHtmlType = concreteClass == "@{classOf[TemplateHtmlWidgetSpec].getName}"

        var numericBinCount = values["numericBinCount"]
        var numericBinCountLabelValue =  (isDistributionOrCumulativeCountType && numericBinCount) ? ("Numeric Bin Count: " + numericBinCount) : "";
        var contentLabelValue =  (isTemplateHtmlType) ? ("Content: " + values["content"]) : "";
        contentHrefElement.append("<div class='row'>" + numericBinCountLabelValue + contentLabelValue + "</div>")
        contentDisplayColumn.append(contentHrefElement)


        // display options
        var gridOffsetColumn = "<td><input type='text' id='gridOffset' style='width:40px' value=''/></td>";
        var gridWidthColumn = "<td><input type='text' id='gridWidth' style='width:40px' value=''/></td>";
        var heightColumn = "<td><input type='text' id='height' style='width:60px' value=''/></td>";
        var isTextualFormColumn = "<td><input type='checkbox' id='isTextualForm' name='isTextualForm'/></td>";
        var chartTypeColumn = (isDistributionOrCumulativeCountType) ? `<td>@editableChartType(None)</td>` : "<td></td>";


        // concrete class name and check box columns
        var concreteClassName = concreteClass.replace('models.','').replace('WidgetSpec','')
        var checkboxColumn = "<td><input type='checkbox' class='table-selection'></input></td>";
        var concreteClassNameColumn = "<td>" + concreteClassName + "</td>";


        // create row
        var row = $("<tr></tr>")
        row.append(checkboxColumn)
        row.append(dataColumn)
        row.append(concreteClassNameColumn)
        row.append(contentDisplayColumn)
        row.append(gridOffsetColumn)
        row.append(gridWidthColumn)
        row.append(heightColumn)
        row.append(isTextualFormColumn)
        row.append(chartTypeColumn)

        return row;
    }
}

@concreteClassOptions = {
    @widgetSpecClasses.map { clazz =>
        <option value="@{clazz.getName}">@concreteClassName(clazz)</option>
    }
}

@editModalButtons = {
    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    <button type="button" class="btn btn-primary" id="editWidgetSpecSubmitButton" data-dismiss="modal">OK</button>
}

@modal("edit_widgetSpecModal", "Edit Widget Spec", modalInner("edit_widgetSpecModal"), None, Some(editModalButtons))

@labelValueAux(key: String, label: Any)(valueElement : Any) = {
    @labelValue(key, label, false, None, 3)(valueElement)
}

@modalInner(modalName: String) = {
    <div class="row">
            <div id="concreteClassDiv">
                @labelValueAux("concreteClass", "Type") {
                    <select id="concreteClass" onchange="updateModalItems('@modalName');">
                        @concreteClassOptions
                    </select>
                }
            </div>

            <div id="fieldNameDiv" style="display: none">
                @labelValueAux("fieldName", "Field") {
                    <input type="text" id="fieldNameTypeahead" class="typeahead">
                    <input type="hidden" id="fieldName">
                }
            </div>

            <div id="xFieldNameDiv" style="display: none">
                @labelValueAux("xFieldName", "X Field") {
                    <input type="text" id="xFieldNameTypeahead" class="typeahead">
                    <input type="hidden" id="xFieldName">
                }
            </div>

            <div id="yFieldNameDiv" style="display: none">
                @labelValueAux("yFieldName", "Y Field") {
                    <input type="text" id="yFieldNameTypeahead" class="typeahead">
                    <input type="hidden" id="yFieldName">
                }
            </div>

            <div id="groupFieldNameDiv" style="display: none">
                @labelValueAux("groupFieldName", "Group Field") {
                    <input type="text" id="groupFieldNameTypeahead" class="typeahead">
                    <input type="hidden" id="groupFieldName">
                }
            </div>

            <div id="fieldNamesDiv" style="display: none">
                @labelValueAux("fieldNames", "Fields") {
                    <input type="text" id="fieldNames">
                }
            </div>


            <div id="contentDiv" style="display: none">
                @labelValueAux("content", "Content") {
                    <textarea id="content" rows="15" cols="40"></textarea>
                }
            </div>

            <div id="numericBinCountDiv" style="display: none">
                @labelValueAux("numericBinCount", "Numeric Bin #") {
                    <input type="text" id="numericBinCount">
                }
            </div>
    </div>
}

@dynamicTable("widgetSpec", table, true, rowToModelJsFun, modalItemToRowJsFun, modalInner("add_widgetSpecModal"), None, 12)

<script type="text/javascript">

     $("#add_widgetSpecModal #content").keypress(function (e) {
        if (e.which == 13) {
            e.stopPropagation();
        }
     });

     $("#edit_widgetSpecModal #content").keypress(function (e) {
        if (e.which == 13) {
            e.stopPropagation();
        }
     });

     handleModalButtonEnterPressed("edit_widgetSpecModal", "editWidgetSpecSubmitButton", function() {
         var values = getModalValues("edit_widgetSpecModal");
         $('#widgetSpecDiv').dynamicTable('replaceTableRow', values)
     })

     function setIfNotNull(item, fieldName, value) {
        if (value)
            item[fieldName] = value
    }

    function widgetRowToModel(row) {
        function getValue(elementId) {
            var element = row.find('#' + elementId);
            return (element.length > 0) ? element.val().trim() : null;
        }

        function getIntValue(elementId, defaultNaNValue) {
            var value = getValue(elementId)
            var intValue = null;
            if (value && value.length > 0) {
                intValue = parseInt(value)
                if (isNaN(intValue)) {
                    intValue = defaultNaNValue
                }
            }
            return intValue;
        }

        var output = {};
        var concreteClass = getValue('concreteClass')
        output["concreteClass"] = concreteClass

        var fields = getWidgetFieldsWithoutDisplayOptions(concreteClass);
        var labelFields = getWidgetLabelFields(concreteClass);
        fields = fields.concat(labelFields)

        $.each(fields, function(index, fieldName) {
            setIfNotNull(output, fieldName, getValue(fieldName))
        });

        // numeric bin count is integer hence we need to do the setting again
        setIfNotNull(output, "numericBinCount", getIntValue("numericBinCount", 20))

        // display options
        var displayOptions = {};
        setIfNotNull(displayOptions, "gridOffset", getIntValue('gridOffset', 0))
        setIfNotNull(displayOptions, "gridWidth", getIntValue('gridWidth', 4))
        setIfNotNull(displayOptions, "height", getIntValue('height', 400))
        setIfNotNull(displayOptions, "chartType", getValue('chartType'))
        displayOptions["isTextualForm"] = row.find('#isTextualForm').is(':checked')
        output["displayOptions"] = displayOptions;

        return output;
    }

    function hideAll(modalName) {
        $("#" + modalName + " #fieldNameDiv").hide();
        $("#" + modalName + " #xFieldNameDiv").hide();
        $("#" + modalName + " #yFieldNameDiv").hide();
        $("#" + modalName + " #groupFieldNameDiv").hide();
        $("#" + modalName + " #contentDiv").hide();
        $("#" + modalName + " #numericBinCountDiv").hide();
    }

    function showEditModal(source) {
        var row = $(source.closest("tr"))
        var model = widgetRowToModel(row);

        $('#edit_widgetSpecModal #concreteClass').val(model["concreteClass"]).change();

        $('#edit_widgetSpecModal #fieldName').val(model["fieldName"]);
        $('#edit_widgetSpecModal #xFieldName').val(model["xFieldName"]);
        $('#edit_widgetSpecModal #yFieldName').val(model["yFieldName"]);
        $('#edit_widgetSpecModal #groupFieldName').val(model["groupFieldName"]);
        $('#edit_widgetSpecModal #fieldNames').val(model["fieldNames"]);

        $('#edit_widgetSpecModal #fieldNameTypeahead').val(model["fieldNameTypeahead"]);
        $('#edit_widgetSpecModal #xFieldNameTypeahead').val(model["xFieldNameTypeahead"]);
        $('#edit_widgetSpecModal #yFieldNameTypeahead').val(model["yFieldNameTypeahead"]);
        $('#edit_widgetSpecModal #groupFieldNameTypeahead').val(model["groupFieldNameTypeahead"]);

        $('#edit_widgetSpecModal #content').val(model["content"]);
        $('#edit_widgetSpecModal #numericBinCount').val(model["numericBinCount"]);

        $("#edit_widgetSpecModal").modal("show");
    }

    function updateModalItems(modalName) {
        var concreteClass = $('#' + modalName + ' #concreteClass').val();
        hideAll(modalName);

        var fields = getWidgetFieldsWithoutDisplayOptions(concreteClass);

        $.each(fields, function( index, fieldName ) {
            $("#" + modalName + " #" + fieldName + "Div").show();
        });
    }

    function getWidgetFields(concreteClass) {
        var fieldNames = []
        switch (concreteClass) {
            @widgetSpecClasses.map { clazz =>
                case "@{clazz.getName}" :
                    fieldNames = [@getCaseClassMethodNamesAndTypes(clazz.getName).map{ case (name, _) => "@name", } ];
                    break;

            }
        }
        return fieldNames;
    }

    function getWidgetFieldsWithoutDisplayOptions(concreteClass) {
        var fields = getWidgetFields(concreteClass);
        var index = fields.indexOf("displayOptions");
        if (index > 1) {
            fields.splice(index, 1);
        }
        return fields;
    }

    function getWidgetLabelFields(concreteClass) {
        var labelFields = [];

        switch (concreteClass) {
            case "@{classOf[DistributionWidgetSpec].getName}" :
                labelFields = ["fieldNameTypeahead", "groupFieldNameTypeahead"];
                break;
            case "@{classOf[CumulativeCountWidgetSpec].getName}" :
                labelFields = ["fieldNameTypeahead", "groupFieldNameTypeahead"];
                break;
            case "@{classOf[BoxWidgetSpec].getName}" :
                labelFields = ["fieldNameTypeahead"];
                break;
            case "@{classOf[ScatterWidgetSpec].getName}" :
                labelFields = ["xFieldNameTypeahead", "yFieldNameTypeahead", "groupFieldNameTypeahead"];
                break;
            case "@{classOf[CorrelationWidgetSpec].getName}" :
                break;
            case "@{classOf[BasicStatsWidgetSpec].getName}" :
                labelFields = ["fieldNameTypeahead"];
                break;
            case "@{classOf[TemplateHtmlWidgetSpec].getName}" :
                break;
        }
        return labelFields;
    }
</script>
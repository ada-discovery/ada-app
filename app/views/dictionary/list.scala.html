@import models.Field
@import views.html.layout
@import views.html.dataset.{filterChartPanel, datasetSubNav, datasetMenu}
@import views.html.table.paginatedTable
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.chart.chartPanelJs
@import views.html.modal
@import views.html.exportDropdown
@import models.FieldChartSpec
@import util.typeColumns
@import controllers.dataset.{DictionaryRouter, DictionaryJsRouter}
@import controllers.dataset.routes.{DataSetSettingController => dataSetSettingRoutes}
@import models.DataSpaceMetaInfo
@import be.objectify.deadbolt.scala.views.html.restrict
@import models.security.SecurityRole

@(
    domainName : String,
    page: Page[Field],
    fieldChartSpecs: Iterable[FieldChartSpec],
    router: DictionaryRouter,
    fieldNameLabels: Traversable[(String, Option[String])],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo],
    chartGridWidth: Int = 3
)(
    implicit flash: play.api.mvc.Flash, msg: play.api.i18n.Messages, request: Request[_]
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filter(
                page.filter,
                router.plainList,
                Left(fieldNameLabels.map { case (name, label) => Field(name, label)}),
                Some(FilterShowFieldStyle.LabelsOnly)
            )
        </div>
        <div class="pull-right">
            <ul class="list-inline">
                <li>
                    @exportDropdown(
                        page.filterConditions,
                        router.exportCsv(_, true, None, _, _),
                        router.exportJson
                    )()
                </li>
                <li>
                    @restrict(roles = List(Array(SecurityRole.admin))) {
                        <a class="btn btn-info btn-sm" href="@router.inferDictionary">
                        @if(page.total.equals(0l) && page.filter.isEmpty) {Infer} else {(Re)Infer}
                        </a>
                    }
                </li>
            </ul>
        </div>
    </div>
    @if(page.total.equals(0l) && page.filter.isEmpty) {
        @modal("inferModal", "No Dictionary Found", Html("Do you want to infer one?"), Some(router.inferDictionary))
    }
}

@editableFieldLabelInput(field: Field) = {
    <input type="text" class="no-rowClicked fieldLabel" value='@{field.label.getOrElse("")}'/>
}

@table = {
    <div class="pull-right dropdown">
        <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a href="#" onclick="addFieldDistributionsToOverview();return false" data-toggle="tooltip" title="Add Distributions To Overview">
                    Distributions
                </a>
            </li>
            <li>
                <a href="#" onclick="addFieldBoxPlotsToOverview();return false" data-toggle="tooltip" title="Add Box Plots To Overview">
                    Box Plots
                </a>
            </li>
            <li>
                <a href="#" onclick="addFieldCorrelationToOverview();return false" data-toggle="tooltip" title="Add Correlation To Overview">
                    Correlation
                </a>
            </li>
            <li>
                <a href="#" onclick="addFieldsToOverviewTable();return false" data-toggle="tooltip" title="Add To Table">
                    Table
                </a>
            </li>
        </ul>
    </div>
    @paginatedTable(
        page,
        router.list(_, _, page.filterConditions),
        typeColumns[Field](
            (None, "", _ => {<input type="checkbox" class="no-rowClicked"/>}),
            (Some("name"), "Name", {field => util.JsonUtil.unescapeKey(field.name)}),
            (Some("fieldType"), "Type", _.fieldType),
            (Some("label"), "Label", editableFieldLabelInput),
            (Some("category.name"), "Category", _.category.map(_.name).getOrElse(""))
        ),
        Some({ item : Any => router.get(item.asInstanceOf[Field].name)}),
        Some("id", {any:Any => any.asInstanceOf[Field].name}),
        Some("dictionaryTable")
    )
}

@bottomResources = {
    @highchartsJsImport()
    @chartPanelJs(fieldChartSpecs.map(_.chartSpec))
}

@layout.list(
    domainName,
    page.total,
    Some(actions),
    table,
    Some(filterChartPanel(fieldChartSpecs, chartGridWidth)),
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav()),
    None,
    Some(bottomResources)
)

<script type="text/javascript" src="@dataSetSettingRoutes.jsRoutes"></script>
<script type="text/javascript" src="@router.jsRoutes"></script>
<script type="text/javascript">
    $(function () {
        $("#inferModal").modal()
        $(".fieldLabel").on("keydown",function(e) {
            if(e.keyCode == 13) {
                var id = getNearestRowId($(this), "id");
                var label = $(this).val();
                var that = $(this)
                if (label) {
                    dictionaryJsRoutes.controllers.dataset.DictionaryDispatcher.updateLabel(id, label).ajax( {
                        success: function() {
                            showMessage("The field '" + id + "' has been successfully relabeled to '" + label + "'.");
                        },
                        error: function(data){
                            showError( data.responseText );
                        }
                    });
                }
                var inputs = that.closest('tbody').find('.fieldLabel');
                inputs.eq( inputs.index(that)+ 1 ).focus();
            }
        });
    })

    function addFieldDistributionsToOverview() {
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")
        jsRoutes.controllers.dataset.DataSetSettingController.addDistributionsToOverview('@{router.id}', fieldNames).ajax( {
            success: function() {
                showMessage("Distributions for the field(s) '" + fieldNames + "' have been successfully added to the overview.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }


    function addFieldBoxPlotsToOverview() {
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")
        jsRoutes.controllers.dataset.DataSetSettingController.addBoxPlotsToOverview('@{router.id}', fieldNames).ajax( {
            success: function() {
                showMessage("Box plots for the field(s) '" + fieldNames + "' have been successfully added to the overview.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }

    function addFieldCorrelationToOverview() {
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")
        jsRoutes.controllers.dataset.DataSetSettingController.addCorrelationToOverview('@{router.id}', fieldNames).ajax( {
            success: function() {
                showMessage("Correlation for the field(s) '" + fieldNames + "' has been successfully added to the overview.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }

    function addFieldsToOverviewTable() {
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")
        jsRoutes.controllers.dataset.DataSetSettingController.addFieldsToOverviewTable('@{router.id}', fieldNames).ajax( {
            success: function() {
                showMessage("Field(s) '" + fieldNames + "' have been successfully added to the table.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }
</script>
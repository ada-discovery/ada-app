@import models.Field
@import views.html.layout
@import views.html.dataset.{filterChartPanel, datasetSubNav, datasetMenu}
@import views.html.table.paginatedTable
@import views.html.chart.highcharts.highchartsJsImport
@import views.html.chart.chartPanelJs
@import views.html.modal
@import views.html.exportDropdown
@import views.html.dataview.dataViewSelectionModal
@import views.html.category.categorySelectionModal
@import views.html.filter.filter
@import models.FieldChartSpec
@import util.typeColumns
@import controllers.dataset.{DataViewRouter, DataViewJsRouter, DictionaryRouter, DictionaryJsRouter, CategoryRouter, CategoryJsRouter}
@import models.DataSpaceMetaInfo
@import be.objectify.deadbolt.scala.views.html.restrict
@import models.security.SecurityRole

@(
    domainName : String,
    page: Page[Field],
    fieldChartSpecs: Iterable[FieldChartSpec],
    router: DictionaryRouter,
    dataViewRouter: DataViewRouter,
    dataViewJsRouter: DataViewJsRouter,
    categoryRouter: CategoryRouter,
    categoryJsRouter: CategoryJsRouter,
    fieldNameLabels: Traversable[(String, Option[String])],
    dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo],
    chartGridWidth: Int = 3
)(
    implicit flash: play.api.mvc.Flash, msg: play.api.i18n.Messages, request: Request[_]
)

@actions = {
    <div class="row">
        <div class="col-md-10">
            @filter(
                page.filter,
                router.plainList,
                Left(fieldNameLabels.map { case (name, label) => Field(name, label)}),
                None,
                Some(FilterShowFieldStyle.LabelsOnly)
            )
        </div>
        <div class="pull-right">
            <ul class="list-inline">
                <li>
                    @exportDropdown(
                        page.filterConditions,
                        router.exportCsv(_, true, None, _, _),
                        router.exportJson
                    )()()
                </li>
            </ul>
        </div>
    </div>
    @dataViewSelectionModal("dataViewSelectionModal", dataViewRouter)
    @categorySelectionModal("categorySelectionModal", categoryRouter)
}

@editableFieldLabelInput(field: Field) = {
    <input type="text" class="no-rowClicked fieldLabel" value='@{field.label.getOrElse("")}'/>
}

@table = {
    <div class="pull-right dropdown">
        <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>To
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a href="#" onclick="addFieldDistributions();return false" data-toggle="tooltip" title="Add Distributions To View">
                    Distributions
                </a>
            </li>
            <li>
                <a href="#" onclick="addFieldBoxPlots();return false" data-toggle="tooltip" title="Add Box Plots To View">
                    Box Plots
                </a>
            </li>
            <li>
                <a href="#" onclick="addFieldCorrelation();return false" data-toggle="tooltip" title="Add Correlation To View">
                    Correlation
                </a>
            </li>
            <li>
                <a href="#" onclick="addTableFields();return false" data-toggle="tooltip" title="Add To View">
                    Table
                </a>
            </li>
            <li role="separator" class="divider"></li>
            <li>
                <a href="#" data-toggle="modal" data-target="#categorySelectionModal" title="Add To Category">
                    Category
                </a>
            </li>
        </ul>
    </div>
    @paginatedTable(
        page,
        router.list(_, _, page.filterConditions),
        typeColumns[Field](
            (None, "", _ => {<input type="checkbox" class="no-rowClicked"/>}),
            (Some("name"), "Name", {field => util.JsonUtil.unescapeKey(field.name)}),
            (Some("fieldType"), "Type", _.fieldType),
            (Some("label"), "Label", editableFieldLabelInput),
            (Some("categoryId"), "Category", _.category.map(_.name).getOrElse(""))
        ),
        Some({ item : Any => router.get(item.asInstanceOf[Field].name)}),
        Some("id", {any:Any => any.asInstanceOf[Field].name}),
        Some("dictionaryTable")
    )
}

@bottomResources = {
    @highchartsJsImport()
    @chartPanelJs(fieldChartSpecs.map(_.chartSpec))
}

@layout.list(
    domainName,
    page.total,
    Some(actions),
    table,
    Some(filterChartPanel("filterDiv", fieldChartSpecs, chartGridWidth)),
    Some(datasetMenu(dataSpaceMetaInfos)),
    Some(datasetSubNav()),
    None,
    Some(bottomResources)
)

@helper.javascriptRouter("dataViewJsRoutes")(
    dataViewJsRouter.addDistributions,
    dataViewJsRouter.addBoxPlots,
    dataViewJsRouter.addScatter,
    dataViewJsRouter.addCorrelation,
    dataViewJsRouter.addTableFields
)

<script type="text/javascript" src="@router.jsRoutes"></script>
<script type="text/javascript" src="@categoryRouter.jsRoutes"></script>
<script type="text/javascript">
    $(function () {
        $("#inferModal").modal()
        $(".fieldLabel").on("keydown",function(e) {
            if(e.keyCode == 13) {
                var id = getNearestRowId($(this), "id");
                var label = $(this).val();
                var that = $(this)
                if (label) {
                    dictionaryJsRoutes.controllers.dataset.DictionaryDispatcher.updateLabel(id, label).ajax( {
                        success: function() {
                            showMessage("The field '" + id + "' has been successfully relabeled to '" + label + "'.");
                        },
                        error: function(data){
                            showError( data.responseText );
                        }
                    });
                }
                var inputs = that.closest('tbody').find('.fieldLabel');
                inputs.eq( inputs.index(that)+ 1 ).focus();
            }
        });

        $("#categorySelectionModal #submitButton").on("click", addFieldsToCategory)
    })

    function addFieldDistributions() {
        var handler = function(e) {
            addFieldDistributionsToView();
        };

        $("#dataViewSelectionModal #submitButton").one( "click", handler );
        $("#dataViewSelectionModal").modal('show');
    }

    function addFieldBoxPlots() {
        var handler = function(e) {
            addFieldBoxPlotsToView();
        };

        $("#dataViewSelectionModal #submitButton").one( "click", handler );
        $("#dataViewSelectionModal").modal('show');
    }

    function addFieldCorrelation() {
        var handler = function(e) {
            addFieldCorrelationToView();
        };

        $("#dataViewSelectionModal #submitButton").one( "click", handler );
        $("#dataViewSelectionModal").modal('show');
    }

    function addTableFields() {
        var handler = function(e) {
            addTableFieldsToView();
        };

        $("#dataViewSelectionModal #submitButton").one( "click", handler );
        $("#dataViewSelectionModal").modal('show');
    }

    function addFieldDistributionsToView() {
        var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
        var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")

        dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addDistributions(dataViewId, fieldNames).ajax( {
            success: function() {
                showMessage("Distributions for the field(s) '" + fieldNames + "' have been successfully added to the view '" + dataViewName + "'.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }

    function addFieldBoxPlotsToView() {
        var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
        var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")

        dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addBoxPlots(dataViewId, fieldNames).ajax( {
            success: function() {
                showMessage("Box plots for the field(s) '" + fieldNames + "' have been successfully added to the view '" + dataViewName + "'.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }

    function addFieldCorrelationToView() {
        var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
        var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")

        dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addCorrelation(dataViewId, fieldNames).ajax( {
            success: function() {
                showMessage("Correlation for the field(s) '" + fieldNames + "' has been successfully added to the view '" + dataViewName + "'.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }

    function addTableFieldsToView() {
        var dataViewId = $("#dataViewSelectionModal #dataViewId").val().trim()
        var dataViewName = $("#dataViewSelectionModal #dataViewTypeahead").val().trim()
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")

        dataViewJsRoutes.controllers.dataset.DataViewDispatcher.addTableFields(dataViewId, fieldNames).ajax( {
            success: function() {
                showMessage("Field(s) '" + fieldNames + "' have been successfully added to the table of the view '" + dataViewName + "'.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }

    function addFieldsToCategory() {
        var categoryId = $("#categorySelectionModal #categoryId").val().trim()
        var categoryName = $("#categorySelectionModal #categoryTypeahead").val().trim()
        var fieldNames = getCheckedTableIds("dictionaryTable", "id")

        categoryJsRoutes.controllers.dataset.CategoryDispatcher.addFields(categoryId, fieldNames).ajax( {
            success: function() {
                showMessage("Field(s) '" + fieldNames + "' have been successfully added to the category '" + categoryName + "'.");
            },
            error: function(data){
                showError( data.responseText );
            }
        });
    }
</script>
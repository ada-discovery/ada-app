@import controllers.sampleRequest.routes.{SampleRequestController => sampleRequestRoutes}
@import org.ada.server.models.{DataSetSetting, DataSpaceMetaInfo, Filter}
@import org.ada.web.controllers.FilterConditionExtraFormats.coreFilterConditionFormat
@import org.ada.web.controllers.dataset.DataSetWebContext._
@import org.ada.web.controllers.dataset.{DataSetWebContext, TableViewData}
@import org.ada.web.util.toJsonHtml
@import reactivemongo.bson.BSONObjectID
@import views.html.chart.highcharts.{highchartsJsImport, highchartsJsImportForBulkExport}
@import views.html.dataset.filter.dataSetFilterJs
@import views.html.dataset.view.{viewCountFilters, viewTables}
@import views.html.dataset._
@import views.html.layout
@import services.CatalogueItem

@(
        catalogueItems: Seq[CatalogueItem],
        dataViewId: BSONObjectID,
        tableViewParts: Seq[TableViewData],
        dataSetSetting: DataSetSetting,
        dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo]
)(
        implicit context: DataSetWebContext
)

@actionsDiv = {
    <div class="row">
        <div id="singleFilterDiv" class="col-md-10">
        @if(tableViewParts.size == 1) {
            @viewCountFilters(tableViewParts, dataSetSetting.filterShowFieldStyle, true)
        }
        </div>
        <div class="pull-right">
            <button class="btn btn-info btn-sm" type="button" onclick="submitForm();">
                Request Samples
            </button>
        </div>
        <div>
            @catalogueItemDropdown
        </div>
        <div>
            <a id="remsLink" href="" target="_blank"></a>
        </div>
    </div>
}

@catalogueItemDropdown = {
    <select id="remsCatalogueItemDropdown">
        @catalogueItems.map { item =>
            <option value='{"id": @item.id, "formId": @item.formId}'>@item.name</option>
        }
    </select>
}

@widgets = {
@fixedTableRow("widgetsTr")()
}

@filtersAndWidgets = {
    <div id="multiFilterDiv">
    @if(tableViewParts.size > 1) {
        @viewCountFilters(tableViewParts, dataSetSetting.filterShowFieldStyle, false)
    }
    </div>
    <hr class="multi-filter-divider" @if(tableViewParts.size < 2) { style="display:none" } ></hr>
@widgets
}

    @jsonConditions(filter: Option[Filter]) = @{
    toJsonHtml(filter.map(_.conditions).getOrElse(Nil))
}

    @stringFilterId(filter: Option[Filter]) = @{
    filter.flatMap(_._id.map(_.stringify)).getOrElse("")
}




    @bottomResources = {

    @helper.javascriptRouter("dataSetJsRoutes")(
        dataSetJsRouter.getWidgets,
        dataSetJsRouter.getFieldValue,
        dataSetJsRouter.getViewElementsAndWidgetsCallback,
        dataSetJsRouter.getNewFilterViewElementsAndWidgetsCallback
    )

    @helper.javascriptRouter("dataViewJsRoutes")(
        dataViewJsRouter.saveFilter
    )

    @highchartsJsImport()

    @dataSetFilterJs()

    @datasetSubNavJs()

    @highchartsJsImportForBulkExport()

    <script type="text/javascript">
        var defaultWidgetWidth = 12;
        var enforceWidth = false;

        $(function () {
            // activate filters
            var conditions = [@tableViewParts.map { viewPart => JSON.parse('@jsonConditions(viewPart.filter)'), }]
            var filterIds = [@tableViewParts.map { viewPart => '@stringFilterId(viewPart.filter)', }]

            var filters = $("#filtersTr").find(".filter-div")
            $.each(filters, function (index, filter) {
                var filterId = filterIds[index]
                if (!filterId)
                    filterId = null

                activateFilter($(filter), conditions[index], filterId);
            })

            // link the first filter to export modals
            var firstFilter = filters.first()
            addFilterModelBeforeModalSubmit("exportFilteredCsvModal", firstFilter, "filter");
            addFilterModelBeforeModalSubmit("exportFilteredTableCsvModal", firstFilter, "filter");
            addFilterModelBeforeModalSubmit("exportFilteredJsonModal", firstFilter, "filter");
            addFilterModelBeforeModalSubmit("exportFilteredTableJsonModal", firstFilter, "filter");
        })

        function activateFilter(filterElement, jsonConditions, filterId) {
            var submitAjaxFun = function(filterOrId) {
                refreshViewForFilter('@{dataViewId.stringify}', filterOrId, filterElement, defaultWidgetWidth, enforceWidth, true);
            }

            activateDataSetFilterAux(
                    filterElement,
                    jsonConditions,
                    filterId,
                    submitAjaxFun
            )
        }

        function setFullWidth() {
            var widgets = $("#widgetsTr .chart-holder")
            $.each(widgets, function (index, widget) {
                $(widget).parent().attr("class", "col-md-12");
            })

            defaultWidgetWidth = 12;
            enforceWidth = true;

            refreshHighcharts();
        }

        function addNewColumn() {
            if($("#filtersTr>td").length == 1) {
                $(".filter-count-div").show()
                $("#multiFilterDiv").append($("#singleFilterDiv>table"));
                $(".multi-filter-divider").show();
            }
            addNewViewColumn('@{dataViewId.stringify}', defaultWidgetWidth, enforceWidth, activateFilter)
        }

        function removeColumnRight() {
            if($("#filtersTr>td").length > 1) {
                $("#filtersTr td:last-child").remove();
                $("#widgetsTr td:last-child").remove();
                $("#tablesTr td:last-child").remove();

                if($("#filtersTr>td").length == 1) {
                    $(".filter-count-div").hide();
                    $("#singleFilterDiv").append($("#multiFilterDiv>table"));
                    $(".multi-filter-divider").hide();
                }

                var totalCount = getViewTotalCount();
                var oldHeader = $(".page-header>h3").html().trim()
                var oldHeaderText = oldHeader.substr(oldHeader.indexOf(" "))
                $(".page-header").html("<h3>" + totalCount + oldHeaderText + "</h3>");

                refreshHighcharts();

                showMessage("The right-most column/filter successfully removed from the view.")
            } else {
                hideMessages();
                showError("No more columns/filters to remove.")
            }
        }

        function submitForm() {
            const action = '@Html(sampleRequestRoutes.submitRequest(
                -1,
                -1,
                dataSetSetting.dataSetId,
                tableViewParts.head.tableFields.map(_.name).toVector,
                Nil,
                Nil
            ).url)'
            const option = JSON.parse($('#remsCatalogueItemDropdown').val())
            const params = {
                catalogueItemId: option.id,
                catalogueFormId: option.formId
            }
            const form = $('<form></form>');
            form.attr("method", "POST");
            form.attr("action", action);
            addParams(form, params)
            $.ajax({
                type: form.attr('method'),
                url: form.attr('action'),
                data: form.serialize(),
                success: function(url) {
                    const a = $('#remsLink')
                    a.text(url)
                    a.attr('href', url)
                },
                error: function(ctx) {
                  alert(ctx.responseText)
                }
            });
        }
    </script>
}

@sideMenu = @{
    if(dataSetSetting.showSideCategoricalTree) {
        dataSetFullMenu(dataSpaceMetaInfos, dataSetRouter)
    } else {
        datasetMenu(dataSpaceMetaInfos)
    }
}

@layout.list(
    "Sample",
    Some("Request Samples"),
    tableViewParts.map(_.page.total).sum,
    Some(actionsDiv),
    if(tableViewParts.exists(_.tableFields.nonEmpty)) {
        Some(viewTables(dataViewId, tableViewParts, true))
    } else {
        None
    },
    Some(filtersAndWidgets),
    Some(sideMenu),
    Some(datasetSubNav(dataSetSetting)),
    None,
    Some(bottomResources)
)
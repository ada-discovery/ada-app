@import org.ada.server.models.{DataSetSetting, DataSpaceMetaInfo}
@import org.ada.web.controllers.dataset.{DataSetWebContext, TableViewData}
@import org.ada.web.controllers.dataset.DataSetWebContext._
@import reactivemongo.bson.BSONObjectID
@import views.html.dataset.view.coreView
@(
        dataViewId: BSONObjectID,
        tableViewParts: Seq[TableViewData],
        dataSetSetting: DataSetSetting,
        dataSpaceMetaInfos: Traversable[DataSpaceMetaInfo],
        widgetGridElementWidth: Int
)(
        implicit context: DataSetWebContext
)

@actions = {
    <div>
        <div class="form-group">
            <button id="btnSamplesRequest" class="btn btn-info btn-sm" type="button" onclick="submitRequest();">
                Request Samples
            </button>
        </div>

        <div id="application-link" class="form-group">
            <label for="podiumLink">Direct Link to Application:</label><br/>
            <a id="podiumLink" href="" target="_blank"></a>
        </div>


        <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="errorModalLabel">Error during samples submission</h5>
                    </div>
                    <div class="modal-body">
                        <iframe id="errorFrame" style="display: block; width: 100%"></iframe>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
}

@extraBottomResources = {
    @helper.javascriptRouter("sampleRequestJsRoutes")(
        controllers.sampleRequest.routes.javascript.SampleRequestController.submitRequest
    )
    <script type="text/javascript">
            $(function () {
                // get all the filters available
                var filters = $("#filtersTr").find(".filter-div")
                $("#widgetsTr").html("")
                $.each(filters, function (i, filter) {
                    var td = $("<td style='vertical-align:top'>")
                    var row = $("<div class='row'>")
                    td.append(row)
                    $("#widgetsTr").append(td)
                })
                // generate (refresh) a view for each filter
                $.each(filters, function (index, filter) {
                    $(filter).multiFilter('submitFilter');
                })

            });

            function openErrorDialog(text) {
                var errorFrame = $("#errorFrame").contents().find('body');
                errorFrame.html(text);
                $('#errorModal').modal('show');
            }

            function btnLoading(elem) {
                $(elem).attr("data-original-text", $(elem).html());
                $(elem).prop("disabled", true);
                $(elem).html('<i class="spinner-border spinner-border-sm"></i> Please wait ...');
            }

            function btnReset(elem) {
                $(elem).prop("disabled", false);
                $(elem).html($(elem).attr("data-original-text"));
            }

            function submitRequest() {
                const dataSetId = '@dataSetSetting.dataSetId';
                const selectedIds = Array.from(getSelectedRowMap().keys());
                const sampleRequestParam = {
                    'dataSetId': dataSetId,
                    'tableColumnNames': '@tableViewParts.head.tableFields.map(_.name).toVector.mkString("\t")'.split("\t"),
                    'selectedIds': selectedIds
                }
                btnLoading("#btnSamplesRequest")
                if(selectedIds.length === 0) {
                    alert("Please select at least one sample.")
                    btnReset("#btnSamplesRequest")
                } else {
                    sampleRequestJsRoutes.controllers.sampleRequest.SampleRequestController.submitRequest(dataSetId).ajax({
                        data: JSON.stringify(sampleRequestParam),
                        contentType: 'application/json',
                        success: function(url) {
                            btnReset("#btnSamplesRequest")
                            if (url.includes("<!DOCTYPE html>")) {
                                openErrorDialog(url)
                            } else {
                                const a = $('#podiumLink')
                                a.text(url)
                                a.attr('href', url)
                            }
                        },
                        error: function(ctx) {
                            btnReset("#btnSamplesRequest")
                            openErrorDialog(ctx.responseText)
                        }
                    })
                }
            }
    </script>
}

@coreView(
    "Request Samples",
    "Sample",
    dataViewId,
    tableViewParts,
    widgetGridElementWidth,
    dataSetSetting,
    actions,
    Some(extraBottomResources),
    tableRowSelection = true,
    dataSpaceMetaInfos
)
@import org.ada.server.models.{DataSetSetting, FilterShowFieldStyle}
@import org.ada.web.controllers.dataset.DataSetWebContext
@import org.ada.web.controllers.dataset.DataSetWebContext._
@import org.ada.web.controllers.dataset.omics.routes.{OmicsDataSetController => omicsRoutes}
@import views.html.elements.typeahead
@(dataSetSetting: DataSetSetting)(implicit context: DataSetWebContext)

@modalBody = {
    <p id="omicsDataSetId">@typeahead("dataSetIdTypeahead", "dataSetId", "Data Set Id", isLarge = true, None, Option("invisible"))<p>
}

@modalButtons = {
    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    <button type="submit" id="omicsSubmitButton" class="btn btn-primary" onclick="searchInOmicsDataSet()">Search</button>
}

<a class="btn btn-info btn-sm" data-toggle="modal" data-target="#joinOmicsDataSetModal" title="Search in another Data Set">
    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
    Omics Search
</a>

@modal("joinOmicsDataSetModal", "Search in another Omics Data Set", modalBody, None, Some(modalButtons), None)


@helper.javascriptRouter("fieldAndNamesJsRoute")(
    org.ada.web.controllers.dataset.omics.routes.javascript.OmicsDataSetController.getFieldsNamesAndLabels
)

@helper.javascriptRouter("dataViewsJsRoute")(
    org.ada.web.controllers.dataset.omics.routes.javascript.OmicsDataSetController.getDataviews
)

@helper.javascriptRouter("getViewJsRoute")(
    org.ada.web.controllers.dataset.routes.javascript.DataSetDispatcher.getView
)

@helper.javascriptRouter("searchInOmicsJsRoute")(
    org.ada.web.controllers.dataset.routes.javascript.DataSetDispatcher.searchInOmics
)




<script type="text/javascript">

        $(function () {
            populateFieldTypeaheadFromUrl({
                typeaheadElement: $('#dataSetIdTypeahead'),
                fieldNameElement: $('#dataSetId'),
                url: '@Html(omicsRoutes.dataSetIds(dataSetSetting.dataSetId).url)',
                showOption: @FilterShowFieldStyle.LabelsOnly.id
            });
        })

        $(document).on('shown.bs.modal', '#joinOmicsDataSetModal', function (e) {
            checkFilterSelection()
        });

        function getSelectionFilterMessage(){
            return "<p id='selectFilterInfo' class='text-danger h4'> Please select a filter before submitting an Omics search.</p>"
        }

        function disableOmicsSearch(){
            if($("#selectFilterInfo").length == 0)
                $("#omicsDataSetId").before(getSelectionFilterMessage())

            if(!$("#dataSetIdTypeahead").hasClass("invisible"))
                $("#dataSetIdTypeahead").addClass("invisible")

            if(!$("#omicsSubmitButton").hasClass("disabled"))
                $("#omicsSubmitButton").addClass("disabled")
        }

        function enableOmicsSearch(){
            if($("#selectFilterInfo").length)
                $("#selectFilterInfo").remove()

            if($("#dataSetIdTypeahead").hasClass("invisible"))
                $("#dataSetIdTypeahead").removeClass("invisible")

            if($("#omicsSubmitButton").hasClass("disabled"))
                $("#omicsSubmitButton").removeClass("disabled")
        }


        function checkFilterSelection(){
            if(getFilters().length == 0) {
                disableOmicsSearch()
            } else {
                enableOmicsSearch()
            }

        }

        /*function getFilters(filters){
            var fieldName = "fieldName"
            var fieldLabel = "fieldLabel"
            var conditionType = "conditionType"
            var value = "value"
            var filterArr = []
            $.each(filters, function (index) {
                var conditions = $("#condition-full" + index).find(".condition > span")
                var filter = {fieldName:"","conditionType":"","value": "",fieldLabel: ""}
                $.each(conditions, function (){
                    if ($(this).attr("id") === fieldLabel){
                        filter[fieldName] = $(this).text()
                        filter[fieldLabel] = $(this).text()
                    } else if ($(this).attr("id") === conditionType){
                        filter[conditionType] = $(this).find("b").text()
                    } else if ($(this).attr("id") === "valueNotTrim") {
                        filter[value] = $(this).text()
                    }
                })
                filterArr.push(filter)
            })

            return filterArr
        }*/

        function getFilters(){
            var filterElements = $("#filtersTr").find(".filter-div").toArray();

            var filterOrIds = filterElements.map(function(filterElement, index) {
                return $(filterElement).multiFilter('getIdOrModel');
            });

            return filterOrIds[0]
        }


        function removeOmicsJoinFieldAndDataView(){
            if($("#omicsJoinField").length && $("#omicsdataView").length){
                $("#omicsJoinField").remove()
                $("#omicsdataView").remove()
            }
        }

        function generateOmicsJoinFieldAndDataView(){
            var omicsJoinField = "<p id='omicsJoinField'> <input id='joinFieldIdTypeahead' class='typeahead typeahead-large typeahead-full-width' type='text' placeholder='Join Field Id' value=''> <input id='joinFieldId' name='joinFieldId' type='hidden' value=''></p>"
            var omicsDataView = "<p id='omicsdataView'> <input id='dataViewIdTypeahead' class='typeahead typeahead-large typeahead-full-width' type='text' placeholder='Data view Id' value=''> <input id='dataViewId' name='dataViewId' type='hidden' value=''></p>"
            return omicsJoinField.concat(omicsDataView)
        }

        $('#dataSetIdTypeahead').blur(function (){
            if($(this).val()){
                removeOmicsJoinFieldAndDataView()
                $("#omicsDataSetId").after(generateOmicsJoinFieldAndDataView())

                var chosenDataSetId = $("#dataSetId").val()
                var urlFieldsAndName =  fieldAndNamesJsRoute.org.ada.web.controllers.dataset.omics.OmicsDataSetController.getFieldsNamesAndLabels(chosenDataSetId).url
                populateFieldTypeaheadFromUrl({
                    typeaheadElement: $('#joinFieldIdTypeahead'),
                    fieldNameElement: $('#joinFieldId'),
                    url: urlFieldsAndName,
                    showOption: @FilterShowFieldStyle.LabelsOnly.id
                });
                var urlDataViews = dataViewsJsRoute.org.ada.web.controllers.dataset.omics.OmicsDataSetController.getDataviews(chosenDataSetId).url
                populateFieldTypeaheadFromUrl({
                    typeaheadElement: $('#dataViewIdTypeahead'),
                    fieldNameElement: $('#dataViewId'),
                    url: urlDataViews,
                    showOption: @FilterShowFieldStyle.LabelsOnly.id
                });

            } else{
                removeOmicsJoinFieldAndDataView()
            }
        })


        function searchInOmicsDataSet(){
            var currentDataSetId = '@dataSetSetting.dataSetId'
            var dataSetIdToSearch = $("#dataSetId").val()
            var joinFieldId = $("#joinFieldId").val()
            var dataViewIdToSearch = $("#dataViewId").val()
            var filterOrIds = getFilters()

            searchInOmicsJsRoute.org.ada.web.controllers.dataset.DataSetDispatcher.searchInOmics(currentDataSetId, JSON.stringify(filterOrIds), dataViewIdToSearch, joinFieldId).ajax({
                success: function(res) {
                    var omicsFilterTmpId = res["omicsFilterTmpId"]
                    window.location.href = getViewJsRoute.org.ada.web.controllers.dataset.DataSetDispatcher.getView(dataViewIdToSearch, null, null, false, omicsFilterTmpId).url + "&dataSet=" + dataSetIdToSearch;
                },
                error: function(error) {
                    document.getElementsByTagName("html")[0].innerHTML = error
                }
            })

        }




</script>
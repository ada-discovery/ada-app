@import org.ada.server.models.{DataSetSetting, FilterShowFieldStyle}
@import org.ada.web.controllers.dataset.DataSetWebContext
@import org.ada.web.controllers.dataset.DataSetWebContext._
@import org.ada.web.controllers.dataset.omics.routes.{OmicsDataSetController => omicsRoutes}
@import views.html.elements.typeahead
@(dataSetSetting: DataSetSetting)(implicit context: DataSetWebContext)

@modalBody = {
    <p id="omicsDataSetId">@typeahead("dataSetIdTypeahead", "dataSetId", "Data Set Id", isLarge = true, None, Option("invisible"))<p>
    <div id="omicsSearchSummary" class="list-group invisible">
        <span class="list-group-item list-group-item-action flex-column align-items-start">
            <div class="d-flex w-100 justify-content-between">
                <h3 class="mb-1" style="margin-top: 10px">Query</h3>
            </div>
            <p id="omicsdataSetSearchInfo" class="mb-1"></p>
        </span>
        <span class="list-group-item list-group-item-action flex-column align-items-start">
            <div class="d-flex w-100 justify-content-between">
                <h4 class="mb-1">From</h4>
            </div>
            <p id="omicsCurrentDataSet" class="mb-1"></p>
            <p id="omicsCurrentDataSetJoinField" class="mb-1"></p>
            <p id="currentDataSetFilters" class="mb-1"></p>
        </span>
        <span class="list-group-item list-group-item-action flex-column align-items-start">
            <div class="d-flex w-100 justify-content-between">
                <h4 class="mb-1">To</h4>
            </div>
            <p id="omicsChosenDataSet" class="mb-1"></p>
            <p id="omicsChosenDataSetJoinField" class="mb-1"></p>
        </span>
    </div>
}

@modalButtons = {
    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    <button type="button" id="omicsSubmitButton" class="btn btn-primary" onclick="searchInOmicsDataSet()">Search</button>
}

<a class="btn btn-info btn-sm" data-toggle="modal" data-target="#joinOmicsDataSetModal" title="Search in another Data Set">
    <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
    Omics Search
</a>

@modal("joinOmicsDataSetModal", "Search in another Omics Data Set", modalBody, None, Some(modalButtons), None)


@helper.javascriptRouter("fieldAndNamesJsRoute")(
    org.ada.web.controllers.dataset.omics.routes.javascript.OmicsDataSetController.getFieldsNamesAndLabels
)

@helper.javascriptRouter("dataViewsJsRoute")(
    org.ada.web.controllers.dataset.omics.routes.javascript.OmicsDataSetController.getDataviews
)

@helper.javascriptRouter("getDataSetInfoJsRoute")(
    org.ada.web.controllers.dataset.omics.routes.javascript.OmicsDataSetController.getDataSetInfo
)

@helper.javascriptRouter("getViewJsRoute")(
    org.ada.web.controllers.dataset.routes.javascript.DataSetDispatcher.getView
)

@helper.javascriptRouter("searchInOmicsJsRoute")(
    org.ada.web.controllers.dataset.omics.routes.javascript.OmicsDataSetController.searchInOmics
)




<script type="text/javascript">

        $(function () {
            populateFieldTypeaheadFromUrl({
                typeaheadElement: $('#dataSetIdTypeahead'),
                fieldNameElement: $('#dataSetId'),
                url: '@Html(omicsRoutes.dataSetIds(dataSetSetting.dataSetId).url)',
                showOption: @FilterShowFieldStyle.LabelsOnly.id
            });
        })

        $(document).on('shown.bs.modal', '#joinOmicsDataSetModal', function (e) {
            refreshFilters()
        });

        function getFilterElements(){
            return $("#filtersTr").find(".filter-div").toArray();
        }

        function getFiltersOrIds(){
            var filterElements = getFilterElements()

            var filterOrIds = filterElements.map(function(filterElement, index) {
                return $(filterElement).multiFilter('getIdOrModel');
            });

            return filterOrIds
        }

        function removeHideOmicsInfos(){
            if($("#omicsdataView").length)
                $("#omicsdataView").remove()

            removeErrorSelection()
            makeInvisibleOmicsSearchSummary()
        }

        function makeInvisibleOmicsSearchSummary(){
            if($("#omicsSearchSummary").hasClass("visible")) {
                $("#omicsSearchSummary").removeClass("visible")
                $("#omicsSearchSummary").addClass("invisible")
            }
        }

        function makeVisibleOmicsSearchSummary(){
            if($("#omicsSearchSummary").hasClass("invisible")) {
                $("#omicsSearchSummary").removeClass("invisible")
                $("#omicsSearchSummary").addClass("visible")
            }
        }

        function generateOmicsJoinFieldAndDataView(){
            return "<p id='omicsdataView'> <input id='dataViewIdTypeahead' class='typeahead typeahead-large typeahead-full-width invisible' type='text' placeholder='Data view Id' value=''> <input id='dataViewId' name='dataViewId' type='hidden' value=''></p>"
        }

        function getFilterRadio(index, label, checkByDefault){
            var checked = checkByDefault ? "checked" : ""
            return "<div class='form-check'> " +
                        "<input class='form-check-input' type='radio' name='filterRadio' value='" + index + "' " + checked + "/>" +
                        "<label class='form-check-label'><span class='omics-pd-left'>" + reduceLongString(label) + "</span></label>" +
                    "</div>"
        }

        function reduceLongString(str){
            return str.length > 120 ? str.substring(0, 120) + "..." : str
        }

        function renderFilters(){
            var filters = getFilterElements()
            var filtersRadioStr = ""
            for (var index = 0; index < filters.length; index++){
                filtersRadioStr += getFilterRadio(index, filters[index].innerText, index === 0)
            }
            $("#currentDataSetFilters").html(filtersRadioStr)
        }

        function refreshFilters(){
            if(!$("#omicsCurrentDataSet").is(":empty") && !$("#omicsCurrentDataSetJoinField").is(":empty")){
                renderFilters()
            }
        }

        function showSearchSummary(chosenDataSetJoinField){
            makeVisibleOmicsSearchSummary()
            var chosenDataSetId = $("#dataSetId").val()
            var currentDataSetId = '@dataSetSetting.dataSetId'
            var currentDataSetJoinField = '@dataSetSetting.dataSetInfo.get.dataSetJoinIdName'

            $("#omicsCurrentDataSet").html("<span>Data set:</span><span class='text-info omics-pd-left'><b>" + currentDataSetId + "</b></span>")
            $("#omicsCurrentDataSetJoinField").html("<span>Join field:</span><span class='text-info omics-pd-left'><b>" + currentDataSetJoinField + "</b></span>")

            renderFilters()

            $("#omicsChosenDataSet").html("<span>Data set:</span><span class='text-info omics-pd-left'><b>" + chosenDataSetId + "</b></span>")
            $("#omicsChosenDataSetJoinField").html("<span>Join field:</span><span class='text-info omics-pd-left'><b>" + chosenDataSetJoinField + "</b></span><input type='hidden' id='omicsJoinFieldId' value='" + chosenDataSetJoinField + "'>")

        }

        function getDataSetInfo(dataSetIdToSearch) {
            if(dataSetIdToSearch){
                getDataSetInfoJsRoute.org.ada.web.controllers.dataset.omics.OmicsDataSetController.getDataSetInfo(dataSetIdToSearch).ajax({
                    success: function (res) {
                        showSearchSummary(res["dataSetJoinIdName"])
                    },
                    error: function (err){
                        showErrorResponse(err)
                    }
                });
            }

        }

        function populateFields({typeaheadElement, fieldNameElement, url, showOption, postFunction, initSelectByNameElement, minLength, dataSetIdToSearch}) {
            $.ajax({
                url: url,
                success: function (fieldNameAndLabels) {
                    if(typeaheadElement.hasClass("invisible"))
                        typeaheadElement.removeClass("invisible")

                    populateFieldTypeahead({
                        typeaheadElement,
                        fieldNameElement,
                        fieldNameAndLabels,
                        showOption,
                        initSelectByNameElement,
                        minLength
                    });
                    if (postFunction) {
                        postFunction()
                    }

                    getDataSetInfo(dataSetIdToSearch)

                },
                error: function(err){
                    showErrorResponse(err)
                }
            });
        }


        $('#dataSetIdTypeahead').blur(function (){
            if($(this).val()){
                removeHideOmicsInfos()
                $("#omicsDataSetId").after(generateOmicsJoinFieldAndDataView())
                var chosenDataSetId = $("#dataSetId").val()
                var urlDataViews = dataViewsJsRoute.org.ada.web.controllers.dataset.omics.OmicsDataSetController.getDataviews(chosenDataSetId).url

                populateFields({
                    typeaheadElement: $('#dataViewIdTypeahead'),
                    fieldNameElement: $('#dataViewId'),
                    url: urlDataViews,
                    showOption: @FilterShowFieldStyle.LabelsOnly.id,
                    dataSetIdToSearch: chosenDataSetId
                });
            } else{
                removeHideOmicsInfos()
            }
        })


        function checkSelection(dataSetIdToSearch, dataViewIdToSearch, selectedFilters) {
            removeErrorSelection()
            var errStr = ""
            if (dataSetIdToSearch && (dataSetIdToSearch === "invisible" || !dataSetIdToSearch.trim()))
                errStr += "<h4 class='text-danger'>Please select Data set Id</h4>"
            if ($("#omicsdataView").length && !dataViewIdToSearch.trim())
                errStr += "<h4 class='text-danger'>Please select Data view Id</h4>"
            if (selectedFilters && selectedFilters.length === 0)
                errStr += "<h4 class='text-danger'>Please select a filter before submitting an Omics search</h4>"

            return errStr
        }

        function showErrorSelection(errStr){
            var errorMsg = "<span id = 'omicsErrorSelection'>" + errStr + "</span>"
            $("#omicsDataSetId").before(errorMsg)
        }

        function removeErrorSelection(){
            if($("#omicsErrorSelection").length)
                $("#omicsErrorSelection").remove()
        }

        function searchInOmicsDataSet() {
            var dataSetIdToSearch = $("#dataSetId").val()
            var dataViewIdToSearch = $("#dataViewId").val()
            var filterOrIds = getFiltersOrIds()
            var indexFilterStr = $("input[name='filterRadio']:checked").val();
            var indexFilter = parseInt(indexFilterStr)
            var selectedFilters = filterOrIds[indexFilter]

            var errStr = checkSelection(dataSetIdToSearch, dataViewIdToSearch, selectedFilters)
            if (errStr) {
                showErrorSelection(errStr)
            } else {
                var currentDataSetId = '@dataSetSetting.dataSetId'
                var joinFieldId = $("#omicsJoinFieldId").val()

                searchInOmicsJsRoute.org.ada.web.controllers.dataset.omics.OmicsDataSetController.searchInOmics(currentDataSetId, JSON.stringify(selectedFilters), dataSetIdToSearch, joinFieldId).ajax({
                    success: function (res) {
                        var omicsFilterTmpId = res["omicsFilterTmpId"]
                        window.location.href = getViewJsRoute.org.ada.web.controllers.dataset.DataSetDispatcher.getView(dataViewIdToSearch, null, null, false, omicsFilterTmpId).url + "&dataSet=" + dataSetIdToSearch;
                    },
                    error: function (error) {
                        document.getElementsByTagName("html")[0].innerHTML = error
                    }
                })

            }
        }



</script>